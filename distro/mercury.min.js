
/*!
Mercury Editor is a Coffeescript and jQuery based WYSIWYG editor released under the MIT License.
Documentation and other useful information can be found at https://github.com/jejacks0n/mercury

Copyright (c) 2013 Jeremy Jackson
*/


(function() {

  this.Mercury || (this.Mercury = {});

  Mercury.configuration = {
    logging: {
      enabled: false,
      notifier: 'console'
    },
    localization: {
      enabled: false,
      preferred: 'swedish_chef-BORK'
    },
    uploading: {
      enabled: true,
      saveUrl: '/mercury/uploads',
      saveName: 'file',
      mimeTypes: ['image/jpeg', 'image/gif', 'image/png'],
      maxSize: 5242880
    },
    saving: {
      enabled: true,
      url: '/mercury/save',
      method: 'POST',
      contentType: 'application/json'
    },
    templates: {
      enabled: true,
      prefixUrl: '/mercury/templates'
    },
    "interface": {
      enabled: true,
      "class": 'FrameInterface',
      toolbar: 'Toolbar',
      statusbar: 'Statusbar',
      uploader: 'Uploader',
      silent: false,
      shadowed: false,
      maskable: false,
      style: false,
      floating: false,
      floatWidth: false,
      floatDrag: true,
      nohijack: ['mercury-ignored']
    },
    toolbars: {
      primary: {
        save: [
          'Save', {
            title: 'Save this page',
            event: 'save',
            global: true
          }
        ],
        preview: [
          'Preview', {
            title: 'Preview this page',
            mode: 'preview',
            global: true
          }
        ],
        sep1: ' ',
        undo: [
          'Undo', {
            title: 'Undo your last action'
          }
        ],
        redo: [
          'Redo', {
            title: 'Redo your last action'
          }
        ],
        sep2: '-',
        link: [
          'Link', {
            title: 'Insert Link',
            plugin: 'link'
          }
        ],
        file: [
          'Media', {
            title: 'Insert Media and Files (images, videos, etc.)',
            plugin: 'media'
          }
        ],
        table: [
          'Table', {
            title: 'Insert Table',
            plugin: 'table'
          }
        ],
        character: [
          'Character', {
            title: 'Special Characters',
            plugin: 'character'
          }
        ],
        snippets: [
          'Snippets', {
            title: 'Snippet Panel',
            plugin: 'snippets'
          }
        ],
        sep3: ' ',
        history: [
          'History', {
            title: 'Page Version History',
            plugin: 'history'
          }
        ],
        notes: [
          'Notes', {
            title: 'Page Notes',
            plugin: 'notes'
          }
        ]
      }
    },
    regions: {
      attribute: 'data-mercury',
      options: 'data-region-options',
      identifier: 'id',
      gallery: {
        mimeTypes: ['image/jpeg']
      },
      html: {
        mimeTypes: false
      },
      image: {
        mimeTypes: ['image/jpeg']
      },
      markdown: {
        autoSize: true,
        mimeTypes: false,
        wrapping: true,
        sanitize: false,
        breaks: true
      },
      plain: {
        allowActs: true,
        pasting: true,
        newlines: false
      },
      text: {
        autoSize: true,
        wrapping: true
      }
    }
  };

}).call(this);
(function(){this.JST||(this.JST={}),this.Mercury||(this.Mercury={})}).call(this),function(){JST["/mercury/templates/lightview"]=function(){return'<div class="mercury-lightview-overlay"></div>\n<div class="mercury-lightview-dialog">\n  <div class="mercury-lightview-dialog-positioner">\n    <div class="mercury-lightview-dialog-title"><em>&times;</em><span></span></div>\n    <div class="mercury-lightview-loading-indicator"></div>\n    <div class="mercury-lightview-dialog-content-container">\n      <div class="mercury-lightview-dialog-content">\n      </div>\n    </div>\n  </div>\n</div>'}}.call(this),function(){JST["/mercury/templates/modal"]=function(){return'<div class="mercury-modal-overlay"></div>\n<div class="mercury-modal-dialog">\n  <div class="mercury-modal-dialog-positioner">\n    <div class="mercury-modal-dialog-title"><em>&times;</em><span></span></div>\n    <div class="mercury-modal-loading-indicator"></div>\n    <div class="mercury-modal-dialog-content-container">\n      <div class="mercury-modal-dialog-content">\n      </div>\n    </div>\n  </div>\n</div>'}}.call(this),function(){JST["/mercury/templates/panel"]=function(){return'<div class="mercury-panel-title"><em>&times;</em><span>Test Panel</span></div>\n<div class="mercury-panel-loading-indicator"></div>\n  <div class="mercury-panel-content-container">\n    <div class="mercury-panel-content">\n      content\n    </div>\n  </div>\n</div>'}}.call(this),function(){JST["/mercury/templates/statusbar"]=function(){return'<div class="mercury-statusbar-about">\n  <a href="https://github.com/jejacks0n/mercury" target="_blank">Mercury Editor v'+Mercury.version+'</a>\n</div>\n<div class="mercury-statusbar-path"></div>'}}.call(this),function(){JST["/mercury/templates/uploader"]=function(){return'<div class="mercury-uploader-dialog">\n  <div class="mercury-uploader-preview"><b><img/></b></div>\n  <div class="mercury-uploader-details"></div>\n  <div class="mercury-uploader-progress">\n    <span></span>\n    <div class="mercury-uploader-indicator"><div><b>0%</b></div></div>\n  </div>\n</div>'}}.call(this),function(){Number.prototype.toHex=function(){var e;return e=this.toString(16).toUpperCase(),e[1]?e:"0"+e},Number.prototype.toBytes=function(){var e,t,n;n=[""," kb"," Mb"," Gb"," Tb"," Pb"," Eb"],e=parseInt(this),t=0;while(1023<e)e/=1024,t+=1;return t?""+e.toFixed(2)+n[t]:""+e+" bytes"}}.call(this),function(){var e={}.hasOwnProperty;Object.toParams=function(t){var n,r;return n=[],(r=function(t,i){var s,o,u,a,f;f=[];for(u in t){if(!e.call(t,u))continue;a=t[u],a instanceof Array?f.push(function(){var e,t,n;n=[];for(o=e=0,t=a.length;e<t;o=++e)s=a[o],n.push(r(s,i!=null?""+i+"["+u+"][]":""+u+"[]"));return n}()):a instanceof Object?f.push(r(a,i!=null?i+="["+u+"]":i=u)):f.push(n.push(i!=null?""+i+"["+u+"]="+a:""+u+"="+a))}return f})(t,null),n.join("&")}}.call(this),function(){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.toCamelCase=function(e){return e==null&&(e=!1),e?this.toTitleCase().replace(/([\-|_][a-z])/g,function(e){return e.toUpperCase().replace(/[\-|_]/,"")}):this.replace(/([\-|_][a-z])/g,function(e){return e.toUpperCase().replace(/[\-|_]/,"")})},String.prototype.toDash=function(){return this.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()}).replace(/^-+|-+$/g,"")},String.prototype.toUnderscore=function(){return this.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()}).replace(/^_+|_+$/g,"")},String.prototype.toTitleCase=function(){return this[0].toUpperCase()+this.slice(1)},String.prototype.toHex=function(){return this[0]==="#"?this.toString():this.replace(/rgb(a)?\(([0-9|%]+)[\s|,]?\s?([0-9|%]+)[\s|,]?\s?([0-9|%]+)[\s|,]?\s?([0-9|.|%]+\s?)?\)/gi,function(e,t,n,r,i,s){return"#"+parseInt(n).toHex()+parseInt(r).toHex()+parseInt(i).toHex()})},String.prototype.regExpEscape=function(){var e,t;return t=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],e=new RegExp("(\\"+t.join("|\\")+")","g"),this.replace(e,"\\$1")},String.prototype.printf=function(){var e,t,n,r,i,s,o,u,a,f;n=this.split("%"),u=n[0],o=/^([sdf])([\s\S%]*)$/,i=0;for(r=a=0,f=n.length;a<f;r=++a){t=n[r],s=o.exec(t);if(r===0||!s||arguments[r]===null){r>1&&(i+=2,u+="%"+t);continue}e=arguments[r-1-i];switch(s[1]){case"s":u+=e;break;case"d":case"i":u+=parseInt(e.toString(),10);break;case"f":u+=parseFloat(e)}u+=s[2]}return u}}.call(this),function(){Mercury.TableEditor=function(){function e(e,t){this.table=e,this.cellContent=t!=null?t:"",this.table&&this.load(this.table)}return e.prototype.load=function(e,t){return this.table=e,t&&(this.cellContent=t),this.setCell(),this.row=this.cell.parent("tr"),this.columnCount=this.getColumnCount(),this.rowCount=this.getRowCount()},e.prototype.setCell=function(e){return this.cell=e!=null?e:null,this.table.find(".selected").removeAttr("class"),this.cell&&(this.cell=this.cell.closest("td, th")),this.cell||(this.cell=this.table.find("th, td").first()),this.cell.addClass("selected")},e.prototype.asHtml=function(e){var t;return e==null&&(e=""),t=this.table.clone(),t.find(".selected").removeAttr("class"),t.find("td, th").html(e),$("<div>").html(t).html().replace(/^\s+|\n/gm,"").replace(/(<\/.*?>|<table.*?>|<tbody>|<tr>)/g,"$1\n")},e.prototype.addColumnBefore=function(){return this.addColumn("before")},e.prototype.addColumnAfter=function(){return this.addColumn("after")},e.prototype.addColumn=function(e){var t,n,r,i,s,o,u,a,f,l,c;e==null&&(e="after"),u=this.cellSignatureFor(this.cell),l=this.table.find("tr"),c=[];for(t=a=0,f=l.length;a<f;t=++a)o=l[t],r=e==="after"?{right:u.right}:{left:u.left},(i=this.findCellByOptionsFor(o,r))?(s=$("<"+i.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(s,i.height),e==="before"?i.cell.before(s):i.cell.after(s),c.push(t+=i.height-1)):(n=this.findCellByIntersectionFor(o,u))?c.push(this.setColspanFor(n.cell,n.width+1)):c.push(void 0);return c},e.prototype.removeColumn=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;u=this.cellSignatureFor(this.cell);if(u.width>1)return;s=[],e=[],d=this.table.find("tr");for(n=a=0,c=d.length;a<c;n=++a)o=d[n],(i=this.findCellByOptionsFor(o,{left:u.left,width:u.width}))?(s.push(i.cell),n+=i.height-1):(r=this.findCellByIntersectionFor(o,u))&&e.push(r.cell);for(f=0,h=s.length;f<h;f++)t=s[f],$(t).remove();v=[];for(l=0,p=e.length;l<p;l++)t=e[l],v.push(this.setColspanFor(t,this.colspanFor(t)-1));return v},e.prototype.addRowBefore=function(){return this.addRow("before")},e.prototype.addRowAfter=function(){return this.addRow("after")},e.prototype.addRow=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;e==null&&(e="after"),s=$("<tr>"),(a=this.rowspanFor(this.cell))>1&&e==="after"&&(this.row=$(this.row.nextAll("tr")[a-2])),n=0,v=this.row.find("th, td");for(f=0,h=v.length;f<h;f++){t=v[f],r=this.colspanFor(t),i=$("<"+t.tagName+">").html(this.cellContent),this.setColspanFor(i,r),n+=r;if((a=this.rowspanFor(t))>1&&e==="after"){this.setRowspanFor(t,a+1);continue}s.append(i)}if(n<this.columnCount){u=0,m=this.row.prevAll("tr");for(l=0,p=m.length;l<p;l++){o=m[l],u+=1,g=$(o).find("td[rowspan], th[rowspan]");for(c=0,d=g.length;c<d;c++)t=g[c],a=this.rowspanFor(t),a-1>=u&&e==="before"?this.setRowspanFor(t,a+1):a-1>=u&&e==="after"&&(a-1===u?(i=$("<"+t.tagName+">").html(this.cellContent),this.setColspanFor(i,this.colspanFor(t)),s.append(i)):this.setRowspanFor(t,a+1))}}return e==="before"?this.row.before(s):this.row.after(s)},e.prototype.removeRow=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;a=!0,s=0,i=0,b=this.row.find("td, th");for(l=0,d=b.length;l<d;l++){t=b[l],u=this.rowspanFor(t),s&&u!==s&&(a=!1);if(u<i||!i)i=u;s=u}if(!a&&this.rowspanFor(this.cell)>i)return;if(i>1)for(n=c=0,w=i-2;0<=w?c<=w:c>=w;n=0<=w?++c:--c)$(this.row.nextAll("tr")[n]).remove();E=this.row.find("td[rowspan], th[rowspan]");for(h=0,v=E.length;h<v;h++){t=E[h],f=this.cellSignatureFor(t);if(f.height===i)continue;if(r=this.findCellByOptionsFor(this.row.nextAll("tr")[i-1],{left:f.left,forceAdjacent:!0}))this.setRowspanFor(t,this.rowspanFor(t)-this.rowspanFor(this.cell)),r.direction==="before"?r.cell.before($(t).clone()):r.cell.after($(t).clone())}if(this.columnsFor(this.row.find("td, th"))<this.columnCount){o=0,S=this.row.prevAll("tr");for(p=0,m=S.length;p<m;p++){e=S[p],o+=1,x=$(e).find("td[rowspan], th[rowspan]");for(y=0,g=x.length;y<g;y++)t=x[y],u=this.rowspanFor(t),u>o&&this.setRowspanFor(t,u-this.rowspanFor(this.cell))}}return this.row.remove()},e.prototype.increaseColspan=function(){var e;e=this.cell.next("td, th");if(!e.length)return;if(this.rowspanFor(e)!==this.rowspanFor(this.cell))return;if(this.cellIndexFor(e)>this.cellIndexFor(this.cell)+this.colspanFor(this.cell))return;return this.setColspanFor(this.cell,this.colspanFor(this.cell)+this.colspanFor(e)),e.remove()},e.prototype.decreaseColspan=function(){var e;if(this.colspanFor(this.cell)===1)return;return this.setColspanFor(this.cell,this.colspanFor(this.cell)-1),e=$("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(e,this.rowspanFor(this.cell)),this.cell.after(e)},e.prototype.increaseRowspan=function(){var e,t,n;n=this.cellSignatureFor(this.cell),t=this.row.nextAll("tr")[n.height-1];if(t&&(e=this.findCellByOptionsFor(t,{left:n.left,width:n.width})))return this.setRowspanFor(this.cell,n.height+e.height),e.cell.remove()},e.prototype.decreaseRowspan=function(){var e,t,n,r;r=this.cellSignatureFor(this.cell);if(r.height===1)return;n=this.row.nextAll("tr")[r.height-2];if(e=this.findCellByOptionsFor(n,{left:r.left,forceAdjacent:!0}))return t=$("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setColspanFor(t,this.colspanFor(this.cell)),this.setRowspanFor(this.cell,r.height-1),e.direction==="before"?e.cell.before(t):e.cell.after(t)},e.prototype.getColumnCount=function(){return this.columnsFor(this.table.find("thead tr:first-child, tbody tr:first-child, tfoot tr:first-child").first().find("td, th"))},e.prototype.getRowCount=function(){return this.table.find("tr").length},e.prototype.cellIndexFor=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;e=$(e),s=e.parent("tr"),r=this.columnsFor(s.find("td, th")),i=this.columnsFor(e.prevAll("td, th"));if(r<this.columnCount){o=0,c=s.prevAll("tr");for(u=0,f=c.length;u<f;u++){n=c[u],o+=1,h=$(n).find("td[rowspan], th[rowspan]");for(a=0,l=h.length;a<l;a++)t=h[a],this.rowspanFor(t)>o&&this.cellIndexFor(t)<=i&&(i+=this.colspanFor(t))}}return i},e.prototype.cellSignatureFor=function(e){var t;return t={cell:$(e)},t.left=this.cellIndexFor(e),t.width=this.colspanFor(e),t.height=this.rowspanFor(e),t.right=t.left+t.width,t},e.prototype.findCellByOptionsFor=function(e,t){var n,r,i,s,o,u;u=$(e).find("td, th");for(s=0,o=u.length;s<o;s++){n=u[s],i=this.cellSignatureFor(n);if(typeof t.right!="undefined"&&i.right===t.right)return i;if(typeof t.left!="undefined")if(t.width){if(i.left===t.left&&i.width===t.width)return i}else if(!t.forceAdjacent){if(i.left===t.left)return i}else if(t.forceAdjacent&&i.left>t.left)return r=$(n).prev("td, th"),r.length?(i=this.cellSignatureFor(r),i.direction="after"):i.direction="before",i}return t.forceAdjacent?(i.direction="after",i):null},e.prototype.findCellByIntersectionFor=function(e,t){var n,r,i,s,o;o=$(e).find("td, th");for(i=0,s=o.length;i<s;i++){n=o[i],r=this.cellSignatureFor(n);if(r.right-t.left>=0&&r.right>t.left)return r}return null},e.prototype.columnsFor=function(e){var t,n,r,i;n=0;for(r=0,i=e.length;r<i;r++)t=e[r],n+=this.colspanFor(t);return n},e.prototype.colspanFor=function(e){return parseInt($(e).attr("colspan"),10)||1},e.prototype.rowspanFor=function(e){return parseInt($(e).attr("rowspan"),10)||1},e.prototype.setColspanFor=function(e,t){return $(e).attr("colspan",t>1?t:null)},e.prototype.setRowspanFor=function(e,t){return $(e).attr("rowspan",t>1?t:null)},e}()}.call(this),function(){var e=[].slice;(this.Mercury||(this.Mercury={})).I18n={__locales__:{},define:function(e,t){return this.__locales__[e]=t},locale:function(){var e,t,n,r;return this.__determined__?this.__determined__:((n=Mercury.configuration.localization)!=null?!n.enabled:!void 0)?[{},{}]:(r=this.detectLocale(),t=r[0],e=r[1],t=this.__locales__[t],e=t&&e?t["_"+e.toUpperCase()+"_"]:!1,this.__determined__=[t||{},e||{}])},detectLocale:function(){var e,t,n;return this.__detected__?this.__detected__:(e=(this.clientLocale()||((t=Mercury.configuration.localization)!=null?t.preferred:void 0)).split("-"),this.__locales__[e[0]]||(e=(((n=Mercury.configuration.localization)!=null?n.preferred:void 0)||"en-US").split("-")),this.__detected__=e)},t:function(){var t,n,r,i,s,o;return n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],o=Mercury.I18n.locale(),i=o[0],r=o[1],s=(r[n]||i[n]||n||"").toString(),t.length?s.printf.apply(s,t):s},clientLocale:function(){var e;return(e=navigator.language)!=null?e.toString():void 0}},Mercury.I18n.Module={t:Mercury.I18n.t}}.call(this),function(){var e=[].slice;(this.Mercury||(this.Mercury={})).Logger={logPrefix:"Mercury:",log:function(){var t,n;t=1<=arguments.length?e.call(arguments,0):[];if((n=Mercury.configuration.logging)!=null?!n.enabled:!void 0)return;return(this.logPrefix||this.constructor.logPrefix)&&t.unshift(this.logPrefix||this.constructor.logPrefix),typeof console!="undefined"&&console!==null?typeof console.debug=="function"?console.debug.apply(console,t):void 0:void 0},notify:function(e){var t,n;if(this.logPrefix||this.constructor.logPrefix)e=""+(this.constructor.logPrefix||this.logPrefix)+" "+e;if(((t=Mercury.configuration.logging)!=null?t.notifier:void 0)==="console")try{return console.error(e)}catch(r){}else if(((n=Mercury.configuration.logging)!=null?n.notifier:void 0)==="alert")return alert(e);throw new Error(e)}}}.call(this),function(){Mercury.Module=function(){function t(){this.__handlers__=$.extend(!0,{},this.__handlers__),typeof this.init=="function"&&this.init.apply(this,arguments),typeof this.trigger=="function"&&this.trigger("init")}var e;return e=["included","extended","private"],t.extend=function(t){var n,r,i,s;if(!t)throw new Error("extend expects an object");r=t.Module||t;for(i in r){n=r[i];if(e.indexOf(i)>-1)continue;this[i]=n}return(s=r.extended)!=null?s.apply(this):void 0},t.include=function(t){var n,r,i,s;if(!t)throw new Error("include expects an object");r=t.Module||t;for(i in r){n=r[i];if(e.indexOf(i)>-1)continue;this.prototype[i]=n}return(s=r.included)!=null?s.apply(this.prototype):void 0},t.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t.prototype.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},t}()}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;Mercury.Action=function(e){function r(){var e;e=1<=arguments.length?n.call(arguments,0):[],this.name||(this.name=e.shift()),this.attributes=e.pop()||{},r.__super__.constructor.apply(this,arguments)}return t(r,e),r.include(Mercury.I18n),r.include(Mercury.Logger),r.logPrefix="Mercury.Action:",r.create=function(e,t){var n;return t==null&&(t={}),$.isPlainObject(t)?(n=e.toCamelCase(!0),Mercury.Action[n]?new Mercury.Action[n](t):new Mercury.Action(e,t)):t},r.prototype.get=function(e){return this.attributes[e]},r}(Mercury.Module)}.call(this),function(){var e=[].slice;(this.Mercury||(this.Mercury={})).Config={get:function(e){var t,n,r,i,s;t=Mercury.configuration||(Mercury.configuration={});try{if(e){s=e.split(":");for(r=0,i=s.length;r<i;r++)n=s[r],t=t[n]}}catch(o){return}return t},set:function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],o=t.shift(),u=t.pop(),r=t.pop();if(typeof o=="object")return Mercury.configuration=o;n=Mercury.configuration||(Mercury.configuration={}),s=o.split(":"),i=s.shift();while(i){if(s.length===0)return r&&typeof n[i]=="object"?n[i]=$.extend(!0,n[i],u):n[i]=u,n[i];n=n[i]?n[i]:n[i]={},i=s.shift()}}},Mercury.Config.Module={config:Mercury.Config.get}}.call(this),function(){var e=[].slice;(this.Mercury||(this.Mercury={})).Events={on:function(e,t){var n,r,i,s;e=e.split(" "),n=this.__handlers__||(this.__handlers__={});for(i=0,s=e.length;i<s;i++)r=e[i],n[r]||(n[r]=[]),n[r].push(t);return this},one:function(e,t){var n;return n=function(){return this.off(e,n),t.apply(this,arguments)},this.on(e,n)},off:function(e,t){var n,r,i,s,o,u,a,f,l,c;if(!e)return this.__handlers__={},this;l=e.split(" ");for(o=0,a=l.length;o<a;o++){s=l[o];if(!(i=(c=this.__handlers__)!=null?c[s]:void 0))continue;if(!t){delete this.__handlers__[s];continue}for(r=u=0,f=i.length;u<f;r=++u){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this.__handlers__[s]=i;break}}return this},trigger:function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],n=t.shift(),typeof this.log=="function"&&this.log(n,t);if(!(i=(u=this.__handlers__)!=null?u[n]:void 0))return!1;for(s=0,o=i.length;s<o;s++){r=i[s];if(r.apply(this,t)===!1)break}return!0}}}.call(this),function(){(this.Mercury||(this.Mercury={})).Stack={included:function(){return this.stackPosition=0,this.maxStackLength=200,this.stack=[]},pushStack:function(e){if(e===null||this.stackEquality(e))return;return this.stack=this.stack.slice(0,this.stackPosition+1),this.stack.push(e),this.stack.length>this.maxStackLength&&this.stack.shift(),this.stackPosition=this.stack.length-1},stackEquality:function(e){return JSON.stringify(this.stack[this.stackPosition])===JSON.stringify(e)},undoStack:function(){return this.stackPosition<1?null:(this.stackPosition-=1,this.stack[this.stackPosition])},redoStack:function(){return this.stackPosition>=this.stack.length-1?null:(this.stackPosition+=1,this.stack[this.stackPosition])},clearStack:function(){return this.stackPosition=0,this.stack=[]}}}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Model=function(e){function n(e){var t;e==null&&(e={}),this.attributes={},this.errors={},this.set(e),this.cid||(this.cid=this.constructor.uid("c")),(t=this.constructor).records||(t.records={}),this.constructor.records[this.cid]=this,n.__super__.constructor.apply(this,arguments)}return t(n,e),n.extend(Mercury.Config),n.extend(Mercury.Events),n.include(Mercury.Config),n.include(Mercury.Events),n.include(Mercury.I18n),n.include(Mercury.Logger),n.include(Mercury.Stack),n.logPrefix="Mercury.Model:",n.idCounter=1,n.define=function(e,t){return this.className=e,this.urlPrefix=t,this.logPrefix=this.prototype.logPrefix=""+this.className+":",this.records={},this.off(),this},n.url=function(e){return this.urlPrefix},n.find=function(e){var t;t=this.records[e];if(!t&&(""+e).match(/^\d+/))return this.find("c"+e);if(!t)throw new Error(""+this.className+" found no records with the ID '"+e+"'");return t},n.all=function(){var e,t,n,r;n=this.records,r=[];for(e in n)t=n[e],r.push(t);return r},n.count=function(){return this.all().length},n.toJSON=function(){return this.all()},n.contains=function(e){try{return this.find(e)}catch(t){return!1}},n.uid=function(e){var t;return e==null&&(e=""),t=e+this.idCounter++,this.contains(t)&&(t=this.uid(e)),t},n.prototype.url=function(){return this.constructor.url(this)},n.prototype.validate=function(){},n.prototype.save=function(e){var t,n=this;return e==null&&(e={}),this.isValid()?(t={method:this.isNew()?"POST":"PUT",url:this.url(),dataType:"json",contentType:"application/json; charset=utf-8",cache:!1,data:this.toJSON(),success:function(e){return typeof e=="object"&&(n.id=e.id,n.id&&(n.constructor.records[n.id]=n),n.set(e),n.trigger("save",e)),typeof n.saveSuccess=="function"?n.saveSuccess(e):void 0},error:function(t){return n.trigger("error",t,e),n.notify(n.t("Unable to process response: %s",t.status)),typeof n.saveError=="function"?n.saveError.apply(n,arguments):void 0}},e=$.extend(t,e),e.dataType&&typeof e.data!="string"&&(e.data=JSON.stringify(e.data)),$.ajax(e)):!1},n.prototype.toJSON=function(){return $.extend(!0,{},this.attributes)},n.prototype.isNew=function(){return!this.exists()},n.prototype.isValid=function(){var e,t,n;this.errors={},this.validate(),n=this.errors;for(e in n)return t=n[e],!1;return!0},n.prototype.addError=function(e,t){var n;return((n=this.errors)[e]||(n[e]=[])).push(t)},n.prototype.errorMessages=function(){var e,t,n,r;if(this.isValid())return!1;t=[],r=this.errors;for(e in r)n=r[e],t.push(""+n.join(", "));return t.join("\n")},n.prototype.get=function(e){return this.attributes[e]},n.prototype.set=function(e,t){var n,r;n={},typeof e=="object"?n=e:n[e]=t,this.pushStack(this.toJSON()),r=[];for(e in n)t=n[e],r.push(this.attributes[e]=t);return r},n.prototype.exists=function(){return this.id&&this.id in this.constructor.records},n}(Mercury.Module)}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},r=[].slice;e={},Mercury.Plugin=function(t){function i(e){var t,n,r;this.options=e!=null?e:{},this.configuration=this.options.config||{},r=this.options;for(t in r)n=r[t],t!=="config"&&(this[t]=n);if(!this.name)throw new Error("must provide a name for plugins");this.actionsArray=[],this.actions||(this.actions={}),this.events=$.extend({},this.constructor.events,this.events),this.delegateEvents(this.events),this.appendActions(this.actions),i.__super__.constructor.apply(this,arguments)}return n(i,t),i.include(Mercury.Config),i.include(Mercury.Events),i.include(Mercury.I18n),i.include(Mercury.Logger),i.logPrefix="Mercury.Plugin:",i.events={"mercury:region:focus":"onRegionFocus"},i.register=function(e,t){return t.name=e,new Mercury.Plugin.Definition(t)},i.get=function(t,n){var r;n==null&&(n=!1),r=e[t];if(!r)throw new Error("unable to locate the "+t+" plugin");return n?new Mercury.Plugin(r.signature()):r},i.all=function(){return e},i.unregister=function(t){var n;n=e[t];if(!n)throw new Error("unable to locate the "+t+" plugin");return delete e[t]},i.prototype.buttonRegistered=function(e){var t=this;return this.button=e,this.configuration=$.extend({},this.configuration,this.button.get("settings")),this.button.on("click",function(){return t.onButtonClick()}),this.prependButtonAction&&(this.context=this.button.get("actionName"),this.prependAction(this.context,this.prependButtonAction)),typeof this.registerButton=="function"?this.registerButton():void 0},i.prototype.regionSupported=function(e){var t,n,r,i;this.region=e,i=this.actionsArray;for(n=0,r=i.length;n<r;n++){t=i[n];if(this.region.hasAction(t[0]))return typeof this.regionContext=="function"&&this.regionContext(),!0}return!1},i.prototype.triggerAction=function(){var e,t,n,i,s;t=1<=arguments.length?r.call(arguments,0):[];if(!this.region)return!1;s=this.actionsArray;for(n=0,i=s.length;n<i;n++){e=s[n];if(this.region.hasAction(e[0]))return t.unshift(e[0]),Mercury.trigger("focus"),e[1].apply(this,t),!0}return!1},i.prototype.config=function(e){var t,n,r,i,s;t=this.configuration||(this.configuration={});try{s=e.split(":");for(r=0,i=s.length;r<i;r++)n=s[r],t=t[n]}catch(o){return Mercury.Config.get(e)}return typeof t=="undefined"?Mercury.Config.get(e):t},i.prototype.configure=function(){var e,t,n,i,s,o,u;e=1<=arguments.length?r.call(arguments,0):[],o=e.shift(),u=e.pop(),n=e.pop();if(typeof o=="object")return this.configuration=o;t=this.configuration||(this.configuration={}),s=o.split(":"),i=s.shift();while(i){if(s.length===0)return n&&typeof t[i]=="object"?t[i]=$.extend(!0,t[i],u):t[i]=u,t[i];t=t[i]?t[i]:t[i]={},i=s.shift()}},i.prototype.release=function(){var e,t,n;n=this.__global_handlers__||{};for(t in n)e=n[t],Mercury.off(t,e);return this.off()},i.prototype.onRegionFocus=function(e){this.region=e},i.prototype.onButtonClick=function(){},i.prototype.appendActions=function(e){var t,n,r;r=[];for(t in e){n=e[t];if(typeof n!="function"){if(!this[n])throw new Error(""+n+" doesn't exist");n=this[n]}r.push(this.actionsArray.push([t,n]))}return r},i.prototype.prependAction=function(e,t){if(typeof t!="function"){if(!this[t])throw new Error(""+t+" doesn't exist");t=this[t]}return this.actionsArray.unshift([e,t])},i.prototype.delegateEvents=function(e){var t,n,r,i=this;this.__global_handlers__||(this.__global_handlers__={}),r=[];for(t in e){n=e[t];if(typeof n=="function")n=function(e){return function(){return e.apply(i,arguments),!0}}(n);else{if(!this[n])throw new Error(""+n+" doesn't exist");n=function(e){return function(){return i[e].apply(i,arguments),!0}}(n)}if(t.indexOf("mercury:")===0){t=t.replace(/^mercury:/,""),this.__global_handlers__[t]=n,Mercury.on(t,n);continue}r.push(this.on(t,n))}return r},i}(Mercury.Module),Mercury.Plugin.Module={registerPlugin:Mercury.Plugin.register,getPlugin:Mercury.Plugin.get},Mercury.Plugin.Definition=function(){function t(t){this.options=t!=null?t:{},this.name=this.options.name;if(!this.name)throw new Error("must provide a name for plugins");this.configuration=this.options.config,this.description=this.options.description,this.version=this.options.version,e[this.name]=this}return t.prototype.signature=function(e){var t,n,r;e==null&&(e=!0),n=$.extend({},this.options,{config:this.configuration});if(!e)for(t in n)r=n[t],typeof r=="function"&&delete n[t];return n},t.prototype.config=function(e){var t,n,r,i,s;t=this.configuration||(this.configuration={});try{s=e.split(":");for(r=0,i=s.length;r<i;r++)n=s[r],t=t[n]}catch(o){return Mercury.Config.get(e)}return typeof t=="undefined"?Mercury.Config.get(e):t},t.prototype.configure=function(){var e,t,n,i,s,o,u;e=1<=arguments.length?r.call(arguments,0):[],o=e.shift(),u=e.pop(),n=e.pop();if(typeof o=="object")return this.configuration=o;t=this.configuration||(this.configuration={}),s=o.split(":"),i=s.shift();while(i){if(s.length===0)return n&&typeof t[i]=="object"?t[i]=$.extend(!0,t[i],u):t[i]=u,t[i];t=t[i]?t[i]:t[i]={},i=s.shift()}},t}()}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;Mercury.View=function(e){function r(e){var t,n,i;this.options=e!=null?e:{},i=this.options;for(t in i)n=i[t],this[t]=n;this.buildElement(),this.elements=$.extend({},this.constructor.elements,this.elements),this.events=$.extend({},this.constructor.events,this.events),this.attributes=$.extend({},this.constructor.attributes,this.attributes),this.subviews||(this.subviews=[]),this.refreshElements(),typeof this.build=="function"&&this.build(),this.trigger("build"),this.delegateEvents(this.events),this.refreshElements(),r.__super__.constructor.apply(this,arguments)}return t(r,e),r.include(Mercury.Config),r.include(Mercury.Events),r.include(Mercury.I18n),r.include(Mercury.Logger),r.Modules={},r.logPrefix="Mercury.View:",r.tag="div",r.prototype.eventSplitter=/^(\S+)\s*(.*)$/,r.prototype.buildElement=function(){this.$el?this.el=this.$el.get(0):(this.el||(this.el=document.createElement(this.tag||this.constructor.tag)),this.$el=$(this.el)),this.attr(this.attributes),this.addClass(this.constructor.className),this.addClass(this.className);if(this.template||this.constructor.template)return this.html(this.renderTemplate(this.template||this.constructor.template))},r.prototype.$=function(e){return $(e,this.$el)},r.prototype.addClass=function(e){return this.$el.addClass(e)},r.prototype.removeClass=function(e){return this.$el.removeClass(e)},r.prototype.attr=function(e,t){return e&&arguments.length===1?this.$el.attr(e):this.$el.attr(e,t)},r.prototype.css=function(e,t){return e&&arguments.length===1?this.$el.css(e):this.$el.css(e,t)},r.prototype.html=function(e){return arguments.length?(this.$el.html((e!=null?e.$el:void 0)||(e!=null?e.el:void 0)||e),this.localize(this.$el),this.refreshElements(),this.$el):this.$el.html()},r.prototype.append=function(){var e,t,r;return t=1<=arguments.length?n.call(arguments,0):[],t=function(){var n,r,i;i=[];for(n=0,r=t.length;n<r;n++)e=t[n],i.push(e.$el||e.el||e);return i}(),(r=this.$el).append.apply(r,t),this.refreshElements(),this.$el},r.prototype.appendTo=function(e){return this.$el.appendTo(e.$el||e.el||e),this.$el},r.prototype.appendView=function(e,t){return t==null&&(t=null),arguments.length===1&&(t=e,e=this.$el),typeof e=="string"&&(e=this.$(e)),t.appendTo?typeof t.appendTo=="function"&&t.appendTo(e):e.append(t.$el||t.el),this.subviews.push(t),t},r.prototype.delay=function(e,t){var n=this;return setTimeout(function(){return t.call(n)},e)},r.prototype.refreshElements=function(){var e,t,n,r;n=this.elements,r=[];for(e in n)t=n[e],r.push(this["$"+e]=this.$(t));return r},r.prototype.renderTemplate=function(e,t){var n;return t==null&&(t=null),typeof e=="function"?n=e:(n=JST["/mercury/templates/"+e],this.config("templates:enabled")&&!n&&(n=this.fetchTemplate(e))),typeof n=="function"?n.call(t||this):n},r.prototype.fetchTemplate=function(e){var t;return t=null,$.ajax({url:[this.config("templates:prefixUrl"),e].join("/"),async:!1,success:function(e){return t=e}}),t},r.prototype.localize=function(e){var t,n,r,i,s,o,u,a;u=e.find("*").contents(),a=[];for(s=0,o=u.length;s<o;s++){n=u[s],t=n.attributes,typeof n.data=="string"&&(r=this.translationForContent(n.data))&&(n.data=r);switch(n.nodeName){case"IMG":(r=this.translationForAttr(t.src))?a.push($(n).attr("src",r)):a.push(void 0);break;case"A":(r=this.translationForAttr(t.href))?a.push($(n).attr("href",r)):a.push(void 0);break;case"INPUT":i=t.type.nodeValue.toLowerCase(),!t.value||i!=="button"&&i!=="reset"&&i!=="submit"?a.push(void 0):(r=this.translationForAttr(t.value))?a.push($(n).attr("value",r)):a.push(void 0)}}return a},r.prototype.translationForAttr=function(e){return!e||!e.nodeValue?!1:this.translationForContent(e.nodeValue)},r.prototype.translationForContent=function(e){var t,n;return t=$.trim(e),t?(n=this.t(t),n===t?!1:n):!1},r.prototype.focusFirstFocusable=function(){var e;return(e=this.$(':input:visible[tabindex != "-1"]')[0])!=null?e.focus():void 0},r.prototype.prevent=function(e,t){t==null&&(t=!1);if(!e||!e.preventDefault)return;e.preventDefault();if(t)return e.stopPropagation()},r.prototype.preventStop=function(e){return this.prevent(e,!0)},r.prototype.release=function(){var e,t,n;this.trigger("release"),this.releaseSubviews(),this.$el.remove(),n=this.__global_handlers__||{};for(t in n)e=n[t],Mercury.off(t,e);return this.off()},r.prototype.releaseSubviews=function(){var e,t,n,r;r=this.subviews||[];for(t=0,n=r.length;t<n;t++)e=r[t],e.release();return this.subviews=[]},r.prototype.delegateEvents=function(e,t){var n,r,i,s,o,u,a,f=this;arguments.length===1&&(t=e,e=this.$el),this.__global_handlers__||(this.__global_handlers__={}),a=[];for(r in t){s=t[r];if(typeof s=="function")s=function(e){return function(){return e.apply(f,arguments),!0}}(s);else if(s.indexOf("mercury:")===0)s=s.replace(/^mercury:/,""),s=function(e){return function(){return Mercury.trigger(e,f),!0}}(s);else{if(!this[s])throw new Error(""+s+" doesn't exist");s=function(e){return function(){return f[e].apply(f,arguments),!0}}(s)}if(r.indexOf("mercury:")===0){r=r.replace(/^mercury:/,""),this.__global_handlers__[r]=s,Mercury.on(r,s);continue}u=r.match(this.eventSplitter),i=u[0],n=u[1],o=u[2],a.push(e.on(n,o||null,s))}return a},r}(Mercury.Module)}.call(this),function(){Mercury.View.Modules.FormHandler={included:function(){return this.on("build",this.buildFormHandler)},buildFormHandler:function(){this.delegateEvents({submit:this.onFormSubmit});if(this.model)return this.on("update",this.applySerializedModel)},validate:function(){return this.clearInputErrors()},addInputError:function(e,t){return e.after('<span class="help-inline error-message">'+t+"</span>").closest(".control-group").addClass("error"),this.valid=!1},clearInputErrors:function(){return this.$(".control-group.error").removeClass("error").find(".error-message").remove(),this.valid=!0},applySerializedModel:function(){if(this.model)return this.$("form").applySerializedObject(this.model.toJSON())},serializeModel:function(){var e,t,n,r;this.clearInputErrors(),this.model.set(this.$("form").serializeObject());if(!this.model.isValid()){n=this.model.errors,r=[];for(e in n)t=n[e],r.push(this.addInputError(this.$("[name="+e+"]"),t.join(", ")));return r}this.trigger("form:success");if(this.hideOnValidSubmit)return this.hide()},onFormSubmit:function(e){this.prevent(e),this.validate(),this.model&&this.serializeModel();if(this.valid)return typeof this.onSubmit=="function"?this.onSubmit():void 0}},!function(e){e.serializeObject=function(t){var n={},r=n,i=t;return e.each(i,function(){var e=this.name.replace(/\[([^\]]+)?\]/g,",$1").split(","),t=e.length-1,i=0;for(;i<t;i++)r.push?((!r[r.length-1]||r[r.length-1].constructor!==
Object||r[r.length-1][e[i+1]]!==undefined)&&r.push({}),r=r[r.length-1]):r=r[e[i]]=r[e[i]]||(e[i+1]==""?[]:{});r.push?r.push(this.value):r[e[t]]=this.value,r=n}),n},e.deserializeObject=function n(e,t,r){var i,s,o,u;t=t||[];if(Object.prototype.toString.call(e)==="[object Object]")for(i in e){o=r?[r,"[",i,"]"].join(""):i;if(e.hasOwnProperty(i)){u=Object.prototype.toString.call(e[i]);if(u==="[object Array]")for(s=0,jsonLen=e[i].length;s<jsonLen;s++)n(e[i][s],t,o+"[]");else u==="[object Object]"?n(e[i],t,o):t.push({name:o,value:e[i]})}}else t.push({name:r,value:e});return t};var t=function(){var t=!!e.fn.prop;return function(e,n){t?e.prop("checked",n):e.attr("checked",n?"checked":null)}}();e.applySerializedArray=function(n,r){var i=e(n).find("input,select,textarea"),s;t(i.filter(":checked"),!1);for(var o=r.length;o--;)s=i.filter("[name='"+r[o].name+"']"),s.filter(":checkbox").length?s.val()==r[o].value&&t(s.filter(":checkbox"),!0):s.filter(":radio").length?t(s.filter("[value='"+r[o].value+"']"),!0):s.val(r[o].value)},e.applySerializedObject=function(t,n){e.applySerializedArray(t,e.deserializeObject(n))},e.fn.serializeObject=e.fn.serializeObject||function(){return e.serializeObject(this.serializeArray())},e.fn.applySerializedObject=function(t){return e.applySerializedObject(this,t),this},e.fn.applySerializedArray=function(t){return e.applySerializedArray(this,t),this}}(jQuery)}.call(this),function(){Mercury.View.Modules.InterfaceFocusable={included:function(){return this.on("build",this.buildInterfaceFocusable)},buildInterfaceFocusable:function(){if(!this.revertFocusOn)return;return this.delegateEvents({mousedown:"handleFocusableEvent",mouseup:"handleFocusableEvent",click:"handleFocusableEvent"}),this.delegateRevertedFocus(this.revertFocusOn)},delegateRevertedFocus:function(e){var t;return t={},t["mousedown "+e]="revertInterfaceFocus",t["click "+e]="revertInterfaceFocus",this.delegateEvents(t)},handleFocusableEvent:function(e){e.stopPropagation();if(!$(e.target).is(this.focusableSelector||":input, [tabindex]"))return this.prevent(e)},revertInterfaceFocus:function(){return this.delay(1,function(){return Mercury.trigger("focus")})},preventFocusout:function(e){var t,n=this;return t=$(this.createFocusableKeeper().appendTo(this.$el)[0]),this.on("release",function(){return n.clearFocusout(t,e)}),this.on("hide",function(){return n.clearFocusout(t,e)}),t.on("blur",function(){return n.keepFocusConstrained(t,e)}),e.off("focusout").on("focusout",function(){return n.keepFocusConstrained(t,e)}),e.on("keydown",function(t){var r,i,s;if(t.keyCode!==9)return;i=e.find(':input[tabindex != "-1"]');if(!i.length)return;r=i[0],s=i[i.length-1];if(t.shiftKey&&t.target===r||!t.shiftKey&&t.target===s)return n.prevent(t,!0)})},createFocusableKeeper:function(){return $('<input style="position:fixed;left:100%;top:20px" tabindex="-1"/><input style="position:fixed;left:100%;top:20px"/>')},keepFocusConstrained:function(e,t){var n=this;return this.preventFocusoutTimeout=this.delay(1,function(){if($.contains(t[0],document.activeElement))return;return e.focus()})},clearFocusout:function(e,t){return clearTimeout(this.preventFocusoutTimeout),e.off(),t.off("keydown").off("focusout")}}}.call(this),function(){Mercury.View.Modules.ScrollPropagation={preventScrollPropagation:function(e){return e.on("mousewheel DOMMouseScroll",function(t){var n,r,i;return i=[t.originalEvent.wheelDelta||-t.originalEvent.detail,e.scrollTop()],n=i[0],r=i[1],n>0&&r<=0?!1:n<0&&r>=e.get(0).scrollHeight-e.height()?!1:!0})}}}.call(this),function(){Mercury.View.Modules.VisibilityToggleable={included:function(){return this.on("build",this.buildVisibilityToggleable)},buildVisibilityToggleable:function(){return this.hidden?(this.visible=!0,this.hide()):this.show()},toggle:function(){return this.visible?this.hide():this.show()},show:function(e){e==null&&(e=!0);if(this.visible)return;return this.trigger("show"),clearTimeout(this.visibilityTimout),typeof this.onShow=="function"&&this.onShow(),this.visible=!0,this.$el.show(),typeof this.position=="function"&&this.position(),this.visibilityTimout=this.delay(50,function(){this.css({opacity:1});if(e&&typeof e=="boolean")return typeof this.update=="function"?this.update():void 0})},hide:function(e){if(!this.visible)return;return typeof e!="boolean"&&(e=null),e==null&&(e=this.releaseOnHide),this.trigger("hide"),clearTimeout(this.visibilityTimout),typeof this.onHide=="function"&&this.onHide(),this.visible=!1,this.css({opacity:0}),this.visibilityTimout=this.delay(250,function(){this.$el.hide();if(e)return this.release()})}}}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Modal=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.include(Mercury.View.Modules.FormHandler),n.include(Mercury.View.Modules.InterfaceFocusable),n.include(Mercury.View.Modules.ScrollPropagation),n.include(Mercury.View.Modules.VisibilityToggleable),n.logPrefix="Mercury.Modal:",n.className="mercury-dialog mercury-modal",n.elements={dialog:".mercury-modal-dialog-positioner",content:".mercury-modal-dialog-content",contentContainer:".mercury-modal-dialog-content-container",titleContainer:".mercury-modal-dialog-title",title:".mercury-modal-dialog-title span"},n.events={"mercury:interface:resize":"resize","mercury:modals:hide":"hide","click .mercury-modal-dialog-title em":"hide"},n.prototype.primaryTemplate="modal",n.prototype.releaseOnHide=!0,n.prototype.buildElement=function(){return this.hidden&&(this.releaseOnHide=!1),this.negotiateTemplate(),n.__super__.buildElement.apply(this,arguments)},n.prototype.build=function(){return this.appendTo(),this.preventScrollPropagation(this.$contentContainer),this.preventFocusout(this.$contentContainer,this.focusFirstFocusable)},n.prototype.negotiateTemplate=function(){var e;return(e=this.options).template||(e.template=this.template),this.subTemplate=this.options.template,this.template=this.primaryTemplate},n.prototype.update=function(e){if(!this.visible||!this.updateForOptions(e))return;return this.resize(),this.show(!1),this.refreshElements(),this.trigger("update"),this.delay(300,this.focusFirstFocusable)},n.prototype.updateForOptions=function(e){var t,n,r,i;this.options=$.extend({},this.options,e||{}),i=this.options;for(n in i)r=i[n],this[n]=r;return this.negotiateTemplate(),this.$title.html(this.t(this.title)),this.setWidth(this.width),t=this.contentFromOptions(),t===this.lastContent&&this.width===this.lastWidth?!1:(this.addClass("loading"),this.lastContent=t,this.lastWidth=this.width,this.$content.css({visibility:"hidden",opacity:0,width:this.width}).html(t),this.localize(this.$content),!0)},n.prototype.setWidth=function(e){return this.$dialog.css({width:e})},n.prototype.resize=function(e,t){var n,r,i;e==null&&(e=!0),t==null&&(t=null);if(!this.visible)return;return clearTimeout(this.showContentTimeout),typeof e=="object"&&(t=e,e=!1),e||this.addClass("mercury-no-animation"),this.$contentContainer.css({height:"auto"}),r=this.$titleContainer.outerHeight(),this.width?n=Math.min(this.$content.outerHeight()+r,$(window).height()-10):(this.$content.css({position:"absolute"}),i=this.$content.outerWidth(),n=Math.min(this.$content.outerHeight()+r,$(window).height()-10),this.$content.css({position:"static"})),this.$dialog.css({height:n,width:i||this.width}),this.$contentContainer.css({height:n-r}),e?this.showContentTimeout=this.delay(300,this.showContent):this.showContent(!1),this.delay(250,function(){return this.removeClass("mercury-no-animation")})},n.prototype.contentFromOptions=function(){return this.subTemplate?this.renderTemplate(this.subTemplate):this.content},n.prototype.showContent=function(e){return e==null&&(e=!0),clearTimeout(this.contentOpacityTimeout),this.removeClass("loading"),this.$content.css({visibility:"visible",width:"auto",display:"block"}),e?this.contentOpacityTimeout=this.delay(50,function(){return this.$content.css({opacity:1})}):this.$content.css({opacity:1})},n.prototype.appendTo=function(){return n.__super__.appendTo.call(this,Mercury["interface"])},n.prototype.release=function(){return this.visible?this.hide(!0):n.__super__.release.apply(this,arguments)},n.prototype.onShow=function(){return Mercury.trigger("blur"),Mercury.trigger("modals:hide")},n.prototype.onHide=function(){return Mercury.trigger("focus"),this.delay(250,function(){return this.lastWidth=null,this.$dialog.css({height:"",width:""}),this.$contentContainer.css({height:""}),this.$content.hide()})},n}(Mercury.View)}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e={},Mercury.Snippet=function(t){function r(e){var t,n,i;this.options=e!=null?e:{},this.configuration=this.options.config||{},i=this.options;for(t in i)n=i[t],t!=="config"&&(this[t]=n);if(!this.name)throw new Error("must provide a name for snippets");this.supportedRegions||(this.supportedRegions="all"),r.__super__.constructor.call(this,this.defaults||{})}return n(r,t),r.logPrefix="Mercury.Snippet:",r.register=function(e,t){return t.name=e,new Mercury.Snippet.Definition(t)},r.get=function(t,n){var r;n==null&&(n=!1),r=e[t];if(!r)throw new Error("unable to locate the "+t+" snippet");return n?new Mercury.Snippet(r.signature()):r},r.fromSerializedJSON=function(e){var t;return t=this.get(e.name,!0),t.cid=e.cid,t.set(e.attributes),t},r.all=function(){return e},r.unregister=function(t){var n;n=e[t];if(!n)throw new Error("unable to locate the "+t+" snippet");return delete e[t]},r.prototype.toSerializedJSON=function(){return{cid:this.cid,name:this.name,attributes:this.toJSON()}},r.prototype.initialize=function(e){return this.region=e,this.supportedRegions!=="all"&&this.supportedRegions.indexOf(this.region.type())===-1?alert(this.t("Unable to use the "+this.name+" snippet in that region. Supported regions: "+this.supportedRegions.join(", "))):this.form?this.displayForm():this.render()},r.prototype.delay=function(e,t){var n=this;return setTimeout(function(){return t.call(n)},e)},r.prototype.displayForm=function(e){var t,n=this;return t=new(this.Modal||Mercury.Modal)({title:this.get("title"),template:this.templateClosure(e||this.form),width:600,model:this,hideOnValidSubmit:!0}),t.on("form:success",function(){return n.render()})},r.prototype.render=function(e){return e==null&&(e={}),e=$.extend({},this.renderOptions,e),this.url()&&!this.renderedView?this.save(e):this.renderView(e.template)},r.prototype.renderView=function(e){return this.renderedView=this.view(this.templateClosure(e||this.template)),this.trigger("rendered",this.renderedView),this.delay(1,this.afterRender)},r.prototype.afterRender=function(){},r.prototype.view=function(e){return new Mercury.Snippet.View({template:e,snippet:this})},r.prototype.saveSuccess=function(e){var t=this;return this.renderView(function(){return t.get("preview")||e})},r.prototype.templateClosure=function(e){var t,n=this;return typeof e=="function"&&(t=function(){return e.apply(null,arguments)}),t||e},r.prototype.getRenderedView=function(e){return this.renderedView},r.prototype.replaceWithView=function(e){return e.replaceWith(this.renderedView.$el),this.afterRender()},r.prototype.renderAndReplaceWithView=function(e,t){return t==null&&(t=null),this.one("rendered",function(n){return e.replaceWith(n.$el),typeof t=="function"?t(e,n):void 0}),this.render()},r}(Mercury.Model),Mercury.Snippet.Module={registerSnippet:Mercury.Snippet.register,getSnippet:Mercury.Snippet.get},Mercury.Snippet.Definition=function(){function t(t){this.options=t!=null?t:{},this.name=this.options.name;if(!this.name)throw new Error("must provide a name for snippets");this.configuration=this.options.config,this.title=this.options.title,this.description=this.options.description,this.version=this.options.version,e[this.name]=this}return t.prototype.signature=function(e){var t,n,r;e==null&&(e=!0),n=$.extend({},this.options,{config:this.configuration});if(!e)for(t in n)r=n[t],typeof r=="function"&&delete n[t];return n},t}(),Mercury.Snippet.View=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.build=function(){return this.addClass("mercury-"+this.snippet.name+"-snippet"),this.attr({"data-mercury-snippet":this.snippet.cid}),this.attr("contenteditable",!1),this.$el.data({snippet:this.snippet})},t}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;Mercury.Region=function(e){function r(e,t){var n;this.el=e,this.options=t!=null?t:{};if(this.el&&$(this.el).data("region"))return!1;if(!this.constructor.supported)return this.notify(this.t("Is unsupported in this browser")),!1;this.actions||(this.actions={}),this.context=$.extend({},this.constructor.context,this.context),this.dataAttrs=$.extend({},this.constructor.dataAttrs,this.dataAttrs),this.options=$.extend({},this.options,this.config("regions:"+this.type())),this.el&&(n=this.config("regions:options"))&&(this.options=$.extend(this.options,JSON.parse($(this.el).attr(n)||"{}"))),this.placeholder||(this.placeholder=this.options.placeholder||""),typeof this.beforeBuild=="function"&&this.beforeBuild(),r.__super__.constructor.call(this,this.options),this.$focusable||this.attr({tabindex:0}),this.name||(this.name=this.$el.attr(this.config("regions:identifier"))),this.previewing||(this.previewing=!1),this.focused||(this.focused=!1),this.$focusable||(this.$focusable=this.$el),this.skipHistoryOn||(this.skipHistoryOn=["redo"]),this.changed||(this.changed=!1),this.setInitialData(),typeof this.afterBuild=="function"&&this.afterBuild(),this.$el.data({region:this}),this.$focusable.attr({"data-placeholder":this.placeholder}),this.name||(this.notify(this.t("No name provided for the %s region, falling back to random",this.type())),this.name=""+this.type()+Math.floor(Math.random()*1e4),this.$el.attr(this.config("regions:identifier"),this.name)),this.addRegionAttrs(),this.skipHistoryOnInitialize||this.pushHistory(),this.bindDefaultEvents(),this.initialValue=JSON.stringify(this.toJSON())}return t(r,e),r.extend(Mercury.Config),r.extend(Mercury.Events),r.extend(Mercury.I18n),r.extend(Mercury.Logger),r.include(Mercury.Stack),r.Modules={},r.supported=!0,r.logPrefix="Mercury.Region:",r.type="unknown",r.defaultActions={undo:"onUndo",redo:"onRedo"},r.define=function(e,t,n){return this.klass=e,this.type=t,n==null&&(n={}),this.logPrefix=this.prototype.logPrefix=""+this.klass+":",this.prototype.actions=$.extend(this.prototype.actions,n),this.prototype.toolbars=[this.type],this.off(),this},r.create=function(e){var t;return e=$(e),t=e.attr(this.config("regions:attribute")),t||this.notify(this.t("Region type not provided")),t=(""+t).toLowerCase().toCamelCase(!0),Mercury.Region[t]||this.notify(this.t("Unknown %s region type, falling back to base region",t)),new(Mercury.Region[t]||Mercury.Region)(e)},r.addAction=function(e,t){var n;return typeof e=="object"?n=e:(n={},n[e]=t),this.actions=$.extend(this.actions||{},n)},r.addContext=function(e,t){var n;return typeof e=="object"?n=e:(n={},n[e]=t),this.context=$.extend(this.context||{},n)},r.addData=function(e,t){var n;return typeof e=="object"?n=e:(n={},n[e]=t),this.dataAttrs=$.extend(this.dataAttrs||{},n)},r.addToolbar=function(e,t){var n;return t==null&&(t={}),typeof e=="object"&&(t=e,e=this.type),n=e===this.type?"toolbars:"+e:"toolbars:"+this.type+":"+e,Mercury.configure(n,t)},r.prototype.setInitialData=function(){var e,t,n,r,i;r=this.dataAttrs,i=[];for(e in r)t=r[e],n={},n[e]=this.$el.data(e)||null,i.push(this.data(n));return i},r.prototype.addRegionAttrs=function(){return this.addClass("mercury-"+this.type()+"-region"),this.$focusable.attr("data-mercury-region",!0)},r.prototype.type=function(){return this.constructor.type},r.prototype.trigger=function(e){return r.__super__.trigger.apply(this,arguments),Mercury.trigger("region:"+e,this)},r.prototype.hasAction=function(e){return!!this.actions[e]},r.prototype.hasContext=function(e,t){return t==null&&(t=!1),this.context[e]?(e=this.context[e].call(this,e),t?e:!!e):!1},r.prototype.handleAction=function(e,t){var n,r;t==null&&(t={});if(!this.focused||this.previewing)return;return this.skipHistoryOn.indexOf(e)>-1||this.pushHistory(),n=Mercury.Action.create(e,t),(r=this.actions[e])!=null&&r.call(this,n),this.trigger("action",n),this.trigger("update"),!0},r.prototype.handleMode=function(){var e,t,r;return e=1<=arguments.length?n.call(arguments,0):[],t=e.shift(),typeof this[r=("toggle_"+t).toCamelCase()]=="function"?this[r].apply(this,e):void 0},r.prototype.togglePreview=function(){return this.previewing=!this.previewing,this.trigger("preview",this.previewing),this.previewing?(this.blur(),this.$focusable.removeAttr("tabindex").removeAttr("data-mercury-region")):this.$focusable.attr({tabindex:0}).attr("data-mercury-region",!0),typeof this.onTogglePreview=="function"?this.onTogglePreview():void 0},r.prototype.pushHistory=function(e){var t,n,r=this;e==null&&(e=null),e&&(t=[13,46,8].indexOf(e));if(e===null||t>=0&&t!==this.lastKeyCode)n=!0;return this.lastKeyCode=t,clearTimeout(this.historyTimeout),n?this.pushStack(this.toStack()):this.historyTimeout=this.delay(2500,function(){return r.pushStack(r.toStack())})},r.prototype.focus=function(e,t){var n,r;return e==null&&(e=!1),t==null&&(t=!1),this.focused=!0,n=window.scrollX,r=window.scrollY,(t||!this.$focusable.is(":focus"))&&this.$focusable.focus(),e||window.scrollTo(n,r),typeof this.onFocus=="function"?this.onFocus():void 0},r.prototype.blur=function(){return this.focused=!1,this.$focusable.blur(),typeof this.onBlur=="function"?this.onBlur():void 0},r.prototype.value=function(e){return e==null&&(e=null),e===null||typeof e=="undefined"?this.html():this.html(e)},r.prototype.data=function(e,t){var n,r;return typeof e=="string"&&arguments.length===1||arguments.length===0?(n=this.$el.data(e),arguments.length===0&&(n=$.extend({},n),this.cleanData(n)),n!=null?n:null):(r=e,typeof e=="string"&&(r={},r[e]=t),this.setData(r),this.$el)},r.prototype.cleanData=function(e){return delete e.region,delete e.mercury,delete e.mercuryRegion,delete e.placeholder,delete e.regionOptions},r.prototype.setData=function(e){var t,n,r,i;this.$el.data(e),i=[];for(t in e)n=e[t],i.push((r=this.dataAttrs[t])!=null?typeof r.call=="function"?r.call(this,n):void 0:void 0);return i},r.prototype.snippets=function(){return{}},r.prototype.hasChanges=function(){return this.changed||this.initialValue!==JSON.stringify(this.toJSON())},r.prototype.onSave=function(){return this.initialValue=JSON.stringify(this.toJSON()),this.changed=!1},r.prototype.onUndo=function(){return this.fromStack(this.undoStack())},r.prototype.onRedo=function(){return this.fromStack(this.redoStack())},r.prototype.onItemDropped=function(e){var t,n,r;if(this.previewing)return;return t=e.originalEvent.dataTransfer,this.focus(),t.files.length&&this.onDropFile?(this.prevent(e),this.onDropFile(t.files)):this.onDropSnippet&&(r=t.getData("snippet"))?(this.onDropSnippet(n=Mercury.Snippet.get(r,!0)),n.initialize(this)):typeof this.onDropItem=="function"?this.onDropItem(e,t):void 0},r.prototype.toStack=function(){return this.toJSON()},r.prototype.fromStack=function(e){if(e)return this.fromJSON(e)},r.prototype.toJSON=function(e){return e==null&&(e=!1),{name:this.name,type:this.type(),value:this.value(),data:this.data(),snippets:this.snippets()}},r.prototype.fromJSON=function(e){typeof e=="string"&&(e=JSON.parse(e)),e.value!==null&&typeof e.value!="undefined"&&this.value(e.value);if(e.data)return this.data(e.data)},r.prototype.load=function(e){return this.fromJSON(e),typeof this.loadSnippets=="function"?this.loadSnippets(e.snippets||{}):void 0},r.prototype.release=function(){return this.$el.data({region:null}),this.removeClass("mercury-"+this.type()+"-region"),this.$focusable.removeAttr("tabindex").removeAttr("data-mercury-region"),this.trigger("release"),this.$el.off(),this.$focusable.off(),this.off(),this.blur()},r.prototype.bindDefaultEvents=function(){return this.delegateActions($.extend(!0,this.constructor.actions,this.constructor.defaultActions,this.actions||(this.actions={}))),this.delegateEvents({"mercury:action":function(){return this.handleAction.apply(this,arguments)},"mercury:mode":function(){return this.handleMode.apply(this,arguments)},"mercury:save":function(){return this.onSave()}}),this.bindFocusEvents(),this.bindKeyEvents(),this.bindMouseEvents(),this.bindDropEvents()},r.prototype.bindFocusEvents=function(){var e=this;return this.delegateEvents(this.$focusable,{focus:function(){return e.focused=!0,e.trigger("focus"),typeof e.onFocus=="function"?e.onFocus():void 0},blur:function(){return e.focused=!1,e.trigger("blur"),typeof e.onBlur=="function"?e.onBlur():void 0}})},r.prototype.bindKeyEvents=function(){var e=this;return this.delegateEvents(this.$focusable,{keyup:function(){return e.trigger("update")},keydown:function(t){if(!t.metaKey||t.keyCode!==90)return;return e.prevent(t),t.shiftKey?e.handleAction("redo"):e.handleAction("undo")}})},r.prototype.bindMouseEvents=function(){var e=this;return this.delegateEvents(this.$focusable,{mouseup:function(){return e.trigger("update")}})},r.prototype.bindDropEvents=function(){var e=this;if(!(this.onDropFile||this.onDropItem||this.onDropSnippet))return;return this.delegateEvents(this.$el,{dragenter:function(t){if(!e.previewing)return e.prevent(t)},dragover:function(t){if(!(e.previewing||e.editableDropBehavior&&Mercury.support.webkit&&!Mercury.dragHack))return e.prevent(t)},drop:"onItemDropped"})},r.prototype.delegateActions=function(e){var t,n,r;r=[];for(t in e){n=e[t];if(typeof n!="function"){if(!this[n])throw new Error(""+n+" doesn't exist");n=this[n]}r.push(this.actions[t]=n)}return r},r}(Mercury.View)}.call(this),function(){Mercury.View.Modules.Draggable={startDrag:function(e){var t;if(e.button>1)return;return this.prevent(e),this.viewportSize={width:$(window).width(),height:$(window).height()},t=this.$el.position(),this.dragPosition={x:t.left*-1,y:t.top*-1},this.potentialDragStart(e.pageX,e.pageY)},potentialDragStart:function(e,t){this.startPosition={x:this.dragPosition.x,y:this.dragPosition.y},this.initialPosition={x:e,y:t},this.potentiallyDragging=!0,this.bindDocumentDragEvents(document);if(Mercury["interface"].document&&Mercury["interface"].document!==document)return this.bindDocumentDragEvents(Mercury["interface"].document)},onStartDragging:function(e,t){return this.addClass("mercury-no-animation"),this.dragging=!0,this.initialPosition={x:e,y:t},typeof this.onDragStart=="function"?this.onDragStart():void 0},onDrag:function(e){var t,n,r,i;return this.prevent(e),r=e.pageX,i=e.pageY,!this.dragging&&(Math.abs(this.initialPosition.x-r)>5||Math.abs(this.initialPosition.y-i)>5)?this.onStartDragging(r,i):(this.lastPosition=this.dragPosition,t=(this.startPosition.x-r+this.initialPosition.x)*-1,n=(this.startPosition.y-i+this.initialPosition.y)*-1,this.dragPosition={x:t,y:n},this.setPositionOnDrag(t,n))},onEndDragging:function(e){return this.dragging===!0&&typeof this.onDragEnd=="function"&&this.onDragEnd(e),this.dragging=!1,this.potentiallyDragging=!1,this.unbindDocumentDragEvents(document),Mercury["interface"].document&&Mercury["interface"].document!==document&&this.unbindDocumentDragEvents(Mercury["interface"].document),this.delay(250,function(){return this.removeClass("mercury-no-animation")})},bindDocumentDragEvents:function(e){var t=this;return $(e).on("mousemove",this.onDragHandler=function(e){return t.onDrag(e)}).on("mouseup",this.onEndDraggingHandler=function(e){return t.onEndDragging(e)})},unbindDocumentDragEvents:function(e){return $(e).off("mousemove",this.onDragHandler).off("mouseup",this.onEndDraggingHandler)},setPositionOnDrag:function(e,t){return this.css({top:t,left:e})}}}.call(this),function(){Mercury.View.Modules.InterfaceMaskable={included:function(){return this.on("build",this.buildInterfaceMaskable)},extended:function(){return this.on("build",this.buildInterfaceMaskable)},buildInterfaceMaskable:function(){return this.$mask=$('<div class="mercury-interface-mask">'),this.append(this.$mask),this.delegateEvents({"mercury:interface:mask":this.mask,"mercury:interface:unmask":this.unmask,"mousedown .mercury-interface-mask":this.prevent,"mouseup .mercury-interface-mask":this.prevent,"click .mercury-interface-mask":this.onMaskClick})},mask:function(){return this.$mask.show()},unmask:function(){return this.$mask.hide()},onMaskClick:function(e){return this.prevent(e,!0),Mercury.trigger("dialogs:hide")}}}.call(this),function(){Mercury.View.Modules.InterfaceShadowed={included:function(){return this.on("init",this.buildInterfaceShadowed)},extended:function(){return this.on("init",this.buildInterfaceShadowed)},buildInterfaceShadowed:function(){if(!this.el.webkitCreateShadowRoot)return;return this.shadow=$(this.el.webkitCreateShadowRoot()),this.el=document.createElement(this.tag||this.constructor.tag),this.$el=$(this.el),this.shadow.get(0).applyAuthorStyles=!0,this.shadow.append(this.el)}}}.call(this),function(){Mercury.View.Modules.ToolbarDialog={included:function(){return this.on("build",this.buildToolbarDialog)},buildToolbarDialog:function(){return this.delegateEvents({"mercury:dialogs:hide":function(){return typeof this.hide=="function"?this.hide():void 0},"mercury:interface:resize":"positionAndResize"}),this.on("show",function(){return this.visible||Mercury.trigger("interface:mask"),!0}),this.on("hide",function(){return this.visible&&Mercury.trigger("interface:unmask"),!0})},positionAndResize:function(e){return this.position(e),this.resize(!1,e)},position:function(e){var t,n,r,i,s,o,u,a;return this.css({top:0,left:0}),s=this.$el.parent(),a=$(window),u={width:a.width(),height:a.height()},t={width:this.$el.outerWidth(),height:this.$el.outerHeight()},i={width:s.outerWidth(),height:s.outerHeight()},r=s.offset(),r.left-=window.scrollX,r.top-=window.scrollY,n=0,t.width+r.left>u.width&&(n=-t.width+i.width),r.left+n<0&&(n-=r.left+n),o=i.height,t.height+r.top+i.height>u.height&&(o=-t.height),r.top+o+i.height<0&&(o-=r.top+o+i.height),this.css({top:o,left:n})},resize:function(){}}}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Model.Page=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.define("Mercury.Model.Page"),n.prototype.save=function(e){return e==null&&(e={}),n.__super__.save.call(this,$.extend(this.config("saving"),e))},n}(Mercury.Model)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};Mercury.BaseInterface=function(t){function r(){this.onUnload=e(this.onUnload,this),this.onResize=e(this.onResize,this),this.hideDialogs=e(this.hideDialogs,this);if(parent!==window&&parent.Mercury){this.log(this.t("Has already been defined in parent frame"));return}this.config("interface:maskable")&&this.extend(Mercury.View.Modules.InterfaceMaskable),this.config("interface:shadowed")&&this.extend(Mercury.View.Modules.InterfaceShadowed),Mercury["interface"]||(Mercury["interface"]=this),this.floating||(this.floating=this.config("interface:floating")),this.visible=!0,r.__super__.constructor.apply(this,arguments),this.page=new Mercury.Model.Page,this.regions||(this.regions=[]),$(window).on("beforeunload",this.onUnload),$(window).on("resize",this.onResize),this.initialize(),this.buildInterface(),this.bindDefaultEvents(),Mercury.trigger("initialized")}return n(r,t),r.include(Mercury.Module),r.include(Mercury.View.Modules.Draggable),r.logPrefix="Mercury.BaseInterface:",r.tag="mercury",r.events={"mercury:save":"save","mercury:focus":"focusActiveRegion","mercury:blur":"blurActiveRegion","mercury:resize":"onResize","mercury:action":"focusActiveRegion","mercury:region:focus":"onRegionFocus","mercury:region:release":"onRegionRelease","mercury:reinitialize":"reinitialize","mercury:interface:toggle":"toggle","mousedown .mercury-drag-handle":"startDrag"},r.prototype.build=function(){this.el||(this.el=document.createElement(this.tag||this.constructor.tag)),this.$el=$(this.el),this.attr(this.attributes);if(this.config("interface:floatDrag"))return this.append('<div class="mercury-drag-handle"/>')},r.prototype.init=function(){return $("body").before(this.$el)},r.prototype.initialize=function(){return this.addAllRegions(),this.bindDocumentEvents()},r.prototype.load=function(e){var t,n,r,i,s;r=e.contents||e,s=[];for(n in r)t=r[n],s.push((i=this.findRegionByName(n))!=null?i.load(t):void 0);return s},r.prototype.findRegionByName=function(e){var t,n,r,i;i=this.regions||[];for(n=0,r=i.length;n<r;n++){t=i[n];if(t.name===e)return t}return null},r.prototype.addAllRegions=function(){var e,t,n,r;r=this.regionElements();for(t=0,n=r.length;t<n;t++)e=r[t],this.addRegion(e);return this.region||(this.region=this.regions[0])},r.prototype.bindDocumentEvents=function(){if(!this.config("interface:mask"))return $("body",this.document).on("mousedown",this.hideDialogs)},r.prototype.buildInterface=function(){var e,t,n,r,i;this.addClasses(),i=["toolbar","statusbar"];for(n=0,r=i.length;n<r;n++){t=i[n];if(!(e=this.config("interface:"+t)))continue;this[t]=this.appendView(new Mercury[e])}return this.config("interface:enabled")||(this.previewMode=!0,this.hide(),Mercury.trigger("mode","preview")),this.focusDefaultRegion(),this.onResize(),this.delay(500,function(){return this.removeClass("loading")})},r.prototype.addClasses=function(){return this.addClass(this.className),this.addClass("loading"),this.addClass(this.config("interface:style")||"standard"),this.floating&&this.addClass("mercury-floating"),this.addClass("locale-"+Mercury.I18n.detectLocale().join("-").toLowerCase())},r.prototype.bindDefaultEvents=function(){return this.delegateEvents({"mercury:mode":function(e){return this.setMode(e)},"mercury:action":function(){return this.focusActiveRegion()}})},r.prototype.reinitialize=function(){return this.addAllRegions(),this.focusDefaultRegion()},r.prototype.setInterface=function(e){return e==="float"&&(e="mercury-floating",this.floating=!0,$("body").hasClass("mercury-transitions")&&$("body").removeClass("mercury-transitions").addClass("mercury-no-transitions")),this.addClass(e),this.position(),this.onResize()},r.prototype.removeInterface=function(e){return e==="float"&&(e="mercury-floating",this.floating=!1,this.placed=!1,this.css({position:""})),$("body").hasClass("mercury-no-transitions")&&$("body").removeClass("mercury-no-transitions").addClass("mercury-transitions"),this.removeClass(e),this.position(),this.onResize()},r.prototype.focusDefaultRegion=function(){return this.delay(100,this.focusActiveRegion)},r.prototype.regionElements=function(){return $("["+this.config("regions:attribute")+"]",this.document)},r.prototype.addRegion=function(e){var t;if($(e).data("region"))return;return t=Mercury.Region.create(e),this.regions.push(t)},r.prototype.focusActiveRegion=function(){var e;return(e=this.region)!=null?e.focus(!1,!0):void 0},r.prototype.blurActiveRegion=function(){var e;return(e=this.region)!=null?e.blur():void 0},r.prototype.setMode=function(e){this[""+e+"Mode"]=!this[""+e+"Mode"],this.focusActiveRegion();if(e==="preview")return this.delay(50,function(){return this.position()})},r.prototype.toggle=function(){return this.visible?this.hide():this.show()},r.prototype.show=function(){if(this.visible)return;return Mercury.trigger("interface:show"),this.previewMode&&Mercury.trigger("mode","preview"),this.$el.show(),this.visible=!0,this.onResize(),this.$el.stop().animate({opacity:1},{duration:250}),this.position()},r.prototype.hide=function(){var e=this;if(!this.visible)return;return this.hiding=!0,Mercury.trigger("interface:hide"),this.previewMode||Mercury.trigger("mode","preview"),$("body").css({position:"relative",top:0}),this.visible=!1,this.position(),this.$el.stop().animate({opacity:0},{duration:250,complete:function(){return e.$el.hide(),e.hiding=!1}})},r.prototype.dimensions=function(){var e,t,n,r;return this.floating?(t=0,e=0):(t=(n=this.toolbar)!=null?n.height():void 0,e=(r=this.statusbar)!=null?r.height():void 0),{top:t,left:0,right:0,bottom:e,width:$(window).width(),height:$(window).height()-t-e}},r.prototype.hasChanges=function(){var e,t,n,r
;r=this.regions;for(t=0,n=r.length;t<n;t++){e=r[t];if(e.hasChanges())return!0}return!1},r.prototype.hideDialogs=function(){return Mercury.trigger("dialogs:hide")},r.prototype.release=function(){$(window).off("resize",this.resize),$("body").css({position:"",top:""}),$("body",this.document).off("mousedown",this.hideDialogs);while(this.regions.length)this.regions.shift().release();return r.__super__.release.apply(this,arguments)},r.prototype.serialize=function(){var e,t,n,r,i;e={},i=this.regions;for(n=0,r=i.length;n<r;n++)t=i[n],e[t.name]=t.toJSON(!0);return e},r.prototype.save=function(){var e=this;return this.page.set({content:this.serialize(),location:location.pathname}),this.page.on("error",function(t,n){return alert(e.t("Unable to save to the url: %s",n.url))}),this.page.save().always=function(){return e.delay(250,function(){return Mercury.trigger("save:complete")})}},r.prototype.heightForWidth=function(e){var t,n;return n=this.$el.outerWidth(),this.css({width:e,visibility:"hidden",height:"auto"}),t=this.$el.outerHeight(),this.css({width:n,visibility:"visible"}),t},r.prototype.position=function(e){var t,n,r,i,s,o;e==null&&(e=!1);if(!this.floating)return;if(!this.region)return;if(this.placed)return;if(this.hiding)return;return this.addClass("mercury-no-animation"),i=this.positionForRegion(),this.width=o=Math.max(this.config("interface:floatWidth")||this.region.$el.width(),300),n=this.heightForWidth(o),r=i.left,s=$(window).width(),r+o>s&&(r-=r+o-s),t=function(){return e&&this.removeClass("mercury-no-animation"),this.css({top:i.top-n,left:r,width:o})},e?(this.delay(20,t),this.delay(300,function(){return Mercury.trigger("interface:resize",this.dimensions())})):t.call(this)},r.prototype.positionForRegion=function(){return this.region.$el.offset()},r.prototype.onDragStart=function(){return Mercury.trigger("dialogs:hide")},r.prototype.setPositionOnDrag=function(e,t){this.placed||(this.placed=!0,this.startPosition.x+=window.scrollX,this.startPosition.y+=window.scrollY,e-=window.scrollX,t-=window.scrollY,this.lastPosition={x:e,y:t},this.css({position:"fixed",top:t,left:e})),e<0&&(e=0),t<0&&(t=0),e>this.viewportSize.width-50&&(e=this.viewportSize.width-50),t>this.viewportSize.height-50&&(t=this.viewportSize.height-50),this.css({top:t,left:e});if(!this.width)return this.onResize()},r.prototype.onRegionFocus=function(e){return this.region=e,this.delay(50,function(){return this.floating?this.position(!0):this.onResize()})},r.prototype.onRegionRelease=function(e){var t;e===this.region&&(this.region=this.regions[0]),t=this.regions.indexOf(e);if(t>-1)return this.regions.splice(t,1)},r.prototype.onResize=function(){var e;e=this.dimensions(),$("body").css({position:"relative",top:e.top});if(!this.visible)return;return Mercury.trigger("interface:resize",e),this.position(),e},r.prototype.onUnload=function(){if(this.config("interface:silent")||!this.hasChanges())return;return this.t("You have unsaved changes.  Are you sure you want to leave without saving them first?")},r}(Mercury.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};Mercury.FrameInterface=function(t){function r(){return this.onResize=e(this.onResize,this),this.onScroll=e(this.onScroll,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.logPrefix="Mercury.FrameInterface:",r.className="mercury-frame-interface",r.prototype.initialize=function(){this.$frame=$(this.frame).addClass("mercury-frame-interface-frame");if(!this.$frame.length)return this.initialized=!0,r.__super__.initialize.apply(this,arguments)},r.prototype.load=function(e){this.loadedJSON=e;if(!this.initialized)return;return r.__super__.load.apply(this,arguments)},r.prototype.reinitialize=function(){return this.$frame.length?(this.initialized=!1,this.initializeFrame()):r.__super__.reinitialize.apply(this,arguments)},r.prototype.bindDefaultEvents=function(){var e=this;return this.$frame.on("load",function(){return e.initializeFrame(),e.load(e.loadedJSON),e.$frame.off("load").on("load",function(){return e.reinitializeFrame()})}),this.delegateEvents({"mercury:initialize":function(){return this.initializeFrame()}}),r.__super__.bindDefaultEvents.apply(this,arguments)},r.prototype.bindDocumentEvents=function(){return $(this.window).on("scroll",this.onScroll),r.__super__.bindDocumentEvents.apply(this,arguments)},r.prototype.initializeFrame=function(){if(this.initialized)return;return this.initialized=!0,this.regions||(this.regions=[]),this.setupDocument(),this.bindDocumentEvents(),this.addAllRegions(),this.hijackLinksAndForms(),this.trigger("initialized"),Mercury.trigger("initialized"),this.delay(100,this.focusDefaultRegion)},r.prototype.reinitializeFrame=function(){return this.frameLocation()?(this.initialized=!1,this.regions=[],this.initializeFrame(),this.load(this.loadedJSON)):(alert(this.t("You've left editing the page you were on, please refresh the page.")),this.release())},r.prototype.frameLocation=function(){var e,t;return(e=this.$frame.get(0))!=null?(t=e.contentWindow)!=null?t.location.href:void 0:void 0},r.prototype.setupDocument=function(){var e;return this.window=this.$frame.get(0).contentWindow,(e=this.window).Mercury||(e.Mercury=Mercury),this.window.Mercury["interface"]=this,this.document=$(this.window.document)},r.prototype.hide=function(){return this.$frame.css({top:0,height:"100%"}),r.__super__.hide.apply(this,arguments)},r.prototype.positionForRegion=function(){var e;return e=r.__super__.positionForRegion.apply(this,arguments),this.$frame.length&&(e.top-=$("body",this.document).scrollTop()),e},r.prototype.hijackLinksAndForms=function(){var e,t,n,r,i,s,o,u,a,f,l,c;i=this.config("interface:nohijack")||[],s="["+this.config("regions:attribute")+"]",l=$("a, form",this.document),c=[];for(o=0,a=l.length;o<a;o++){n=l[o],e=$(n),r=!1;for(u=0,f=i.length;u<f;u++){t=i[u];if(e.hasClass(t)){r=!0;continue}}!r&&(n.target===""||n.target==="_self")&&!e.closest(s).length?c.push(e.attr("target","_parent")):c.push(void 0)}return c},r.prototype.release=function(){var e;this.$frame.css({top:0}),$(this.window).off("scroll",this.onScroll),r.__super__.release.apply(this,arguments);try{if(e=this.frameLocation())return window.location.href=e}catch(t){}},r.prototype.onScroll=function(){return this.position()},r.prototype.onResize=function(){var e;e=r.__super__.onResize.apply(this,arguments);if(e)return this.$frame.css({top:e.top,height:e.height})},r}(Mercury.BaseInterface)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Lightview=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.logPrefix="Mercury.Lightview:",n.className="mercury-dialog mercury-lightview",n.elements={dialog:".mercury-lightview-dialog-positioner",content:".mercury-lightview-dialog-content",contentContainer:".mercury-lightview-dialog-content-container",titleContainer:".mercury-lightview-dialog-title",title:".mercury-lightview-dialog-title span"},n.events={"mercury:interface:resize":"resize","mercury:modals:hide":"hide","click .mercury-lightview-dialog-title em":"hide"},n.prototype.primaryTemplate="lightview",n.prototype.releaseOnHide=!0,n.prototype.build=function(){return n.__super__.build.apply(this,arguments),this.defaultPosition()},n.prototype.defaultPosition=function(){return this.$dialog.css({marginTop:($(window).height()-75)/2})},n.prototype.resize=function(e,t){var n,r;e==null&&(e=!0),t==null&&(t=null);if(!this.visible)return;return clearTimeout(this.showContentTimeout),typeof e=="object"&&(t=e,e=!1),e||this.addClass("mercury-no-animation"),this.$contentContainer.css({height:"auto"}),this.$content.css({width:Math.min(this.$content.outerWidth(),$(window).width())}),r=this.$titleContainer.outerHeight(),n=Math.min(this.$content.outerHeight()+r,$(window).height()),this.$dialog.css({marginTop:($(window).height()-n)/2,height:n}),this.$content.css({width:"auto"}),this.$contentContainer.css({height:n-r}),e?this.showContentTimeout=this.delay(300,this.showContent):this.showContent(!1),this.removeClass("mercury-no-animation")},n.prototype.onHide=function(){return n.__super__.onHide.apply(this,arguments),this.delay(250,this.defaultPosition)},n}(Mercury.Modal)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};Mercury.Panel=function(t){function r(){return this.resize=e(this.resize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.include(Mercury.View.Modules.Draggable),r.logPrefix="Mercury.Panel:",r.className="mercury-dialog mercury-panel",r.elements={content:".mercury-panel-content",contentContainer:".mercury-panel-content-container",titleContainer:".mercury-panel-title",title:".mercury-panel-title span"},r.events={"mercury:interface:resize":"resize","mercury:panels:hide":"hide","mousedown .mercury-panel-title em":"prevent","mousedown .mercury-panel-title":"startDrag","click .mercury-panel-title em":"hide"},r.prototype.primaryTemplate="panel",r.prototype.releaseOnHide=!1,r.prototype.setWidth=function(e){return this.css({width:e})},r.prototype.resize=function(e,t){var n,r,i;e==null&&(e=!0),t==null&&(t=null);if(!this.visible)return;clearTimeout(this.showContentTimeout),typeof e=="object"&&(t=e,e=!1),e||this.addClass("mercury-no-animation");if(t||(t=(i=Mercury["interface"])!=null?typeof i.dimensions=="function"?i.dimensions():void 0:void 0))this.css({top:t.top+10,bottom:t.bottom+10}),this.$el.outerWidth()+this.$el.offset().left>=t.width-10&&this.css({left:""});return r=this.$titleContainer.outerHeight(),n=this.$el.height(),this.$contentContainer.css({height:n-r}),e?this.showContentTimeout=this.delay(300,this.showContent):this.showContent(!1),this.removeClass("mercury-no-animation")},r.prototype.onShow=function(){return this.delay(1,this.resize),Mercury.trigger("panels:hide")},r.prototype.onHide=function(){return Mercury.trigger("focus")},r.prototype.focusFirstFocusable=function(){},r.prototype.keepFocusConstrained=function(){},r.prototype.setPositionOnDrag=function(e){return e<10&&(e=10),e>=this.viewportSize.width-this.$el.outerWidth()-10?this.css({left:""}):this.css({left:e})},r}(Mercury.Modal)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Statusbar=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.logPrefix="Mercury.Statusbar:",n.className="mercury-statusbar",n.template="statusbar",n.elements={path:".mercury-statusbar-path"},n.events={"mercury:interface:hide":"hide","mercury:interface:show":"show","mercury:region:update":"onRegionUpdate",mousedown:"onMousedown"},n.prototype.build=function(){return this.setPath()},n.prototype.setPath=function(e){var t,n,r,i;e==null&&(e=[]),this.$path.html("<b>"+this.t("Path:")+" </b>"),i=[];for(n=0,r=e.length;n<r;n++)t=e[n],this.$path.append(t),t!==e[e.length-1]?i.push(this.$path.append(" &raquo; ")):i.push(void 0);return i},n.prototype.show=function(){var e=this;if(Mercury["interface"].floating&&this.visible)return;return clearTimeout(this.visibilityTimeout),this.visible=!0,this.$el.show(),this.visibilityTimeout=this.delay(50,function(){return e.css({bottom:0})})},n.prototype.hide=function(){var e=this;if(Mercury["interface"].floating)return;return clearTimeout(this.visibilityTimeout),this.visible=!1,this.css({bottom:-this.$el.height()}),this.visibilityTimeout=this.delay(250,function(){return e.$el.hide()})},n.prototype.height=function(){return this.$el.outerHeight()},n.prototype.onMousedown=function(e){return this.prevent(e),Mercury.trigger("dialogs:hide"),Mercury.trigger("focus")},n.prototype.onRegionUpdate=function(e){var t;if(t=typeof e.path=="function"?e.path():void 0)return this.setPath(t)},n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;Mercury.ToolbarButton=function(e){function r(e,t,n){this.name=e,this.label=t,this.options=n!=null?n:{},this.determineAction(),this.determineTypes(),r.__super__.constructor.call(this,this.options),this.handleSpecial()}return t(r,e),r.logPrefix="Mercury.ToolbarButton:",r.className="mercury-toolbar-button",r.events={mousedown:"indicate",mouseup:"deindicate",mouseout:"deindicate",click:"triggerAction","mercury:region:focus":"onRegionFocus","mercury:region:action":"onRegionUpdate","mercury:region:update":"onRegionUpdate"},r.prototype.standardOptions=["title","icon","action","global","button","settings"],r.create=function(e,t,n){var r;return n==null&&(n={}),n.button&&(r=Mercury[("toolbar_"+n.button).toCamelCase(!0)])?new r(e,t,n):n.plugin&&(r=Mercury.getPlugin(n.plugin).Button)?new r(e,t,n):new Mercury.ToolbarButton(e,t,n)},r.prototype.determineAction=function(){return this.action=this.options.action||this.name,typeof this.action=="string"&&(this.action=[this.action]),this.actionName=this.action[0]},r.prototype.determineTypes=function(){var e,t,n;this.types=[];if(this.options.type)return this.types=[this.options.type];n=this.options;for(e in n)t=n[e],this.standardOptions.indexOf(e)===-1&&this.types.push(e);return this.type=this.types[0]},r.prototype.build=function(){var e;return this.registerPlugin(),this.attr("data-type",this.type),this.attr("data-icon",Mercury.Toolbar.icons[this.icon||this.name]||this.icon),this.options.title&&this.attr("title",this.t(this.options.title)),this.addClass("mercury-toolbar-"+this.name.toDash()+"-button"),this.html("<em>"+this.t(this.label)+"</em>"),(e=this.buildSubview())!=null?e.appendTo(this):void 0},r.prototype.handleSpecial=function(){this.event==="save"&&this.makeSaveButton();if(this.mode)return this.makeModeButton()},r.prototype.makeSaveButton=function(){return this.delegateEvents({"mercury:save":function(){return this.addClass("mercury-loading-indicator")},"mercury:save:complete":function(){return this.removeClass("mercury-loading-indicator")}})},r.prototype.makeModeButton=function(){return this.delegateEvents({"mercury:mode":function(e){if(e!==this.mode)return;return this.isToggled?this.untoggled():this.toggled()}})},r.prototype.registerPlugin=function(){if(!this.plugin)return;return this.plugin=Mercury.getPlugin(this.plugin,!0),this.plugin.buttonRegistered(this)},r.prototype.buildSubview=function(){var e,t,n=this;if(this.subview)return this.subview.on("show",function(){return n.toggle&&n.toggled(),n.activate()}),this.subview.on("hide",function(){return n.untoggled(),n.deactivate()}),this.subview;if(e=Mercury[("toolbar_"+this.type).toCamelCase(!0)])return t=this.options[this.type],typeof t=="string"&&(t={template:t}),this.subview=new e(t)},r.prototype.triggerAction=function(){if(this.isDisabled())return;this.toggle&&(this.isToggled?this.untoggled():this.toggled()),this.subview&&(this.subview.visible?this.deactivate():this.activate(),this.subview.toggle()),this.trigger("click");if(this.plugin||this.subview)return;return this.event&&Mercury.trigger(this.event),this.mode&&Mercury.trigger("mode",this.mode),Mercury.trigger.apply(Mercury,["action"].concat(n.call(this.action)))},r.prototype.release=function(){var e;return(e=this.subview)!=null&&e.release(),r.__super__.release.apply(this,arguments)},r.prototype.regionSupported=function(e){return this.plugin?this.plugin.regionSupported(e):e.hasAction(this.actionName)},r.prototype.onRegionFocus=function(e){var t=this;return this.delay(100,function(){return t.onRegionUpdate(e)})},r.prototype.onRegionUpdate=function(e){var t;if(e!==Mercury["interface"].region)return;((t=this.subview)!=null?!t.visible:!void 0)&&this.deactivate();if(!this.global&&!this.regionSupported(e))return this.disable();this.enable();if(e.hasContext(this.name,!0)===!0)return this.activate()},r.prototype.get=function(e){return this[e]},r.prototype.set=function(e,t){var n,r;n={},typeof e=="object"?n=e:n[e]=t,r=[];for(e in n)t=n[e],r.push(this[e]=t);return r},r.prototype.toggled=function(){return this.isToggled=!0,this.addClass("mercury-button-toggled")},r.prototype.untoggled=function(){return this.isToggled=!1,this.removeClass("mercury-button-toggled")},r.prototype.activate=function(){return this.isActive=!0,this.addClass("mercury-button-active")},r.prototype.deactivate=function(){return this.isActive=!1,this.removeClass("mercury-button-active")},r.prototype.enable=function(){return this.isEnabled=!0,this.removeClass("mercury-button-disabled")},r.prototype.disable=function(){return this.isEnabled=!1,this.addClass("mercury-button-disabled")},r.prototype.indicate=function(e){var t;this.isIndicated=!0;if(this.isDisabled())return;return e&&((t=this.subview)!=null?t.visible:void 0)&&(this.deactivate(),this.prevent(e,!0)),this.addClass("mercury-button-pressed")},r.prototype.deindicate=function(){return this.isIndicated=!1,this.removeClass("mercury-button-pressed")},r.prototype.isDisabled=function(){return this.isEnabled===!1||!!this.$el.closest(".mercury-button-disabled").length},r}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.ToolbarSelect=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.include(Mercury.View.Modules.InterfaceFocusable),n.include(Mercury.View.Modules.ToolbarDialog),n.include(Mercury.View.Modules.VisibilityToggleable),n.logPrefix="Mercury.ToolbarSelect:",n.className="mercury-dialog mercury-toolbar-select",n.prototype.hidden=!0,n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.ToolbarExpander=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.logPrefix="Mercury.ToolbarExpander:",n.className="mercury-toolbar-expander",n.events={"mercury:interface:resize":"onResize",mousedown:"preventStop",click:"toggleExpander","click li":"onClickForButton"},n.prototype.build=function(){return this.select=this.appendView(new Mercury.ToolbarSelect)},n.prototype.show=function(){if(this.visible)return;return this.visible=!0,this.$el.show()},n.prototype.hide=function(){if(!this.visible)return;return this.visible=!1,this.$el.hide()},n.prototype.toggleExpander=function(e){if(!this.visible)return;return this.prevent(e,!0),this.updateSelect(),this.select.visible||Mercury.trigger("dialogs:hide"),this.select.toggle()},n.prototype.updateSelect=function(){var e,t,n,r,i,s;this.select.html("<ul>"),t=this.select.$("ul"),i=this.parent.hiddenButtons(),s=[];for(n=0,r=i.length;n<r;n++)e=i[n],s.push(t.append($("<li data-icon='"+e.icon+"'>"+e.title+"</li>").data({button:e.el})));return s},n.prototype.onClickForButton=function(e){return this.prevent(e),$($(e.target).closest("li").data("button")).click()},n.prototype.onResize=function(){this.parent.el.scrollHeight>this.parent.$el.height()+10?this.show():this.hide();if(this.select.visible)return this.updateSelect()},n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].slice;Mercury.ToolbarItem=function(e){function r(e,t,n,i){this.name=e!=null?e:"unknown",this.type=t!=null?t:"unknown",this.value=n!=null?n:null,this.expander=i!=null?i:!1,r.__super__.constructor.call(this)}return t(r,e),r.logPrefix="Mercury.ToolbarItem:",r.prototype.build=function(){var e,t,n;this.addClasses();if(typeof this.value!="object")return;n=this.value;for(e in n)t=n[e],this.buildSubview(e,t);this.type==="group"&&this.buildSubview("sep-final","-");if(this.type==="container"&&this.expander)return this.buildExpander()},r.prototype.buildSubview=function(e,t){var r;r=function(){var r;switch($.isArray(t)?"array":typeof t){case"object":return new Mercury.ToolbarItem(e,"group",t);case"string":return new Mercury.ToolbarItem(e,"separator",t);case"array":return(r=Mercury.ToolbarButton).create.apply(r,[e].concat(n.call(t)))}}();if(r)return this.appendView(r)},r.prototype.buildExpander=function(){return this.appendView(new Mercury.ToolbarExpander({parent:this}))},r.prototype.addClasses=function(){var e;return e="mercury-toolbar-"+this.type.toDash(),this.value==="-"&&(e="mercury-toolbar-line-"+this.type.toDash()),this.addClass(["mercury-toolbar-"+this.name.toDash()+"-"+this.type.toDash(),e].join(" "))},r.prototype.hiddenButtons=function(){var e,t,n,r,i,s,o,u;r=this.$el.height(),t=[],u=this.$(".mercury-toolbar-button");for(s=0,o=u.length;s<o;s++)e=u[s],n=$(e),i=n.position().top,i>=r&&t.push({title:n.find("em").html(),icon:n.data("icon"),el:n});return t},r}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Toolbar=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.logPrefix="Mercury.Toolbar:",n.className="mercury-toolbar",n.elements={toolbar:".mercury-toolbar-secondary-container"},n.events={"mercury:interface:hide":"hide","mercury:interface:show":"show","mercury:region:focus":"onRegionFocus",mousedown:"onMousedown",click:"preventStop"},n.prototype.build=function(){return this.append(new Mercury.ToolbarItem("primary","container",this.config("toolbars:primary"),!0)),this.append(new Mercury.ToolbarItem("secondary","container",{}))},n.prototype.buildToolbar=function(e){return this.appendView(this.$toolbar,new Mercury.ToolbarItem(e,"collection",this.config("toolbars:"+e)))},n.prototype.show=function(){var e=this;if(Mercury["interface"].floating&&this.visible)return;return clearTimeout(this.visibilityTimeout),this.visible=!0,this.$el.show(),this.visibilityTimeout=this.delay(50,function(){return e.css({top:0})})},n.prototype.hide=function(){var e=this;if(Mercury["interface"].floating)return;return clearTimeout(this.visibilityTimeout),this.visible=!1,this.css({top:-this.$el.height()}),this.visibilityTimeout=this.delay(250,function(){return e.$el.hide()})},n.prototype.height=function(){return Mercury["interface"].visible?this.$el.outerHeight():0},n.prototype.onMousedown=function(e){return this.prevent(e),Mercury.trigger("dialogs:hide"),Mercury.trigger("focus")},n.prototype.onRegionFocus=function(e){var t,n,r,i;if(this.region===e)return;this.region=e,this.$(".mercury-toolbar-collection").remove(),this.releaseSubviews(),i=e.toolbars||[];for(n=0,r=i.length;n<r;n++)t=i[n],this.buildToolbar(t);return Mercury.trigger("region:update",e)},n.icons={save:"A",preview:"B",undo:"C",redo:"D",link:"J",file:"K",table:"L",character:"M",snippets:"N",history:"O",notes:"P",upload:"X",search:"Y",bold:"b",italic:"c",strike:"d",underline:"e",subscript:"f",superscript:"g",justifyLeft:"h",justifyCenter:"i",justifyRight:"j",justifyFull:"k",unorderedList:"l",orderedList:"m",outdent:"n",indent:"o",rule:"p",h1:"q",h2:"r",h3:"s",h4:"t",h5:"u",h6:"v",removeHeading:"w",blockquote:"x",clean:"y",edit:"z",pre:"z",rowBefore:"0",rowAfter:"1",rowDelete:"2",colBefore:"3",colAfter:"4",colDelete:"5",colIncrease:"6",colDecrease:"7",rowIncrease:"8",rowDecrease:"9",alignLeft:'"',alignRight:"'",alignTop:"?",alignMiddle:"!",alignBottom:"@",alignNone:"_",crop:"*",resize:"#",prev:"$",next:"%",remove:"y",togglePlay:"&",fav:"^",softWrap:"`",direction:"{",calculate:"|",user:"}",brightness:"~"},n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.ToolbarPalette=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.include(Mercury.View.Modules.InterfaceFocusable),n.include(Mercury.View.Modules.ToolbarDialog),n.include(Mercury.View.Modules.VisibilityToggleable),n.logPrefix="Mercury.ToolbarPalette:",n.className="mercury-dialog mercury-toolbar-palette",n.prototype.hidden=!0,n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Model.File=function(e){function n(e,t){this.file=e,this.options=t!=null?t:{},n.__super__.constructor.call(this,{name:this.file.name,type:this.file.type,size:this.file.size,url:this.file.url||null})}return t(n,e),n.define("Mercury.Model.File"),n.url=function(){return this.config("uploading:saveUrl")},n.prototype.validate=function(){var e,t;if(this.get("size")>=this.config("uploading:maxSize")){this.addError("size",this.t("Too large (max %s)",this.config("uploading:maxSize").toBytes()));return}e=(t=this.options["mimeTypes"])!=null?t:this.config("uploading:mimeTypes");if(e&&e.indexOf(this.get("type"))<=-1)return this.addError("type",this.t("Unsupported format (%s)",this.get("type")))},n.prototype.readAsDataURL=function(e){var t;if(!window.FileReader)return;return t=new FileReader,t.onload=function(){if(e)return e(t.result)},t.readAsDataURL(this.file)},n.prototype.readableSize=function(){return this.get("size").toBytes()},n.prototype.isImage=function(){return["image/jpeg","image/gif","image/png"].indexOf(this.get("type"))>-1},n.prototype.save=function(e){var t;return e==null&&(e={}),t={data:this.toFormData(),processData:!1,contentType:!1,dataType:!1,xhr:function(){var t,n,r,i,s;r=$.ajaxSettings.xhr(),s=e.uploadEvents||{},i=function(e,t){return r.upload["on"+e]=t};for(t in s)n=s[t],i(t,n);return r}},n.__super__.save.call(this,$.extend(t,e))},n.prototype.toFormData=function(){var e;if(!window.FormData)return;return e=new FormData,e.append(this.config("uploading:saveName"),this.file,this.get("name")),e},n.prototype.saveSuccess=function(){if(!this.get("url"))return this.notify(this.t("Unable to process response: %s","no url"))},n}(Mercury.Model)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Uploader=function(e){function n(e,t){this.options=t!=null?t:{};if(!this.constructor.supported)return this.notify(this.t("Is unsupported in this browser"));n.__super__.constructor.call(this,this.options),this.loaded=0,this.total=0,this.files=[];if(!this.calculate(e||[]).length)return;this.show(),this.delay(500,this.upload)}return t(n,e),n.supported=!!window.FormData&&!!(new XMLHttpRequest).upload,n.logPrefix="Mercury.Uploader:",n.className="mercury-uploader",n.template="uploader",n.elements={status:".mercury-uploader-progress span",details:".mercury-uploader-details",preview:".mercury-uploader-preview b",indicator:".mercury-uploader-indicator div",percent:".mercury-uploader-indicator b"},n.prototype.calculate=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++){t=e[n],t=new Mercury.Model.File(t,{mimeTypes:this.mimeTypes});if(!t.isValid()){alert(this.t("Error uploading %s: %s",t.get("name"),t.errorMessages()));continue}this.files.push(t),this.total+=t.get("size")}return this.files},n.prototype.build=function(){return this.appendTo(Mercury["interface"])},n.prototype.show=function(){var e=this;return this.update(this.t("Processing...")),this.delay(50,function(){return e.css({opacity:1})})},n.prototype.release=function(e){return e==null&&(e=0),this.delay(e,function(){return this.css({opacity:0}),this.delay(250,function(){return n.__super__.release.apply(this,arguments)})})},n.prototype.upload=function(){var e,t=this;if(!this.files.length)return this.release(500);this.file=this.files.shift(),this.update(this.t("Uploading...")),this.loadDetails();if(e=this.file.save({uploadEvents:this.uploadEvents()}))return e.success(function(){return t.success()}),e.error(function(){return t.error()})},n.prototype.update=function(e,t){var n;return t==null&&(t=0),n=Math.floor((this.loaded+t)*100/this.total)+"%",e&&this.$status.html(e),this.$indicator.css({width:n}),this.$percent.html(n)},n.prototype.loadDetails=function(){var e=this;this.$details.html([this.t("Name: %s",this.file.get("name")),this.t("Type: %s",this.file.get("type")),this.t("Size: %s",this.file.readableSize())].join("<br/>"));if(!this.file.isImage())return;return this.file.readAsDataURL(function(t){return e.$preview.html($("<img>",{src:t}))})},n.prototype.success=function(){return this.trigger("uploaded",this.file),this.loaded+=this.file.get("size"),this.update(this.t("Successfully uploaded...")),this.upload()},n.prototype.error=function(){return this.update(this.t("Error: Unable to upload the file")),this.delay(3e3,this.upload)},n.prototype.uploadEvents=function(){var e=this;return{progress:function(t){return e.update(e.t("Uploading..."),t.loaded),e.$percent.show()}}},n}(Mercury.View)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Action.Image=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.name="image",n.prototype.asHtml=function(){return'<img src="'+this.get("url")+'">'},n}(Mercury.Action)}.call(this),function(){Mercury.Region.Modules.ContentEditable={included:function(){return this.on("build",this.buildContentEditable),this.on("preview",this.toggleContentEditable),this.on("release",this.releaseContentEditable)},buildContentEditable:function(){var e;return(e=this.editableDropBehavior)==null&&(this.editableDropBehavior=!0),this.document||(this.document=this.$el.get(0).ownerDocument),this.makeContentEditable(),this.forceContentEditableDisplay(),this.setContentEditablePreferences()},toggleContentEditable:function(){return this.previewing?this.makeNotContentEditable():this.makeContentEditable()},releaseContentEditable:function(){this.makeNotContentEditable();if(this.originalDisplay)return this.css({display:this.originalDisplay})},makeContentEditable:function(){return this.$el.get(0).contentEditable=!0},makeNotContentEditable:function(){return this.$el.get(0).contentEditable=!1},forceContentEditableDisplay:function(){if(this.css("display")==="inline")return this.originalDisplay="inline",this.css({display:"inline-block"})},setContentEditablePreferences:function(){try{return this.document.execCommand("styleWithCSS",!1,!1),this.document.execCommand("insertBROnReturn",!1,!0),this.document.execCommand("enableInlineTableEditing",!1,!1),this.document.execCommand("enableObjectResizing",!1,!1)}catch(e){}},stackEquality:function(e){return this.stackPosition===0&&this.stack[this.stackPosition]?JSON.stringify(this.stack[this.stackPosition].val)===JSON.stringify(e.val):JSON.stringify(this.stack[this.stackPosition])===JSON.stringify(e)}}}.call(this),function(){Mercury.Region.Modules.DropIndicator={included:function(){return this.on("build",this.buildDropIndicator),this.on("release",this.releaseDropIndicator)},buildDropIndicator:function(){return this.$el.after(this.$dropIndicator=$('<div class="mercury-region-drop-indicator"></div>')),this.delegateEvents({dragenter:"showDropIndicator",dragover:"showDropIndicator",dragleave:"hideDropIndicator",drop:"hideDropIndicator"})},releaseDropIndicator:function(){return this.$dropIndicator.remove()},dropIndicatorPosition:function(){var e;return e=this.$el.position(),{top:e.top+this.$el.outerHeight()/2,left:e.left+this.$el.outerWidth()/2,display:"block"}},showDropIndicator:function(){var e=this;clearTimeout(this.dropIndicatorTimeout);if(this.previewing||this.dropIndicatorVisible)return;if(Mercury.dragHack&&!this.onDropSnippet)return;if(!Mercury.dragHack&&!this.onDropItem&&!this.onDropFile)return;return this.dropIndicatorVisible=!0,this.$dropIndicator.css(this.dropIndicatorPosition()),this.$dropIndicator.removeClass("mercury-region-snippet-drop-indicator"),Mercury.dragHack&&this.$dropIndicator.addClass("mercury-region-snippet-drop-indicator"),this.delay(50,function(){return e
.$dropIndicator.css({opacity:1})})},hideDropIndicator:function(){return clearTimeout(this.dropIndicatorTimeout),this.dropIndicatorTimeout=this.delay(250,function(){var e=this;return this.dropIndicatorVisible=!1,this.$dropIndicator.css({opacity:0}),this.dropIndicatorTimeout=this.delay(251,function(){return e.$dropIndicator.hide()})})}}}.call(this),function(){Mercury.Region.Modules.DropItem={onDropItem:function(e,t){var n,r,i;i=this.getActionAndUrlFromData(t),n=i[0],r=i[1];if(!r)return;return this.prevent(e),this.focus(),this.handleAction(n,{url:r})},getActionAndUrlFromData:function(e){var t,n;t="image";if(e.getData("text/html")||Mercury.support.safari&&(e.types||[]).indexOf("image/tiff")===-1)t="link";if(n=$("<div>").html(e.getData("text/html")).find("img").attr("src"))t="image";return[t,n||e.getData("text/uri-list")]}}}.call(this),function(){Mercury.Region.Modules.FocusableTextarea={included:function(){return this.on("build",this.buildFocusable),this.on("action",this.resizeFocusable),this.on("preview",this.toggleFocusablePreview),this.on("release",this.releaseFocusable)},buildFocusable:function(){var e,t,n;return(n=this.editableDropBehavior)==null&&(this.editableDropBehavior=!0),t=this.originalContent(),e=this.options.autoSize?"none":"vertical",this.$preview=$('<div class="mercury-'+this.constructor.type+'-region-preview">'),this.$focusable=$('<textarea class="mercury-'+this.constructor.type+'-region-textarea" placeholder="'+this.placeholder+'">'),this.options.wrapping||this.$focusable.attr({wrap:"off"}),this.$el.empty(),this.append(this.$preview,this.$focusable.css({width:"100%",height:this.$el.height()||this.height||20,resize:e})),this.value(t),this.delay(1,this.resizeFocusable),this.delegateEvents({"keydown textarea":"handleKeyEvent"})},originalContent:function(){return this.html().replace("&gt;",">").replace("&lt;","<").trim()},releaseFocusable:function(){var e;return this.html((e=typeof this.convertedValue==="function"?this.convertedValue():void 0)!=null?e:this.value())},value:function(e){var t;e==null&&(e=null);if(e===null||typeof e=="undefined")return this.$focusable.val();this.$focusable.val((t=e.val)!=null?t:e);if(e.sel)return this.setSerializedSelection(e.sel)},resizeFocusable:function(){var e,t,n;if(!this.options.autoSize)return;return n=this.$focusable.get(0),e=$("body",this.el.ownerDocument),t=e.scrollTop(),this.$focusable.css({height:1}).css({height:n.scrollHeight}),e.scrollTop(t)},toggleFocusablePreview:function(){return this.previewing?(this.$focusable.hide(),this.$preview.html((typeof this.convertedValue=="function"?this.convertedValue():void 0)||this.value()).show()):(this.$preview.hide(),this.$focusable.show())},handleKeyEvent:function(e){if(e.keyCode>=37&&e.keyCode<=40)return;this.delay(1,this.resizeFocusable);if(e.metaKey&&e.keyCode===90)return;e.keyCode===13&&typeof this.onReturnKey=="function"&&this.onReturnKey(e);if(e.metaKey)switch(e.keyCode){case 66:return this.prevent(e),this.handleAction("bold");case 73:return this.prevent(e),this.handleAction("italic");case 85:return this.prevent(e),this.handleAction("underline")}return this.resizeFocusable(),this.pushHistory(e.keyCode)}}}.call(this),function(){Mercury.Region.Modules.HtmlSelection={getSelection:function(){return rangy.getSelection()},getSerializedSelection:function(){return rangy.serializeSelection()},setSerializedSelection:function(e){return rangy.deserializeSelection(e)},toggleWrapSelectedWordsInClass:function(e,t){var n;return t==null&&(t={}),t=$.extend({},{normalize:!0},t,{applyToEditableOnly:!0}),n=rangy.createCssClassApplier(e,t),n.toggleSelection()},replaceSelection:function(e){var t,n,r,i,s;if(typeof e=="string"||e.is)e=this.elementFromValue(e);i=this.getSelection().getAllRanges(),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.deleteContents(),s.push(t.insertNode(e));return s},elementFromValue:function(e){return e.is?e.get(0):$(e).get(0)}}}.call(this),function(){Mercury.Region.Modules.SelectionValue={toStack:function(){return{val:this.toJSON(),sel:typeof this.getSerializedSelection=="function"?this.getSerializedSelection():void 0}},fromStack:function(e){if(!e)return;this.fromJSON(e.val);if(e.sel)return typeof this.setSerializedSelection=="function"?this.setSerializedSelection(e.sel):void 0}}}.call(this),function(){Mercury.Region.Modules.Snippetable={included:function(){return this.on("action",this.restoreSnippets)},restoreSnippets:function(){var e,t,n,r,i;i=this.$("[data-mercury-snippet]");for(n=0,r=i.length;n<r;n++)t=i[n],e=$(t),e.data("snippet")||Mercury.Snippet.find(e.data("mercury-snippet")).replaceWithView(e);return typeof this.onLoadSnippet=="function"?this.onLoadSnippet():void 0},snippets:function(){var e,t,n,r,i,s;n={},s=this.$("[data-mercury-snippet]");for(r=0,i=s.length;r<i;r++)e=s[r],t=Mercury.Snippet.find($(e).data("mercury-snippet")),n[t.cid]=t.toJSON();return n},loadSnippets:function(e){var t,n,r;e==null&&(e={}),this.clearStack(),r=[];for(t in e)n=e[t],r.push(this.loadSnippet(t,n));return r},loadSnippet:function(e,t){var n=this;return Mercury.Snippet.fromSerializedJSON(t).renderAndReplaceWithView(this.$("[data-mercury-snippet="+e+"]"),function(){try{return n.initialValue=JSON.stringify(n.toJSON()),n.pushHistory(),typeof n.onLoadSnippet=="function"?n.onLoadSnippet():void 0}catch(e){}})}}}.call(this),function(){var e=[].slice;Mercury.Region.Modules.TextSelection={getSelection:function(){var e,t,n,r;return e=this.$focusable.get(0),r=e.value,n=e.selectionStart,t=e.selectionEnd,{start:n,end:t,length:t-n,text:r.slice(n,t)}},setSelection:function(e,t,n,r){var i,s,o,u;t==null&&(t=0),n==null&&(n=null),r==null&&(r=!1),o=e.start+t,s=e.end+(n!=null?n:t);if(s<o||typeof s=="undefined"||r)s=o;return i=this.$focusable.get(0),u=i.value,o<0&&(o+=u.length),s<0&&(s+=u.length),i.selectionStart=o,i.selectionEnd=s},getSerializedSelection:function(){return this.getSelection()},setSerializedSelection:function(e){return this.setSelection(e)},isWithinToken:function(e){var t,n,r,i;i=this.getTokenAndSelection(e),n=i[0],r=i[1],t=this.expandSelectionToTokens(r,n);if(t.cleaned)return!0},isWithinLineToken:function(e){var t,n,r,i,s;return s=this.getTokenAndSelection(e),n=s[0],r=s[1],t=this.expandSelectionToLines(r),i=t.text.match(n.regexp),!i||i.length!==2?!1:!0},firstLineMatches:function(e){var t,n;n=this.getSelection(),t=this.expandSelectionToLines(n);if(t.text.match(e))return!0},paragraphMatches:function(e){var t,n;n=this.getSelection(),t=this.expandSelectionToParagraphs(n);if(t.text.match(e))return!0},replaceSelection:function(e){var t,n,r,i;return e==null&&(e=""),n=this.$focusable.get(0),i=n.value,r=this.getSelection(),n.value=[i.slice(0,r.start),e,i.slice(r.end)].join(""),t=r.start+e.length,this.setSelection({start:t,end:t})},replaceSelectedLine:function(e,t){return t==null&&(t=""),this.setSelection(e),this.replaceSelection(t)},setAndReplaceSelection:function(e,t,n,r,i,s){return t==null&&(t=""),this.setSelection(e),this.replaceSelection(t),this.setSelection(n,r,i,s)},replaceSelectionWithParagraph:function(e){var t,n,r,i;return e==null&&(e=""),i=this.value(),n=this.getSelection(),t="\n",i[n.start-1]!=="\n"&&(t+="\n"),n.start||(t=""),r="\n",i[n.end]!=="\n"&&i[n.end+1]!=="\n"&&(r+="\n"),n.end||(r="\n\n"),this.replaceSelection([t,e,r].join(""))},wrapSelected:function(e,t){var n,r,i,s,o,u,a,f;return t==null&&(t={}),u=this.getTokenAndSelection(e),n=u[0],i=u[1],o=[n.pre,i.text||t.text||"",n.suf].join(""),t.select==="end"?(a=[o.length,null],r=a[0],s=a[1]):(f=[0,o.length-i.length],r=f[0],s=f[1]),this.setAndReplaceSelection(i,o,i,r,s,t.select==="end")},unwrapSelected:function(e){var t,n,r,i;return i=this.getTokenAndSelection(e),t=i[0],n=i[1],r=n.text.match(t.regexp),!r||r.length!==2?!1:this.setAndReplaceSelection(n,n.text.replace(t.regexp,""),n,0,-r.join("").length)},toggleWrapSelected:function(e,t){t==null&&(t={});if(!this.unwrapSelected(e))return this.wrapSelected(e,t)},wrapSelectedWords:function(e){var t,n,r,i;return i=this.getTokenAndSelection(e),n=i[0],r=i[1],t=this.expandSelectionToWords(r),this.setAndReplaceSelection(t,[n.pre,t.text,n.suf].join(""),r,n.pre.length)},unwrapSelectedWords:function(e){var t,n,r,i;return i=this.getTokenAndSelection(e),n=i[0],r=i[1],t=this.expandSelectionToTokens(r,n),t.cleaned?this.setAndReplaceSelection(t,t.token,r,-t.match[0].length):!1},toggleWrapSelectedWords:function(e){if(!this.unwrapSelectedWords(e))return this.wrapSelectedWords(e)},wrapSelectedLines:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;p=this.getTokenAndSelection(e),i=p[0],a=p[1],r=this.expandSelectionToLines(a),u=0,f=0,l=[],o=r.start,t=r.text.split("\n");for(c=0,h=t.length;c<h;c++)s=t[c],s.trim()||t.length===1?(u||(u=i.pre.length),f+=i.pre.length,o+=s.length,o<a.end&&(f+=i.suf.length),l.push([i.pre,s,i.suf].join(""))):(n=!0,o+=s.length,l.push(s));return n&&(u=0),this.setAndReplaceSelection(r,l.join("\n"),a,u,f)},unwrapSelectedLines:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;d=this.getTokenAndSelection(e),r=d[0],a=d[1],n=this.expandSelectionToLines(a),o=0,l=0,c=[],s=n.start,t=n.text.split("\n"),u=!0;for(h=0,p=t.length;h<p;h++)i=t[h],f=i.match(r.regexp),f&&f.length===2?(s<=a.start&&(o+=f[0].length),s<a.end&&(l+=f[0].length),s+=i.length,s<=a.start&&(o+=f[1].length),s<a.end&&(l+=f[1].length),c.push(i.replace(r.regexp,""))):(u=!1,s+=i.length,c.push(i));return u||(o=0),this.setAndReplaceSelection(n,c.join("\n"),a,-o,-l),u},wrapSelectedParagraphs:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;t==null&&(t={}),d=this.getTokenAndSelection(e),s=d[0],f=d[1],i=this.expandSelectionToParagraphs(f),a=0,l=0,c=[],u=i.start;if(t.all)a=l+=s.pre.length,c.push([s.pre,i.text,s.suf].join(""));else{n=i.text.split("\n");for(h=0,p=n.length;h<p;h++)o=n[h],o.trim()||n.length===1?(u<=f.start&&(a+=s.pre.length),u<f.end&&(l+=s.pre.length),u+=o.length,u<=f.start&&(a+=s.suf.length),u<f.end&&(l+=s.suf.length),c.push([s.pre,o,s.suf].join(""))):(r=!0,u+=o.length,c.push(o));r&&(a=0)}return this.setAndReplaceSelection(i,c.join("\n"),f,a,l)},unwrapSelectedParagraphs:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v;t==null&&(t={}),d=this.getTokenAndSelection(e),r=d[0],a=d[1],n=this.expandSelectionToParagraphs(a),o=0,l=0,c=[],s=n.start,u=!0;if(t.all)f=n.text.match(r.regexp),f&&f.length===2?(o+=f[0].length,l+=f[1].length,c.push(n.text.replace(r.regexp,""))):c.push(n.text);else{v=n.text.split("\n");for(h=0,p=v.length;h<p;h++)i=v[h],f=i.match(r.regexp),f&&f.length===2?(s<=a.start&&(o+=f[0].length),s<a.end&&(l+=f[0].length),s+=i.length,s<=a.start&&(o+=f[1].length),s<a.end&&(l+=f[1].length),c.push(i.replace(r.regexp,""))):(u=!1,s+=i.length,c.push(i));u||(o=0)}return this.setAndReplaceSelection(n,c.join("\n"),a,-o,-l),u},expandSelectionToWords:function(e){var t,n,r,i,s;s=this.value();if(this.selectionIsEmptyLine(e,s)||this.selectionIsEndOfLine(e,s))return e;r=this.getSelectionStartOfLine(e,s),n=this.getSelectionEndOfLine(e,s),i=s.lastIndexOf(" ",e.start-1),i<r&&(i=r),i>0&&(s[i]===" "||s[i]==="\n")&&(i+=1),t=s.indexOf(" ",e.end);if(t>=n||t===-1)t=n;return{start:i,end:t,text:s.substring(i,t),length:t-i}},expandSelectionToLines:function(e){var t,n,r;return r=this.value(),this.selectionIsEmptyLine(e,r)?e:(n=this.getSelectionStartOfLine(e,r),t=this.getSelectionEndOfLine(e,r),{start:n,end:t,text:r.substring(n,t),length:t-n})},expandSelectionToParagraphs:function(e){var t,n,r;return r=this.value(),this.selectionIsEmptyLine(e,r)?e:(n=r.lastIndexOf("\n\n",e.start-1),n<0&&(n=0),n>0&&(n+=2),n===0&&r[0]==="\n"&&(n+=1),n===1&&r[1]==="\n"&&(n+=1),n>e.start-1&&(n=e.start),t=r.indexOf("\n\n",e.end-1),e.length&&r.substr(e.end-2,2)==="\n\n"&&(t=e.end),t<0&&(t=r.length),{start:n,end:t,text:r.substring(n,t),length:t-n})},expandSelectionToTokens:function(e,t){var n,r,i,s,o,u,a,f,l;f=this.value();if(this.selectionIsEmptyLine(e,f))return e;if(n=this.selectionIsToken(e,f,t))return n;s=this.getSelectionStartOfLine(e,f),i=this.getSelectionEndOfLine(e,f),u=f.lastIndexOf(t.pre,e.start-1),u<s&&(u=s),u>0&&(f[u]===" "||f[u]==="\n")&&(u+=1),r=f.indexOf(t.suf,e.end-1),r>-1&&(r+=t.suf.length);if(r>i||r===-1)r=i;return a=null,l=f.substring(u,r),o=l.match(t.regexp),o&&o.length===2&&(a=l.replace(t.regexp,"")),{start:u,end:r,text:l,length:r-u,cleaned:a!==null,token:a,match:o}},selectionIsToken:function(e,t,n){var r,i,s,o,u;return e.length>0?!1:(s=e.start-n.pre.length,r=e.end+n.suf.length,o=null,u=t.substring(s,r),i=u.match(n.regexp),i&&i.length===2&&(o=u.replace(n.regexp,"")),o===null?!1:{start:s,end:r,text:u,length:r-s,cleaned:!0,token:o,match:i})},getSelectionStartOfLine:function(e,t){var n;return n=e.start,t[n]!=="\n"&&(n=t.lastIndexOf("\n",n)),n===e.start&&(n=t.lastIndexOf("\n",n-1)),n<0&&(n=0),n===0&&t[0]==="\n"&&e.start===0?n=0:t[n]==="\n"&&(n+=1),n},getSelectionEndOfLine:function(e,t){var n;n=e.end;if(e.length===0||t[n]!=="\n"&&t[n-1]!=="\n")n=t.indexOf("\n",n);return n<0&&(n=t.length),n},selectionIsEmptyLine:function(e,t){return e.length<=1&&t.substr(e.start-1,2)==="\n\n"||e.start===0&&t[0]==="\n"},selectionIsEndOfLine:function(e,t){return t[e.start-1]===" "&&(t[e.start]==="\n"||e.start===t.length)},processWrapper:function(){var t,n,r,i,s;return r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],n=this.tokenFromWrapper(r),n.pre=(i=n.pre).printf.apply(i,t[0]),n.suf=(s=n.suf).printf.apply(s,t[1]||t[0]),[n.pre,n.suf]},tokenFromWrapper:function(e){var t,n;return typeof e=="string"&&(e=this.wrappers[e]),t=e[0],n=e[1],n==null&&(n=t),{pre:t,suf:n,regexp:e[2]||new RegExp("^"+t.regExpEscape()+"|"+n.regExpEscape()+"$","gi")}},getTokenAndSelection:function(e){return[this.tokenFromWrapper(e),this.getSelection()]}}}.call(this),function(){var e,t=[].slice;e=function(){var e,n,r,i,s,o,u=this;this.version="2.0.1 pre alpha",this.JST=window.JST||{},this.init=function(e){e==null&&(e={});if(this["interface"])return;return this.trigger("configure"),this["interface"]=new(this[this.config("interface:class")])(e),this.load(this.loadedJSON||{}),this["interface"]},this.load=function(e){e==null&&(e={}),this.loadedJSON=e;if(!this["interface"])return;return this["interface"].load(this.loadedJSON),delete this.loadedJSON},this.release=function(){if(!this["interface"])return;return this.trigger("released"),this["interface"].release(),delete this["interface"],this.off()},this.Module.extend.call(this,this.Config),this.configure=function(){var e,n;return e=1<=arguments.length?t.call(arguments,0):[],this.configuration&&(this.trigger("configure"),(n=this.Config).set.apply(n,e)),this.one("configure",function(){return this.Config.set(e[0],!0,e[1])})},r=["focus","blur","save","initialize","reinitialize","interface:toggle","interface:show","interface:hide"],i=function(e){return u[e.replace("interface:","")]=function(){return this.trigger(e)}};for(s=0,o=r.length;s<o;s++)e=r[s],i(e);this.Module.extend.call(this,this.Events),this.Module.extend.call(this,this.I18n),this.Module.extend.call(this,this.Logger),this.Module.extend.call(this,this.Plugin),this.Module.extend.call(this,this.Snippet),this.support={webkit:navigator.userAgent.indexOf("WebKit")>0,safari:navigator.userAgent.indexOf("Safari")>0&&navigator.userAgent.indexOf("Chrome")===-1,chrome:navigator.userAgent.indexOf("Chrome")>0,gecko:navigator.userAgent.indexOf("Firefox")>0,trident:navigator.userAgent.indexOf("MSIE")>0,ie10:(n=navigator.userAgent.match(/MSIE\s([\d|\.]+)/))?parseFloat(n[1],10)>=10:!1},this.support.wysiwyg=document.designMode&&(!this.support.trident||this.support.ie10)&&window.rangy&&window.rangy.supported;if(this.support.gecko&&parseFloat(navigator.userAgent.match(/Firefox\/([\d|\.]+)/)[1],10)<22)return this.support.wysiwyg=!1},e.call(this.MockMercury||this.Mercury)}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("blocks",{description:"Provides interface for selecting common block elements.",version:"1.0.0",prependButtonAction:"insert",actions:{block:"insert"},config:{blocks:{h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",p:"Paragraph",blockquote:"Blockquote",pre:"Formatted"}},registerButton:function(){return this.button.set({type:"select",subview:this.bindTo(new e.Select)})},bindTo:function(e){var t=this;return e.on("block:picked",function(e){return t.triggerAction(e)})},insert:function(e,t){return Mercury.trigger("action",e,t)}}),e.Select=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="blocks",t.prototype.className="mercury-blocks-select",t.prototype.events={"click [data-value]":function(e){return this.trigger("block:picked",$(e.target).closest("li").data("value"))}},t}(Mercury.ToolbarSelect),JST["/mercury/templates/blocks"]=function(){var t,n;return"<ul>"+function(){var r,i;r=e.config("blocks"),i=[];for(t in r)n=r[t],i.push("<li data-value='"+t+"'><"+t+">"+n+"</"+t+"></li>");return i}().join("")+"</ul>"}}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("character",{description:"Provides interface for selecting and inserting special characters.",version:"1.0.0",actions:{html:"insertHtml",text:"insertText"},config:{modal:!0,characters:"162 8364 163 165 169 174 8482 8240 181 183 8226 8230 8242 8243 167 182 223 8249 8250 171 187 8216 8217 8220 8221 8218 8222 8804 8805 8211 8212 175 8254 164 166 168 161 191 710 732 176 8722 177 247 8260 215 185 178 179 188 189 190 402 8747 8721 8734 8730 8764 8773 8776 8800 8801 8712 8713 8715 8719 8743 8744 172 8745 8746 8706 8704 8707 8709 8711 8727 8733 8736 180 184 170 186 8224 8225 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 216 338 352 217 218 219 220 221 376 222 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 248 339 353 249 250 251 252 253 254 255 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 931 932 933 934 935 936 937 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 8501 982 8476 977 978 8472 8465 8592 8593 8594 8595 8596 8629 8656 8657 8658 8659 8660 8756 8834 8835 8836 8838 8839 8853 8855 8869 8901 8968 8969 8970 8971 9001 9002 9674 9824 9827 9829 9830 x263F"},registerButton:function(){return this.button.set({type:"character",subview:this.bindTo(this.view())})},view:function(){return this.config("modal")?new e.Modal:new e.Palette},bindTo:function(e){var t=this;return e.on("character:picked",function(e){return t.triggerAction(e)})},insertHtml:function(e,t){return Mercury.trigger("action","html","&#"+t+";")},insertText:function(e,t){return Mercury.trigger("action","text",$("<em>&#"+t+";</em>").html())}}),e.Modal=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="character",t.prototype.className="mercury-character-modal",t.prototype.title="Character Picker",t.prototype.hidden=!0,t.prototype.events={"click li":function(e){return this.trigger("character:picked",$(e.target).data("value"))&&this.hide()}},t}(Mercury.Modal),e.Palette=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="character",t.prototype.className="mercury-character-palette",t.prototype.hidden=!0,t.prototype.events={"click li":function(e){return this.trigger("character:picked",$(e.target).data("value"))}},t}(Mercury.ToolbarPalette),JST["/mercury/templates/character"]=function(){var t;return"<ul>"+function(){var n,r,i,s;i=e.config("characters").split(" "),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push("<li data-value='"+t+"'>&#"+t+";</li>");return s}().join("")+"</ul>"}}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("color",{description:"Provides interface for selecting colors.",version:"1.0.0",prependButtonAction:"insert",actions:{color:"insert",html:"insert",text:"insert"},config:{colors:"FFFFFF FFCCCC FFCC99 FFFF99 FFFFCC 99FF99 99FFFF CCFFFF CCCCFF FFCCFF CCCCCC FF6666 FF9966 FFFF66 FFFF33 66FF99 33FFFF 66FFFF 9999FF FF99FF C0C0C0 FF0000 FF9900 FFCC66 FFFF00 33FF33 66CCCC 33CCFF 6666CC CC66CC 999999 CC0000 FF6600 FFCC33 FFCC00 33CC00 00CCCC 3366FF 6633FF CC33CC 666666 990000 CC6600 CC9933 999900 009900 339999 3333FF 6600CC 993399 333333 660000 993300 996633 666600 006600 336666 000099 333399 663366 000000 330000 663300 663333 333300 003300 003333 000066 330099 330033"},registerButton:function(){return this.button.set({type:"color",subview:this.bindTo(new e.Palette)})},bindTo:function(e){var t=this;return e.on("color:picked",function(e){return t.triggerAction(e),t.button.css({color:"#"+e})})},regionContext:function(){var e;if(e=this.region.hasContext(this.context,!0)||this.region.hasContext("color",!0))return this.button.css({color:e})},insert:function(e,t){return Mercury.trigger("action",e,"#"+t)}}),e.Palette=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="color",t.prototype.className="mercury-color-palette",t.prototype.events={"click li":function(e){var t;return t=$(e.target).data("value"),this.$(".last-picked").data({value:t}).css({background:"#"+t}),this.trigger("color:picked",t)}},t}(Mercury.ToolbarPalette),JST["/mercury/templates/color"]=function(){var t;return"<ul>\n  "+function(){var n,r,i,s;i=e.config("colors").split(" "),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push("<li data-value='"+t+"' style='background:#"+t+"'></li>");return s}().join("")+'\n  <li class="last-picked">Last Color Picked</li>\n</ul>'}}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("history",{description:"Provides interface for selecting saved versions -- requires server implementation.",version:"1.0.0",registerButton:function(){return this.button.set({type:"history",global:!0,toggle:!0,subview:new e.Panel})}}),e.Panel=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="history",t.prototype.className="mercury-history-panel",t.prototype.title="Page Version History",t.prototype.width=250,t.prototype.hidden=!0,t}(Mercury.Panel),JST["/mercury/templates/history"]||(JST["/mercury/templates/history"]=function(){return'<input type="text" class="search-input"/>\n<p>The History Plugin expects a server implementation.</p>\n<p>Since this is a demo, it wasn\'t included, but you can check the <a href="https://github.com/jejacks0n/mercury-rails">mercury-rails project</a> on github for examples of how to integrate it with your server technology.</p>'})}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("link",{description:"Provides interface for inserting and editing links.",version:"1.0.0",actions:{link:"insert"},events:{"mercury:edit:link":"onButtonClick"},registerButton:function(){return this.button.set({type:"link"})},onButtonClick:function(){return this.bindTo(new e.Modal)},bindTo:function(e){var t=this;return e.on("form:submitted",function(e){return t.triggerAction(e)})},insert:function(e,t){return Mercury.trigger("action","link",t)}}),e.Modal=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="link",t.prototype.className="mercury-link-modal",t.prototype.title="Link Manager",t.prototype.width=600,t.prototype.elements={text:"#link_text",target:"#link_target"},t.prototype.events={"change .control-label input":"onLabelChecked","focus .controls [name]":"onInputFocused","change #link_target":"onChangeTarget"},t.prototype.onLabelChecked=function(e){var t,n;return t=$(e.target),n=t.closest(".control-label").attr("for"),t.closest(".control-group").find("#"+n).focus()},t.prototype.onInputFocused=function(e){var t;return t=$(e.target),t.closest(".control-group").find("input[type=radio]").prop("checked",!0)},t.prototype.onChangeTarget=function(e){var t;return t=$(e.target),this.$(".link-target-options").hide(),this.$("#"+t.val()+"_options").show(),this.resize(!1)},t.prototype.validate=function(){var e;return t.__super__.validate.apply(this,arguments),e=this.$("#link_"+this.$("input[name=link_type]:checked").val()),e.val()||this.addInputError(e,this.t("can't be blank")),this.$text.is(":visible")&&!this.$text.val().trim()&&this.addInputError(this.$text,this.t("can't be blank")),this.resize(!1)},t.prototype.onSubmit=function(){var e,t,n,r,i;this.validate(),n=this.$text.val(),r=this.$target.val(),i=this.$("input[name=link_type]:checked").val();switch(i){case"existing_bookmark":t={url:"#"+this.$("#link_existing_bookmark").val()};break;case"new_bookmark":t={name:""+this.$("#link_new_bookmark").val()};break;default:t={url:this.$("#link_"+i).val()}}switch(r){case"popup":e={width:parseInt(this.$("#link_popup_width").val(),10)||500,height:parseInt(this.$("#link_popup_height").val(),10)||500,menubar:"no",toolbar:"no"},t.url="javascript:void(window.open('"+t.url+"','popup_window','"+Object.toParams(e).replace(/&/g,",")+"'))";break;default:r&&(t.target=r)}return t.text=this.content||n,this.trigger("form:submitted",t),this.hide()},t}(Mercury.Modal),JST["/mercury/templates/link"]||(JST["/mercury/templates/link"]=function(){return'<form class="form-horizontal">\n\n  <fieldset class="link_text_container">\n    <div class="control-group string required">\n      <label class="string required control-label" for="link_text">Link Content</label>\n      <div class="controls">\n        <input class="string required" id="link_text" name="link[text]" size="50" type="text" tabindex="1">\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Standard Links</legend>\n    <div class="control-group url optional">\n      <label class="url optional control-label" for="link_external_url">\n        <input name="link_type" type="radio" value="external_url" checked="checked" tabindex="-1"/>URL\n      </label>\n      <div class="controls">\n        <input class="string url optional" id="link_external_url" name="link[external_url]" size="50" type="text" tabindex="1">\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Index / Bookmark Links</legend>\n    <div class="control-group select optional">\n      <label class="select optional control-label" for="link_existing_bookmark">\n        <input name="link_type" type="radio" value="existing_bookmark" tabindex="-1"/>Existing Links\n      </label>\n      <div class="controls">\n        <select class="select optional" id="link_existing_bookmark" name="link[existing_bookmark]" tabindex="1"></select>\n      </div>\n    </div>\n    <div class="control-group string optional">\n      <label class="string optional control-label" for="link_new_bookmark">\n        <input name="link_type" type="radio" value="new_bookmark" tabindex="-1"/>Bookmark\n      </label>\n      <div class="controls">\n        <input class="string optional" id="link_new_bookmark" name="link[new_bookmark]" type="text" tabindex="1">\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Options</legend>\n    <div class="control-group select optional">\n      <label class="select optional control-label" for="link_target">Link Target</label>\n      <div class="controls">\n        <select class="select optional" id="link_target" name="link[target]" tabindex="1">\n          <option value="">Self (the same window or tab)</option>\n          <option value="_blank">Blank (a new window or tab)</option>\n          <option value="_top">Top (removes any frames)</option>\n          <option value="popup">Popup Window (javascript new window popup)</option>\n        </select>\n      </div>\n    </div>\n    <div id="popup_options" class="link-target-options" style="display:none">\n      <div class="control-group number optional">\n        <label class="number optional control-label" for="link_popup_width">Popup Width</label>\n        <div class="controls">\n          <input class="number optional" id="link_popup_width" name="link[popup_width]" type="number" value="960" tabindex="1">\n        </div>\n      </div>\n      <div class="control-group number optional">\n        <label class="number optional control-label" for="link_popup_height">Popup Height</label>\n        <div class="controls">\n          <input class="number optional" id="link_popup_height" name="link[popup_height]" type="number" value="800" tabindex="1">\n        </div>\n      </div>\n    </div>\n  </fieldset>\n\n  <div class="form-actions">\n    <input class="btn btn-primary" name="commit" type="submit" value="Insert Link" tabindex="2">\n  </div>\n</form>'})}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("media",{description:"Provides interface for inserting and editing media.",version:"1.0.0",actions:{image:"insertImage",html:"insertHtml"},events:{"mercury:edit:media":"onButtonClick"},registerButton:function(){return this.button.set({type:"media"})},onButtonClick:function(){return this.bindTo(new e.Modal)},bindTo:function(e){var t=this;return e.on("form:submitted",function(e){return t.triggerAction(e)})},insertImage:function(e,t){return t.type!=="image"?this.insertHtml(e,t):Mercury.trigger("action",e,t)},insertHtml:function(e,t){return t.type==="image"?t='<img src="'+t.src+'"/>':t='<iframe src="'+t.src+'" width="'+t.width+'" height="'+t.height+'" frameborder="0" allowFullScreen></iframe>',Mercury.trigger("action","html",t)}}),e.Modal=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="media",t.prototype.className="mercury-media-modal",t.prototype.title="Media Manager",t.prototype.width=600,t.prototype.events={"change .control-label input":"onLabelChecked","focus .controls [name]":"onInputFocused"},t.prototype.onLabelChecked=function(e){var t,n;return t=$(e.target),n=t.closest(".control-label").attr("for"),t.closest(".control-group").find("#"+n).focus()},t.prototype.onInputFocused=function(e){var t;t=$(e.target),t.closest(".control-group").find("input[type=radio]").prop("checked",!0);if(t.closest(".media-options").length)return;return this.$(".media-options").hide(),this.$("#"+t.attr("id").replace("media_","")+"_options").show(),this.resize(!0)},t.prototype.validate=function(){var e,n;t.__super__.validate.apply(this,arguments),n=this.$("input[name=media_type]:checked").val(),e=this.$("#media_"+n);if(e.val())switch(n){case"youtube_url":/^https?:\/\/youtu.be\//.test(e.val())||this.addInputError(e,this.t("Is invalid"));break;case"vimeo_url":/^https?:\/\/youtu.be\//.test(e.val())||this.addInputError(e,this.t("Is invalid"))}else this.addInputError(e,this.t("Can't be blank"));return this.resize(!1)},t.prototype.onSubmit=function(){var e,t,n,r;this.validate(),n=this.$("input[name=media_type]:checked").val(),e=this.$("#media_"+n),r=e.val();switch(n){case"youtube_url":t={type:"youtube",protocol:/^https:/.test(r)?"https":"http",width:parseInt(this.$("#media_youtube_width").val(),10)||560,height:parseInt(this.$("#media_youtube_height").val(),10)||349,share:r,code:r.replace(/^https?:\/\/youtu.be\//,"")},t.src=""+t.protocol+"://www.youtube-nocookie.com/embed/"+t.code+"?rel=0&wmode=transparent";break;case"vimeo_url":t={type:"vimeo",protocol:/^https:/.test(r)?"https":"http",width:parseInt(this.$("#media_vimeo_width").val(),10)||400,height:parseInt(this.$("#media_vimeo_height").val(),10)||225,share:r,code:r.replace(/^https?:\/\/vimeo.com\//,"")},t.src=""+t.protocol+"://player.vimeo.com/video/"+t.code+"?title=1&byline=1&portrait=0&color=ffffff";break;default:t={type:"image",protocol:/^https:/.test(r)?"https":"http",src:r,url:r,align:this.$("#media_image_alignment").val(),"float":this.$("#media_image_float").val()}}return this.trigger("form:submitted",t),this.hide()},t}(Mercury.Modal),JST["/mercury/templates/media"]||(JST["/mercury/templates/media"]=function(){return'<form class="form-horizontal">\n\n  <fieldset>\n    <legend>Images</legend>\n    <div class="control-group url optional">\n      <label class="url optional control-label" for="media_image_url">\n        <input name="media_type" type="radio" value="image_url" checked="checked" tabindex="-1"/>URL\n      </label>\n      <div class="controls">\n        <input class="string url optional" id="media_image_url" name="media[image_url]" size="50" type="text" tabindex="1">\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Videos</legend>\n    <div class="control-group url optional">\n      <label class="url optional control-label" for="media_youtube_url">\n        <input name="media_type" type="radio" value="youtube_url" tabindex="-1"/>YouTube URL\n      </label>\n      <div class="controls">\n        <input class="string url optional" id="media_youtube_url" name="media[youtube_url]" size="50" type="text" placeholder="http://youtu.be/28tZ-S1LFok" tabindex="1">\n      </div>\n    </div>\n    <div class="control-group url optional">\n      <label class="url optional control-label" for="media_vimeo_url">\n        <input name="media_type" type="radio" value="vimeo_url" tabindex="-1"/>Vimeo URL\n      </label>\n      <div class="controls">\n        <input class="string url optional" id="media_vimeo_url" name="media[vimeo_url]" size="50" type="text" placeholder="http://vimeo.com/36684976" tabindex="1">\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Options</legend>\n\n    <div class="media-options" id="image_url_options">\n      <div class="control-group select optional">\n        <label class="select optional control-label" for="media_image_alignment">Alignment</label>\n        <div class="controls">\n          <select class="select optional" id="media_image_alignment" name="media[image_alignment]" tabindex="1">\n            <option value="">None</option>\n            <option value="left">Left</option>\n            <option value="right">Right</option>\n            <option value="top">Top</option>\n            <option value="middle">Middle</option>\n            <option value="bottom">Bottom</option>\n            <option value="absmiddle">Absolute Middle</option>\n            <option value="absbottom">Absolute Bottom</option>\n          </select>\n        </div>\n      </div>\n      <div class="control-group select optional">\n        <label class="select optional control-label" for="media_image_float">Float</label>\n        <div class="controls">\n          <select class="select optional" id="media_image_float" name="media[image_float]" tabindex="1">\n            <option value="">None</option>\n            <option value="left">Left</option>\n            <option value="right">Right</option>\n            <option value="inherit">Inherit</option>\n          </select>\n        </div>\n      </div>\n    </div>\n\n    <div class="media-options" id="youtube_url_options" style="display:none">\n      <div class="control-group number optional">\n        <label class="number optional control-label" for="media_youtube_width">Width</label>\n        <div class="controls">\n          <input class="number optional" id="media_youtube_width" name="media[youtube_width]" size="50" type="number" value="560" tabindex="1">\n        </div>\n      </div>\n      <div class="control-group number optional">\n        <label class="number optional control-label" for="media_youtube_height">Height</label>\n        <div class="controls">\n          <input class="number optional" id="media_youtube_height" name="media[youtube_height]" size="50" type="number" value="349" tabindex="1">\n        </div>\n      </div>\n    </div>\n\n    <div class="media-options" id="vimeo_url_options" style="display:none">\n      <div class="control-group number optional">\n        <label class="number optional control-label" for="media_vimeo_width">Width</label>\n        <div class="controls">\n          <input class="number optional" id="media_vimeo_width" name="media[vimeo_width]" size="50" type="number" value="400" tabindex="1">\n        </div>\n      </div>\n      <div class="control-group number optional">\n        <label class="number optional control-label" for="media_vimeo_height">Height</label>\n        <div class="controls">\n          <input class="number optional" id="media_vimeo_height" name="media[vimeo_height]" size="50" type="number" value="225" tabindex="1">\n        </div>\n      </div>\n    </div>\n  </fieldset>\n\n  <div class="form-actions">\n    <input class="btn btn-primary" name="commit" type="submit" value="Insert Media" tabindex="2"/>\n  </div>\n</form>'
})}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("notes",{description:"Provides interface for reading and adding notes for the page -- requires server implementation.",version:"1.0.0",registerButton:function(){return this.button.set({type:"notes",global:!0,toggle:!0,subview:new e.Panel})}}),e.Panel=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="notes",t.prototype.className="mercury-notes-panel",t.prototype.title="Page Notes",t.prototype.width=250,t.prototype.hidden=!0,t}(Mercury.Panel),JST["/mercury/templates/notes"]=function(){return'<p>The Notes Plugin expects a server implementation.</p>\n<p>Since this is a demo, it wasn\'t included, but you can check the <a href="https://github.com/jejacks0n/mercury-rails">mercury-rails project</a> on github for examples of how to integrate it with your server technology.</p>'}}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("snippets",{description:"Provides interface for adding snippets to various regions -- may require server implementation.",version:"1.0.0",config:{toggleOnSnippetRegion:!1},actions:{snippet:"insert"},registerButton:function(){return this.button.set({type:"snippets",global:!0,toggle:!0,subview:this.bindTo(this.panel=new e.Panel)})},bindTo:function(e){var t=this;return e.on("insert:snippet",function(e){return t.triggerAction(e)})},insert:function(e,t){var n;return n=Mercury.getSnippet(t,!0).on("rendered",function(t){return Mercury.trigger("action",e,n,t)}),n.initialize(this.region)},onRegionFocus:function(e){this.region=e;if(!this.config("toggleOnSnippetRegion"))return;if(this.region===this.lastRegion)return;return this.lastRegion=this.region,this.togglePanelByRegion()},togglePanelByRegion:function(){if(!this.panel)return;if(this.region.type()==="snippet")return this.panel.visible||(this.shownByRegion=!0),this.panel.show();if(this.shownByRegion)return this.panel.hide(),this.shownByRegion=!1}}),e.Panel=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="snippets",t.prototype.className="mercury-snippets-panel",t.prototype.title="Snippets Panel",t.prototype.width=300,t.prototype.hidden=!0,t.prototype.events={"click input":function(e){return this.trigger("insert:snippet",$(e.target).closest("[data-value]").data("value"))},mousedown:function(){return this.revertInterfaceFocus(),Mercury.trigger("dialogs:hide")}},t.prototype.update=function(){var e;return t.__super__.update.apply(this,arguments),e=this.$("li"),e.on("dragend",function(){return Mercury.dragHack=!1}).on("dragstart",function(e){return Mercury.dragHack=!0,e.originalEvent.dataTransfer.setData("snippet",$(e.target).data("value"))})},t}(Mercury.Panel),JST["/mercury/templates/snippets"]=function(){var e,t,n,r,i;e='<div class="mercury-snippet-actions">Drag or <input type="button" value="Insert" class="btn"></div>',n="<ul>",i=Mercury.Snippet.all();for(t in i)r=i[t],n+='<li data-value="'+t+'">'+r.title+"<em>"+r.description+"</em>"+e+"</li>";return n+"</ul>"}}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("styles",{description:"Provides interface for selecting predefined styles / classes.",version:"1.0.0",prependButtonAction:"insert",actions:{style:"insert",text:"insert"},config:{styles:{red:"Red Text",blue:"Blue Text",highlight:"Highlighted"}},registerButton:function(){return this.button.set({type:"select",subview:this.bindTo(new e.Select)})},bindTo:function(e){var t=this;return e.on("style:picked",function(e){return t.triggerAction(e)})},insert:function(e,t){return Mercury.trigger("action",e,""+t)}}),e.Select=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="styles",t.prototype.className="mercury-styles-select",t.prototype.events={"click li":function(e){return this.trigger("style:picked",$(e.target).data("value"))}},t}(Mercury.ToolbarSelect),JST["/mercury/templates/styles"]=function(){var t,n;return"<ul>"+function(){var r,i;r=e.config("styles"),i=[];for(t in r)n=r[t],i.push("<li data-value='"+t+"' class='"+t+"'>"+n+"</li>");return i}().join("")+"</ul>"}}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=Mercury.registerPlugin("table",{description:"Provides interface for inserting and editing tables.",version:"1.0.0",actions:{html:"insert"},events:{"mercury:edit:table":"onButtonClick"},registerButton:function(){return this.button.set({type:"table"})},onButtonClick:function(){return this.bindTo(new e.Modal)},bindTo:function(e){var t=this;return e.on("form:submitted",function(e){return t.triggerAction(e)})},insert:function(e,t){return Mercury.trigger("action",e,t)}}),e.Modal=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype.template="table",t.prototype.className="mercury-table-modal",t.prototype.title="Table Manager",t.prototype.width=600,t.prototype.elements={table:"table"},t.prototype.events={"click table":"onCellClick","click [data-action]":"onActionClick"},t.prototype.update=function(){return t.__super__.update.apply(this,arguments),this.editor=new Mercury.TableEditor(this.$table,"&nbsp;")},t.prototype.onCellClick=function(e){return this.editor.setCell($(e.target))},t.prototype.onActionClick=function(e){return this.prevent(e),this.editor[$(e.target).closest("[data-action]").data("action")]()},t.prototype.onSubmit=function(){return this.trigger("form:submitted",this.editor.asHtml("<br/>")),this.hide()},t}(Mercury.Modal),JST["/mercury/templates/table"]||(JST["/mercury/templates/table"]=function(){return'<form class="form-horizontal">\n\n  <fieldset class="table-control">\n    <table>\n      <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>\n      <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>\n      <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>\n    </table>\n  </fieldset>\n\n  <fieldset>\n    <div class="control-group buttons optional">\n      <label class="buttons optional control-label">Rows</label>\n      <div class="controls btn-group">\n        <button class="btn" data-action="addRowBefore">Before</button>\n        <button class="btn" data-action="addRowAfter">After</button>\n        <button class="btn" data-action="removeRow">Remove</button>\n      </div>\n    </div>\n    <div class="control-group buttons optional">\n      <label class="buttons optional control-label">Columns</label>\n      <div class="controls btn-group">\n        <button class="btn" data-action="addColumnBefore">Before</button>\n        <button class="btn" data-action="addColumnAfter">After</button>\n        <button class="btn" data-action="removeColumn">Remove</button>\n      </div>\n    </div>\n\n    <hr/>\n\n    <div class="control-group buttons optional">\n      <label class="buttons optional control-label">Row Span</label>\n      <div class="controls btn-group">\n        <button class="btn" data-action="increaseRowspan">+</button>\n        <button class="btn" data-action="decreaseRowspan">-</button>\n      </div>\n    </div>\n    <div class="control-group buttons optional">\n      <label class="buttons optional control-label">Column Span</label>\n      <div class="controls btn-group">\n        <button class="btn" data-action="increaseColspan">+</button>\n        <button class="btn" data-action="decreaseColspan">-</button>\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Options</legend>\n    <div class="control-group select optional">\n      <label class="select optional control-label" for="table_alignment">Alignment</label>\n      <div class="controls">\n        <select class="select optional" id="table_alignment" name="table[align]">\n          <option value="">None</option>\n          <option value="right">Right</option>\n          <option value="left">Left</option>\n        </select>\n      </div>\n    </div>\n  </fieldset>\n\n  <div class="form-actions">\n    <input class="btn btn-primary" name="commit" type="submit" value="Insert Table"/>\n  </div>\n</form>'})}.call(this);