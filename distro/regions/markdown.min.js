/*!
The Markdown region utilizes the Markdown syntax (http://en.wikipedia.org/wiki/Markdown) to generate an html preview.
When saved this region will return the markdown content (unprocessed). This content can be used by your server to render
html content to a user, or to serve the markdown when editing. The default converter uses Github Flavored Markdown, so
your server should also implement the same thing.

Dependencies:
  marked - https://github.com/chjj/marked

This is still experimental and could be changed later to provide a way to fetch the markdown content for a given region
via Ajax.
*/
(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Mercury.Region.Markdown=function(e){function n(e,t){var r;this.el=e,this.options=t!=null?t:{},this.converter=(r=this.options.converter)!=null?r:window.marked;if(!this.converter)return this.notify(this.t("requires a markdown converter")),!1;this.setupConverter(),n.__super__.constructor.apply(this,arguments)}return t(n,e),n.define("Mercury.Region.Markdown","markdown"),n.include(Mercury.Region.Modules.DropIndicator),n.include(Mercury.Region.Modules.DropItem),n.include(Mercury.Region.Modules.SelectionValue),n.include(Mercury.Region.Modules.FocusableTextarea),n.include(Mercury.Region.Modules.TextSelection),n.supported=!0,n.prototype.wrappers={h1:["# "," #"],h2:["## "," ##"],h3:["### "," ###"],h4:["#### "," ####"],h5:["##### "," #####"],h6:["###### "," ######"],pre:["```\n","\n```"],indentPre:["    ",""],blockquote:["> ",""],paragraph:["\n","\n"],bold:["**"],italic:["_"],underline:["<u>","</u>"],strike:["<del>","</del>"],superscript:["<sup>","</sup>"],subscript:["<sub>","</sub>"],unorderedList:["- ",""],orderedList:["1. ","",/^\d+. |$/gi],link:["[","](%s)",/^\[|\]\([^)]\)/gi],image:["![","](%s)",/^!\[|\]\([^)]\)/gi],style:['<span style="%s">',"</span>",/^(<span style="[^"]*">)|(<\/span>)$/gi],"class":['<span class="%s">',"</span>",/^(<span class="[^"]*">)|(<\/span>)$/gi]},n.prototype.blocks=["h1","h2","h3","h4","h5","h6","blockquote","unorderedList","orderedList"],n.prototype.setupConverter=function(){return this.converter.setOptions(this.config("regions:markdown")||{})},n.prototype.convertedValue=function(){return this.converter(this.value())},n.prototype.toJSON=function(e){var t;return e==null&&(e=!1),t=n.__super__.toJSON.apply(this,arguments),e?(t.converted=this.convertedValue(),t):t},n.prototype.onDropFile=function(e){var t,n=this;return t=new(Mercury[this.config("interface:uploader")])(e,{mimeTypes:this.config("regions:markdown:mimeTypes")}),t.on("uploaded",function(e){return n.focus(),n.handleAction("file",e)})},n.prototype.onReturnKey=function(e){var t,n,r,i;t=this.expandSelectionToLines(this.getSelection()),i=t.text;if(i.match(/^- /))return this.prevent(e),i.match(/^- ./)?this.replaceSelection("\n- "):this.replaceSelectedLine(t,"\n");if(n=i.match(/^(\d+)\. /))return this.prevent(e),r=parseInt(n[1],10)+1,i.match(/^\d+\. ./)?this.replaceSelection("\n"+r+". "):this.replaceSelectedLine(t,"\n");if(n=i.match(/^(> )+/g))return this.prevent(e),i.match(/^(> )+./g)?this.replaceSelection("\n"+n[0]):this.replaceSelectedLine(t,"\n");if(n=i.match(/^\s{4}/g))return this.prevent(e),i.match(/^\s{4}./)?this.replaceSelection("\n    "):this.replaceSelectedLine(t,"\n")},n}(Mercury.Region),Mercury.Region.Markdown.addToolbar({defined:{style:["Style",{plugin:"styles"}]},headings:{h1:["Heading 1",{action:["block","h1"]}],h2:["Heading 2",{action:["block","h2"]}],h3:["Heading 3",{action:["block","h3"]}],h4:["Heading 4",{action:["block","h4"]}],h5:["Heading 5",{action:["block","h5"]}],h6:["Heading 6",{action:["block","h6"]}],removeHeading:["No Heading",{action:["block",null]}]},blocks:{unorderedList:["Unordered List"],orderedList:["Numbered List"],blockquote:["Blockquote",{action:["block","blockquote"]}],sep:" ",pre:["Pre / Code",{action:["block","pre"]}]},decoration:{bold:["Bold"],italic:["Italicize"],strike:["Strikethrough"],underline:["Underline"]},script:{subscript:["Subscript"],superscript:["Superscript"]},indent:{indent:["Increase Indentation"],outdent:["Decrease Indentation"]},rules:{rule:["Horizontal Rule",{title:"Insert a horizontal rule"}]}}),Mercury.Region.Markdown.addAction({bold:function(){return this.toggleWrapSelectedWords("bold")},italic:function(){return this.toggleWrapSelectedWords("italic")},underline:function(){return this.toggleWrapSelectedWords("underline")},strike:function(){return this.toggleWrapSelectedWords("strike")},subscript:function(){return this.toggleWrapSelectedWords("subscript")},superscript:function(){return this.toggleWrapSelectedWords("superscript")},rule:function(){return this.replaceSelectionWithParagraph("- - -")},indent:function(){return this.wrapSelectedParagraphs("blockquote")},outdent:function(){return this.unwrapSelectedParagraphs("blockquote")},orderedList:function(){var e,t,n,r;r=["blockquote","unorderedList"];for(t=0,n=r.length;t<n;t++)e=r[t],this.unwrapSelectedParagraphs(e);if(!this.unwrapSelectedParagraphs("orderedList"))return this.wrapSelectedParagraphs("orderedList")},unorderedList:function(){var e,t,n,r;r=["blockquote","orderedList"];for(t=0,n=r.length;t<n;t++)e=r[t],this.unwrapSelectedParagraphs(e);if(!this.unwrapSelectedParagraphs("unorderedList"))return this.wrapSelectedParagraphs("unorderedList")},style:function(e){var t;return t=(e||"").indexOf(":")>-1?"style":"class",this.unwrapSelectedWords(t==="style"?"class":"style"),this.toggleWrapSelectedWords(this.processWrapper(t,[e]))},html:function(e){return this.replaceSelection(e=(e.get&&e.get(0)||e).outerHTML||e)},block:function(e){var t,n,r,i,s,o,u;if(e==="blockquote"){o=["orderedList","unorderedList"];for(n=0,i=o.length;n<i;n++)t=o[n],this.unwrapSelectedParagraphs(t);this.unwrapSelectedParagraphs("blockquote")||this.handleAction("indent");return}if(e==="pre"||e==="paragraph"){this.unwrapSelectedParagraphs("pre",{all:!0});if(this.wrappers[e])return this.wrapSelectedParagraphs(e,{all:!0})}u=this.blocks;for(r=0,s=u.length;r<s;r++)t=u[r],this.unwrapSelectedLines(t);if(this.wrappers[e])return this.wrapSelectedLines(e)},character:function(e){return this.handleAction("html",e)},table:function(e){return this.handleAction("html",e.get("html"))},file:function(e){var t;return t=e.isImage()?"image":"link",this.handleAction(t,{url:e.get("url"),text:e.get("name")})},link:function(e){var t;return t=e.get("text"),this.wrapSelected(this.processWrapper("link",[e.get("url"),t]),{text:t,select:"end"})},image:function(e){var t;return t=e.get("text"),this.wrapSelected(this.processWrapper("image",[e.get("url"),t]),{text:t,select:"end"})}}),Mercury.Region.Markdown.addContext({h1:function(){return this.isWithinLineToken("h1")},h2:function(){return this.isWithinLineToken("h2")},h3:function(){return this.isWithinLineToken("h3")},h4:function(){return this.isWithinLineToken("h4")},h5:function(){return this.isWithinLineToken("h5")},h6:function(){return this.isWithinLineToken("h6")},blockquote:function(){return this.firstLineMatches(/^> /)},pre:function(){return this.paragraphMatches(/^```|```$/)||this.firstLineMatches(/^(> )*\s{4}/)},bold:function(){return this.isWithinToken("bold")},italic:function(){return this.isWithinToken("italic")},underline:function(){return this.isWithinToken("underline")},strike:function(){return this.isWithinToken("strike")},subscript:function(){return this.isWithinToken("subscript")},superscript:function(){return this.isWithinToken("superscript")},unorderedList:function(){return this.firstLineMatches(/^(> )*- /)},orderedList:function(){return this.firstLineMatches(/^(> )*\d+\./)}})}).call(this);