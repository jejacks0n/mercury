<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Mercury Editor - Annotated Source - table_editor.js.coffee</title>
  <link href="/mercury/assets/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css"/>
  <script src="/mercury/assets/javascripts/application.js" type="text/javascript"></script>
  <!--[if lt IE 7]>
    <script type="text/javascript" src="/mercury/assets/javascripts/unitpngfix.js"></script>
  <![endif]-->
</head>
<body>

  <div id="background"></div>

  <h1 id="logo"><a href="/mercury">Mercury Editor</a></h1>

  <ul id="navigation">
    <li><a href="/mercury">Home</a></li>
    <li><a href="/mercury/downloads">Downloads</a></li>
    <li><a href="/mercury/walkthrough">Walkthrough</a></li>
    <li><a href="/mercury/documentation">Documentation</a></li>
    <li class="active"><a href="/mercury/annotated_source">Annotated Source</a></li>
  </ul>

  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>table_editor.js.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="vi">@Mercury.tableEditor = </span><span class="nf">(table, cell, cellContent) -&gt;</span>
  <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">cell</span><span class="p">,</span> <span class="nx">cellContent</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span>

<span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">,</span>

  <span class="nv">load: </span><span class="nf">(@table, @cell, @cellContent = &#39;&#39;) -&gt;</span>
    <span class="vi">@row = </span><span class="nx">@cell</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
    <span class="vi">@columnCount = </span><span class="nx">@getColumnCount</span><span class="p">()</span>
    <span class="vi">@rowCount = </span><span class="nx">@getRowCount</span><span class="p">()</span>


  <span class="nv">addColumn: </span><span class="nf">(position = &#39;after&#39;) -&gt;</span>
    <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@table</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
      <span class="nv">rowSpan = </span><span class="mi">1</span>
      <span class="nv">matchOptions = </span><span class="k">if</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span> <span class="k">then</span> <span class="p">{</span><span class="nv">right: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">right</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="nv">left: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">left</span><span class="p">}</span>
      <span class="k">if</span> <span class="nv">matching = </span><span class="nx">@findCellByOptionsFor</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">matchOptions</span><span class="p">)</span>
        <span class="nv">newCell = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{matching.cell.get(0).tagName}&gt;&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@cellContent</span><span class="p">)</span>
        <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">newCell</span><span class="p">,</span> <span class="nx">matching</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span> <span class="k">then</span> <span class="nx">matching</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span> <span class="k">else</span> <span class="nx">matching</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span>
        <span class="nx">i</span> <span class="o">+=</span> <span class="nx">matching</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nv">intersecting = </span><span class="nx">@findCellByIntersectionFor</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">sig</span><span class="p">)</span>
        <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">intersecting</span><span class="p">.</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">intersecting</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


  <span class="nv">removeColumn: </span><span class="o">-&gt;</span>
    <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="nv">removing = </span><span class="p">[]</span>
    <span class="nv">adjusting = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@table</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nv">matching = </span><span class="nx">@findCellByOptionsFor</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="p">{</span><span class="nv">left: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nv">width: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">width</span><span class="p">})</span>
        <span class="nx">removing</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">matching</span><span class="p">.</span><span class="nx">cell</span><span class="p">)</span>
        <span class="nx">i</span> <span class="o">+=</span> <span class="nx">matching</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nv">intersecting = </span><span class="nx">@findCellByIntersectionFor</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">sig</span><span class="p">)</span>
        <span class="nx">adjusting</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">intersecting</span><span class="p">.</span><span class="nx">cell</span><span class="p">)</span>

    <span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span> <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">removing</span>
    <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">adjusting</span>


  <span class="nv">addRow: </span><span class="nf">(position = &#39;after&#39;) -&gt;</span>
    <span class="nv">newRow = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">rowspan = </span><span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span>
      <span class="vi">@row = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">@row</span><span class="p">.</span><span class="nx">nextAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)[</span><span class="nx">rowspan</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>

    <span class="nv">cellCount = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;th, td&#39;</span><span class="p">)</span>
      <span class="nv">colspan = </span><span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
      <span class="nv">newCell = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{cell.tagName}&gt;&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@cellContent</span><span class="p">)</span>
      <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">newCell</span><span class="p">,</span> <span class="nx">colspan</span><span class="p">)</span>
      <span class="nx">cellCount</span> <span class="o">+=</span> <span class="nx">colspan</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">rowspan = </span><span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span>
        <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">rowspan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">continue</span>

      <span class="nx">newRow</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">cellCount</span> <span class="o">&lt;</span> <span class="nx">@columnCount</span>
      <span class="nv">rowCount = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">previousRow</span> <span class="k">in</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">prevAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
        <span class="nx">rowCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">previousRow</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td[rowspan], th[rowspan]&#39;</span><span class="p">)</span>
          <span class="nv">rowspan = </span><span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">rowspan</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="nx">rowCount</span> <span class="o">&amp;&amp;</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span>
            <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">rowspan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">rowspan</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="nx">rowCount</span> <span class="o">&amp;&amp;</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span>
            <span class="k">if</span> <span class="nx">rowspan</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nx">rowCount</span>
              <span class="nv">newCell = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{cell.tagName}&gt;&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@cellContent</span><span class="p">)</span>
              <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">newCell</span><span class="p">,</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">))</span>
              <span class="nx">newRow</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span>
            <span class="k">else</span>
              <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">rowspan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">position</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span> <span class="k">then</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">newRow</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">newRow</span><span class="p">)</span>


  <span class="nv">removeRow: </span><span class="o">-&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>check to see that all cells have the same rowspan, and figure out the minimum rowspan</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">rowspansMatch = </span><span class="kc">true</span>
    <span class="nv">prevRowspan = </span><span class="mi">0</span>
    <span class="nv">minRowspan = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">)</span>
      <span class="nv">rowspan = </span><span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
      <span class="nv">rowspansMatch = </span><span class="kc">false</span> <span class="k">if</span> <span class="nx">prevRowspan</span> <span class="o">&amp;&amp;</span> <span class="nx">rowspan</span> <span class="o">!=</span> <span class="nx">prevRowspan</span>
      <span class="nv">minRowspan = </span><span class="nx">rowspan</span> <span class="k">if</span> <span class="nx">rowspan</span> <span class="o">&lt;</span> <span class="nx">minRowspan</span> <span class="o">||</span> <span class="o">!</span><span class="nx">minRowspan</span>
      <span class="nv">prevRowspan = </span><span class="nx">rowspan</span>

    <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nx">rowspansMatch</span> <span class="o">&amp;&amp;</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">minRowspan</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>remove any emtpy rows below</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="nx">minRowspan</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@row</span><span class="p">.</span><span class="nx">nextAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">remove</span><span class="p">()</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">minRowspan</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>find and move down any cells that have a larger rowspan</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td[rowspan], th[rowspan]&#39;</span><span class="p">)</span>
      <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="nx">minRowspan</span>
      <span class="k">if</span> <span class="nv">match = </span><span class="nx">@findCellByOptionsFor</span><span class="p">(</span><span class="nx">@row</span><span class="p">.</span><span class="nx">nextAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)[</span><span class="nx">minRowspan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="nv">left: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nv">forceAdjacent: </span><span class="kc">true</span><span class="p">})</span>
        <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span> <span class="o">-</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">match</span><span class="p">.</span><span class="nx">direction</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span> <span class="k">then</span> <span class="nx">match</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">clone</span><span class="p">())</span> <span class="k">else</span> <span class="nx">match</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">clone</span><span class="p">())</span>

    <span class="k">if</span> <span class="nx">@columnsFor</span><span class="p">(</span><span class="nx">@row</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nx">@columnCount</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>move up rows looking for cells with rowspans that might intersect</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">rowsAbove = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">aboveRow</span> <span class="k">in</span> <span class="nx">@row</span><span class="p">.</span><span class="nx">prevAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
        <span class="nx">rowsAbove</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">aboveRow</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td[rowspan], th[rowspan]&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>if the cell intersects with the row we&rsquo;re trying to calculate on, and it&rsquo;s index is less than where we&rsquo;ve
gotten so far, add it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nv">rowspan = </span><span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
          <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">,</span> <span class="nx">rowspan</span> <span class="o">-</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">))</span> <span class="k">if</span> <span class="nx">rowspan</span> <span class="o">&gt;</span> <span class="nx">rowsAbove</span>

    <span class="nx">@row</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>


  <span class="nv">increaseColspan: </span><span class="o">-&gt;</span>
    <span class="nv">cell = </span><span class="nx">@cell</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">cell</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@cellIndexFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">@cellIndexFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span>
    <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">,</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">))</span>
    <span class="nx">cell</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>


  <span class="nv">decreaseColspan: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">,</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nv">newCell = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{@cell.get(0).tagName}&gt;&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@cellContent</span><span class="p">)</span>
    <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">newCell</span><span class="p">,</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">))</span>
    <span class="nx">@cell</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span>


  <span class="nv">increaseRowspan: </span><span class="o">-&gt;</span>
    <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span>
    <span class="nv">nextRow = </span><span class="nx">@row</span><span class="p">.</span><span class="nx">nextAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)[</span><span class="nx">sig</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">nextRow</span> <span class="o">&amp;&amp;</span> <span class="nv">match = </span><span class="nx">@findCellByOptionsFor</span><span class="p">(</span><span class="nx">nextRow</span><span class="p">,</span> <span class="p">{</span><span class="nv">left: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nv">width: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">width</span><span class="p">})</span>
      <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="nx">match</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="nx">match</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>

  <span class="nv">decreaseRowspan: </span><span class="o">-&gt;</span>
    <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="nv">nextRow = </span><span class="nx">@row</span><span class="p">.</span><span class="nx">nextAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)[</span><span class="nx">sig</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="nx">@findCellByOptionsFor</span><span class="p">(</span><span class="nx">nextRow</span><span class="p">,</span> <span class="p">{</span><span class="nv">left: </span><span class="nx">sig</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nv">forceAdjacent: </span><span class="kc">true</span><span class="p">})</span>
      <span class="nv">newCell = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{@cell.get(0).tagName}&gt;&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@cellContent</span><span class="p">)</span>
      <span class="nx">@setColspanFor</span><span class="p">(</span><span class="nx">newCell</span><span class="p">,</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">))</span>
      <span class="nx">@setRowspanFor</span><span class="p">(</span><span class="nx">@cell</span><span class="p">,</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">match</span><span class="p">.</span><span class="nx">direction</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span> <span class="k">then</span> <span class="nx">match</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span> <span class="k">else</span> <span class="nx">match</span><span class="p">.</span><span class="nx">cell</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">newCell</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Counts the columns of the first row (alpha row) in the table.  We can safely rely on the first row always being
comprised of a full set of cells or cells with colspans.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">getColumnCount: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">@columnsFor</span><span class="p">(</span><span class="nx">@table</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;thead tr:first-child, tbody tr:first-child, tfoot tr:first-child&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Counts the rows of the table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">getRowCount: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">@table</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">).</span><span class="nx">length</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Gets the index for a given cell, taking into account that rows above it can have cells that have rowspans.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">cellIndexFor: </span><span class="nf">(cell) -&gt;</span>
    <span class="nv">cell = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>get the row for the cell and calculate all the columns in it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">row = </span><span class="nx">cell</span><span class="p">.</span><span class="nx">parent</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
    <span class="nv">columns = </span><span class="nx">@columnsFor</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">))</span>
    <span class="nv">index = </span><span class="nx">@columnsFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">.</span><span class="nx">prevAll</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>if the columns is less than expected, we need to look above for rowspans</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="nx">columns</span> <span class="o">&lt;</span> <span class="nx">@columnCount</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>move up rows looking for cells with rowspans that might intersect</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">rowsAbove = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">aboveRow</span> <span class="k">in</span> <span class="nx">row</span><span class="p">.</span><span class="nx">prevAll</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
        <span class="nx">rowsAbove</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="nx">aboveCell</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">aboveRow</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td[rowspan], th[rowspan]&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>if the cell intersects with the row we&rsquo;re trying to calculate on, and it&rsquo;s index is less than where we&rsquo;ve
gotten so far, add it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">aboveCell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">rowsAbove</span> <span class="o">&amp;&amp;</span> <span class="nx">@cellIndexFor</span><span class="p">(</span><span class="nx">aboveCell</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">index</span>
            <span class="nx">index</span> <span class="o">+=</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">aboveCell</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">index</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Creates a signature for a given cell, which is made up if it&rsquo;s size, and itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">cellSignatureFor: </span><span class="nf">(cell) -&gt;</span>
    <span class="nv">sig = </span><span class="p">{</span><span class="nv">cell: </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">)}</span>
    <span class="nv">sig.left = </span><span class="nx">@cellIndexFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
    <span class="nv">sig.width = </span><span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
    <span class="nv">sig.height = </span><span class="nx">@rowspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
    <span class="nv">sig.right = </span><span class="nx">sig</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">width</span>
    <span class="k">return</span> <span class="nx">sig</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Find a cell based on options.  Options can be:
right
or
left, [width], [forceAdjacent]
eg. findCellByOptionsFor(@row, {left: 1, width: 2, forceAdjacent: true})</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">findCellByOptionsFor: </span><span class="nf">(row, options) -&gt;</span>
    <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">row</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">)</span>
      <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
      <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span>
        <span class="k">return</span> <span class="nx">sig</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">right</span> <span class="o">==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">right</span>
      <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span>

        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">width</span>
          <span class="k">return</span> <span class="nx">sig</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">left</span> <span class="o">==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">width</span> <span class="o">==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">width</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">forceAdjacent</span>
          <span class="k">return</span> <span class="nx">sig</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">left</span> <span class="o">==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">left</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceAdjacent</span>
          <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">left</span> <span class="o">&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">left</span>
            <span class="nv">prev = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">prev</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">length</span>
              <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">prev</span><span class="p">)</span>
              <span class="nv">sig.direction = </span><span class="s1">&#39;after&#39;</span>
            <span class="k">else</span>
              <span class="nv">sig.direction = </span><span class="s1">&#39;before&#39;</span>
            <span class="k">return</span> <span class="nx">sig</span>

    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">forceAdjacent</span>
      <span class="nv">sig.direction = </span><span class="s1">&#39;after&#39;</span>
      <span class="k">return</span> <span class="nx">sig</span>

    <span class="k">return</span> <span class="kc">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Finds a cell that intersects with the current signature</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">findCellByIntersectionFor: </span><span class="nf">(row, signature) -&gt;</span>
    <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">row</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;td, th&#39;</span><span class="p">)</span>
      <span class="nv">sig = </span><span class="nx">@cellSignatureFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">sig</span> <span class="k">if</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">left</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sig</span><span class="p">.</span><span class="nx">right</span> <span class="o">&gt;</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">left</span>
    <span class="k">return</span> <span class="kc">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Counts all the columns in a given array of columns, taking colspans into
account.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">columnsFor: </span><span class="nf">(cells) -&gt;</span>
    <span class="nv">count = </span><span class="mi">0</span>
    <span class="nx">count</span> <span class="o">+=</span> <span class="nx">@colspanFor</span><span class="p">(</span><span class="nx">cell</span><span class="p">)</span> <span class="k">for</span> <span class="nx">cell</span> <span class="k">in</span> <span class="nx">cells</span>
    <span class="k">return</span> <span class="nx">count</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Tries to get the colspan of a cell, falling back to 1 if there&rsquo;s none
specified.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">colspanFor: </span><span class="nf">(cell) -&gt;</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;colspan&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="mi">1</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Tries to get the rowspan of a cell, falling back to 1 if there&rsquo;s none
specified.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">rowspanFor: </span><span class="nf">(cell) -&gt;</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;rowspan&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="mi">1</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Sets the colspan of a cell, removing it if it&rsquo;s 1.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">setColspanFor: </span><span class="nf">(cell, value) -&gt;</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;colspan&#39;</span><span class="p">,</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">value</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Sets the rowspan of a cell, removing it if it&rsquo;s 1</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">setRowspanFor: </span><span class="nf">(cell, value) -&gt;</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="nx">cell</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;rowspan&#39;</span><span class="p">,</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">value</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span></pre></div>
      </td>
    </tr>
  </table>

  <div id="footer">
    <hr>
    Copyright 2011 Jeremy Jackson. All rights reserved.
  </div>

</body>
</html>


