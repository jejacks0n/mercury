<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Mercury Editor - Annotated Source - editable.js.coffee</title>
  <link href="/mercury/assets/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css"/>
  <script src="/mercury/assets/javascripts/application.js" type="text/javascript"></script>
  <!--[if lt IE 7]>
    <script type="text/javascript" src="/mercury/assets/javascripts/unitpngfix.js"></script>
  <![endif]-->
</head>
<body>

  <div id="background"></div>

  <h1 id="logo"><a href="/mercury">Mercury Editor</a></h1>

  <ul id="navigation">
    <li><a href="/mercury">Home</a></li>
    <li><a href="/mercury/downloads">Downloads</a></li>
    <li><a href="/mercury/walkthrough">Walkthrough</a></li>
    <li><a href="/mercury/documentation">Documentation</a></li>
    <li class="active"><a href="/mercury/annotated_source">Annotated Source</a></li>
  </ul>

  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>editable.js.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nx">@Mercury</span><span class="p">.</span><span class="nx">Regions</span><span class="p">.</span><span class="nx">Editable</span> <span class="k">extends</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">Region</span>
  <span class="nv">type = </span><span class="s1">&#39;editable&#39;</span>

  <span class="nv">constructor: </span><span class="nf">(@element, @window, @options = {}) -&gt;</span>
    <span class="vi">@type = </span><span class="s1">&#39;editable&#39;</span>
    <span class="k">super</span>


  <span class="nv">build: </span><span class="o">-&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>mozilla: set some initial content so everything works correctly</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">@content</span><span class="p">(</span><span class="s1">&#39;&amp;nbsp;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">mozilla</span> <span class="o">&amp;&amp;</span> <span class="nx">@content</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>set overflow just in case</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">@element</span><span class="p">.</span><span class="nx">data</span><span class="p">({</span><span class="nv">originalOverflow: </span><span class="nx">@element</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;overflow&#39;</span><span class="p">)})</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nv">overflow: </span><span class="s1">&#39;auto&#39;</span><span class="p">})</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>mozilla: there&rsquo;s some weird behavior when the element isn&rsquo;t a div</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@specialContainer = </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">mozilla</span> <span class="o">&amp;&amp;</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">tagName</span> <span class="o">!=</span> <span class="s1">&#39;DIV&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>make it editable
mozilla: this makes double clicking in textareas fail: https://bugzilla.mozilla.org/show_bug.cgi?id=490367</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nv">contentEditable = </span><span class="kc">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>make all snippets not editable, and set their versions to 1</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.mercury-snippet&#39;</span><span class="p">)</span>
      <span class="nv">element.contentEditable = </span><span class="kc">false</span>
      <span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-version&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>add the basic editor settings to the document (only once)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">unless</span> <span class="nx">@document</span><span class="p">.</span><span class="nx">mercuryEditing</span>
      <span class="vi">@document.mercuryEditing = </span><span class="kc">true</span>
      <span class="k">try</span>
        <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;styleWithCSS&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;insertBROnReturn&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;enableInlineTableEditing&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;enableObjectResizing&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">e</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>intentionally do nothing if any of these fail, to broaden support for Opera</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">bindEvents: </span><span class="o">-&gt;</span>
    <span class="k">super</span>

    <span class="nx">Mercury</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;region:update&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span> <span class="o">||</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">region</span> <span class="o">!=</span> <span class="err">@</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@selection</span><span class="p">().</span><span class="nx">forceSelection</span><span class="p">(</span><span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
      <span class="nv">currentElement = </span><span class="nx">@currentElement</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">currentElement</span><span class="p">.</span><span class="nx">length</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>setup the table editor if we&rsquo;re inside a table</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nv">table = </span><span class="nx">currentElement</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">)</span>
        <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">currentElement</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;tr, td&#39;</span><span class="p">),</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">table</span><span class="p">.</span><span class="nx">length</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>display a tooltip if we&rsquo;re in an anchor</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nv">anchor = </span><span class="nx">currentElement</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">anchor</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">anchor</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>
          <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">(</span><span class="nx">anchor</span><span class="p">,</span> <span class="s2">&quot;&lt;a href=\&quot;#{anchor.attr(&#39;href&#39;)}\&quot; target=\&quot;_blank\&quot;&gt;#{anchor.attr(&#39;href&#39;)}&lt;/a&gt;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nv">position: </span><span class="s1">&#39;below&#39;</span><span class="p">})</span>
        <span class="k">else</span>
          <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;dragenter&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">snippet</span>
      <span class="nv">event.originalEvent.dataTransfer.dropEffect = </span><span class="s1">&#39;copy&#39;</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;dragover&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">snippet</span>
      <span class="nv">event.originalEvent.dataTransfer.dropEffect = </span><span class="s1">&#39;copy&#39;</span>
      <span class="k">if</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">webkit</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@dropTimeout</span><span class="p">)</span>
        <span class="vi">@dropTimeout = </span><span class="nx">setTimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;possible:drop&#39;</span><span class="p">))</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>handle dropping snippets</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@dropTimeout</span><span class="p">)</span>
      <span class="vi">@dropTimeout = </span><span class="nx">setTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;possible:drop&#39;</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>handle any files that were dropped</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="nx">@focus</span><span class="p">()</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">uploader</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>possible:drop custom event: we have to do this because webkit doesn&rsquo;t fire the drop event unless both dragover and
dragstart default behaviors are canceled.. but when we do that and observe the drop event, the default behavior
isn&rsquo;t handled (eg, putting the image where it was dropped,) so to allow the browser to do it&rsquo;s thing, and also do
our thing we have this little hack.  <em>sigh</em>
read: http://www.quirksmode.org/blog/archives/2009/09/the<em>html5</em>drag.html</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;possible:drop&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="k">if</span> <span class="nv">snippet = </span><span class="nx">@element</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img[data-snippet]&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">@focus</span><span class="p">()</span>
        <span class="nx">Mercury</span><span class="p">.</span><span class="nx">Snippet</span><span class="p">.</span><span class="nx">displayOptionsFor</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">snippet</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;snippet&#39;</span><span class="p">))</span>
        <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;undo&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>custom paste handling: we have to do some hackery to get the pasted content since it&rsquo;s not exposed normally
through a clipboard in firefox (heaven forbid), and to keep the behavior across all browsers, we manually detect
what was pasted by focusing a different (hidden) region, letting it paste there, making our adjustments, and then
inserting the content where it was intended.  This is possible, so it doesn&rsquo;t make sense why it wouldn&rsquo;t be
exposed in a sensible way.  <em>sigh</em></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;paste&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span> <span class="o">||</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">region</span> <span class="o">!=</span> <span class="err">@</span>
      <span class="k">if</span> <span class="nx">@specialContainer</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="k">return</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@pasting</span>
      <span class="nv">Mercury.changes = </span><span class="kc">true</span>
      <span class="nx">@handlePaste</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">)</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;focus&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nv">Mercury.region = </span><span class="err">@</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@selection</span><span class="p">().</span><span class="nx">forceSelection</span><span class="p">(</span><span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;region:focused&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">region: </span><span class="err">@</span><span class="p">})</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;region:blurred&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">region: </span><span class="err">@</span><span class="p">})</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tooltip</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">jQuery</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;_top&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@previewing</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nv">image = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">image</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">@selection</span><span class="p">().</span><span class="nx">selectNode</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">action: </span><span class="s1">&#39;insertMedia&#39;</span><span class="p">})</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nx">@pushHistory</span><span class="p">()</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;region:update&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">region: </span><span class="err">@</span><span class="p">})</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="k">switch</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span>
        <span class="k">when</span> <span class="mi">90</span> <span class="c1"># undo / redo</span>
          <span class="k">return</span> <span class="nx">unless</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metaKey</span>
          <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
          <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="k">then</span> <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;redo&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;undo&#39;</span><span class="p">)</span>
          <span class="k">return</span>

        <span class="k">when</span> <span class="mi">13</span> <span class="c1"># enter</span>
          <span class="k">if</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">webkit</span> <span class="o">&amp;&amp;</span> <span class="nx">@selection</span><span class="p">().</span><span class="nx">commonAncestor</span><span class="p">().</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;li, ul, ol&#39;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
            <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;insertParagraph&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">@specialContainer</span> <span class="o">||</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">opera</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>mozilla: pressing enter in any element besides a div handles strangely</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
            <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;insertHTML&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">)</span>

        <span class="k">when</span> <span class="mi">9</span> <span class="c1"># tab</span>
          <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
          <span class="nv">container = </span><span class="nx">@selection</span><span class="p">().</span><span class="nx">commonAncestor</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>indent when inside of an li</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">).</span><span class="nx">length</span>
            <span class="nx">unless</span> <span class="nx">event</span><span class="p">.</span><span class="nx">shiftKey</span>
              <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;indent&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>do not outdent on last ul/ol parent, or we break out of the list</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">else</span> <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;ul, ol&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
              <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;outdent&#39;</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;insertHTML&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">value: </span><span class="s1">&#39;&amp;nbsp;&amp;nbsp;&#39;</span><span class="p">})</span>

      <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">metaKey</span>
        <span class="k">switch</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span>
          <span class="k">when</span> <span class="mi">66</span> <span class="c1"># b</span>
            <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

          <span class="k">when</span> <span class="mi">73</span> <span class="c1"># i</span>
            <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;italic&#39;</span><span class="p">)</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

          <span class="k">when</span> <span class="mi">85</span> <span class="c1"># u</span>
            <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;underline&#39;</span><span class="p">)</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

      <span class="nx">@pushHistory</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">)</span>

    <span class="nx">@element</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;region:update&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">region: </span><span class="err">@</span><span class="p">})</span>
      <span class="nv">Mercury.changes = </span><span class="kc">true</span>


  <span class="nv">focus: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">region</span> <span class="o">!=</span> <span class="err">@</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">focus</span><span class="p">())</span>
      <span class="k">try</span>
        <span class="nx">@selection</span><span class="p">().</span><span class="nx">selection</span><span class="p">.</span><span class="nx">collapseToStart</span><span class="p">()</span>
      <span class="k">catch</span> <span class="nx">e</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>intentially do nothing</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">else</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">focus</span><span class="p">())</span>

    <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;region:focused&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">region: </span><span class="err">@</span><span class="p">})</span>
    <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;region:update&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">region: </span><span class="err">@</span><span class="p">})</span>


  <span class="nv">content: </span><span class="nf">(value = null, filterSnippets = true, includeMarker = false) -&gt;</span>
    <span class="k">if</span> <span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>sanitize the html before we insert it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">container = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">@document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">())</span>
      <span class="nx">container</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>fill in the snippet contents</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">container</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[data-snippet]&#39;</span><span class="p">)</span>
        <span class="nv">element.contentEditable = </span><span class="kc">false</span>
        <span class="nv">element = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="nv">snippet = </span><span class="nx">Mercury</span><span class="p">.</span><span class="nx">Snippet</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;snippet&#39;</span><span class="p">))</span>
          <span class="nx">unless</span> <span class="nx">element</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
            <span class="k">try</span>
              <span class="nv">version = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">html</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/(\d+)\]/</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
              <span class="k">if</span> <span class="nx">version</span>
                <span class="nx">snippet</span><span class="p">.</span><span class="nx">setVersion</span><span class="p">(</span><span class="nx">version</span><span class="p">)</span>
                <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span><span class="p">({</span><span class="s1">&#39;data-version&#39;</span><span class="o">:</span> <span class="nx">version</span><span class="p">})</span>
                <span class="nx">element</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
            <span class="k">catch</span> <span class="nx">error</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>set the html</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">@element</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">html</span><span class="p">())</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>create a selection if there&rsquo;s markers</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">@selection</span><span class="p">().</span><span class="nx">selectMarker</span><span class="p">(</span><span class="nx">@element</span><span class="p">)</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>remove any meta tags</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">@element</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>place markers for the selection</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="nx">includeMarker</span>
        <span class="nv">selection = </span><span class="nx">@selection</span><span class="p">()</span>
        <span class="nx">selection</span><span class="p">.</span><span class="nx">placeMarker</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>sanitize the html before we return it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">container = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">@document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">())</span>
      <span class="nx">container</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">@element</span><span class="p">.</span><span class="nx">html</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+|\s+$/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>replace snippet contents to be an identifier</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="nx">filterSnippets</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">container</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[data-snippet]&#39;</span><span class="p">)</span>
        <span class="nv">element = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="nv">snippet = </span><span class="nx">Mercury</span><span class="p">.</span><span class="nx">Snippet</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s2">&quot;snippet&quot;</span><span class="p">))</span>
          <span class="nv">snippet.data = </span><span class="nx">element</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;[#{element.data(&quot;</span><span class="nx">snippet</span><span class="s2">&quot;)}/#{element.data(&quot;</span><span class="nx">version</span><span class="s2">&quot;)}]&quot;</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span><span class="p">({</span><span class="nv">contenteditable: </span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;data-version&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">})</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>get the html before removing the markers</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">content = </span><span class="nx">container</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>remove the markers from the dom</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">selection</span><span class="p">.</span><span class="nx">removeMarker</span><span class="p">()</span> <span class="k">if</span> <span class="nx">includeMarker</span>

      <span class="k">return</span> <span class="nx">content</span>


  <span class="nv">togglePreview: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@previewing</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nv">contentEditable = </span><span class="kc">true</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nv">overflow: </span><span class="s1">&#39;auto&#39;</span><span class="p">})</span>
    <span class="k">else</span>
      <span class="nx">@content</span><span class="p">(</span><span class="nx">@content</span><span class="p">())</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nv">contentEditable = </span><span class="kc">false</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">css</span><span class="p">({</span><span class="nv">overflow: </span><span class="nx">@element</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;originalOverflow&#39;</span><span class="p">)})</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">blur</span><span class="p">()</span>
    <span class="k">super</span>


  <span class="nv">execCommand: </span><span class="nf">(action, options = {}) -&gt;</span>
    <span class="k">super</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>use a custom handler if there&rsquo;s one, otherwise use execCommand</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="nv">handler = </span><span class="nx">Mercury</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">behaviors</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span> <span class="o">||</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">Regions</span><span class="p">.</span><span class="nx">Editable</span><span class="p">.</span><span class="nx">actions</span><span class="p">[</span><span class="nx">action</span><span class="p">]</span>
      <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">@selection</span><span class="p">(),</span> <span class="nx">options</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">sibling = </span><span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">previousSibling</span> <span class="k">if</span> <span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;indent&#39;</span>
      <span class="nv">options.value = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="k">if</span> <span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;insertHTML&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">get</span>
      <span class="k">try</span>
        <span class="nx">@document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">error</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>mozilla: indenting when there&rsquo;s no br tag handles strangely
todo: mozilla: trying to justify the first line of any contentEditable fails</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">@element</span><span class="p">.</span><span class="nx">prev</span><span class="p">().</span><span class="nx">remove</span><span class="p">()</span> <span class="k">if</span> <span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;indent&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">prev</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">sibling</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>handle any broken images by replacing the source with an alert image</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">@element</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">one</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">jQuery</span><span class="p">(</span><span class="err">@</span><span class="p">).</span><span class="nx">attr</span><span class="p">({</span><span class="nv">src: </span><span class="s1">&#39;/assets/mercury/missing-image.png&#39;</span><span class="p">,</span> <span class="nv">title: </span><span class="s1">&#39;Image not found&#39;</span><span class="p">})</span>


  <span class="nv">pushHistory: </span><span class="nf">(keyCode) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>when pressing return, delete or backspace it should push to the history
all other times it should store if there&rsquo;s a 1 second pause</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">keyCodes = </span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="nv">waitTime = </span><span class="mf">2.5</span>
    <span class="nv">knownKeyCode = </span><span class="nx">keyCodes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">keyCode</span><span class="p">)</span> <span class="k">if</span> <span class="nx">keyCode</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>clear any pushes to the history</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@historyTimeout</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>if the key code was return, delete, or backspace store now &mdash; unless it was the same as last time</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="nx">knownKeyCode</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">knownKeyCode</span> <span class="o">!=</span> <span class="nx">@lastKnownKeyCode</span> <span class="c1"># || !keyCode</span>
      <span class="nx">@history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@content</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">keyCode</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>set a timeout for pushing to the history</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="vi">@historyTimeout = </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">waitTime</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@content</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">)))</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>push to the history immediately</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">@history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@content</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span>

    <span class="vi">@lastKnownKeyCode = </span><span class="nx">knownKeyCode</span>


  <span class="nv">selection: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">Regions</span><span class="p">.</span><span class="nx">Editable</span><span class="p">.</span><span class="nx">Selection</span><span class="p">(</span><span class="nx">@window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">(),</span> <span class="nx">@document</span><span class="p">)</span>


  <span class="nv">path: </span><span class="o">-&gt;</span>
    <span class="nv">container = </span><span class="nx">@selection</span><span class="p">().</span><span class="nx">commonAncestor</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">container</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="p">[]</span> <span class="k">else</span> <span class="nx">container</span><span class="p">.</span><span class="nx">parentsUntil</span><span class="p">(</span><span class="nx">@element</span><span class="p">)</span>


  <span class="nv">currentElement: </span><span class="o">-&gt;</span>
    <span class="nv">element = </span><span class="p">[]</span>
    <span class="nv">selection = </span><span class="nx">@selection</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">range</span>
      <span class="nv">element = </span><span class="nx">selection</span><span class="p">.</span><span class="nx">commonAncestor</span><span class="p">()</span>
      <span class="nv">element = </span><span class="nx">element</span><span class="p">.</span><span class="nx">parent</span><span class="p">()</span> <span class="k">if</span> <span class="nx">element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="nx">element</span>


  <span class="nv">handlePaste: </span><span class="nf">(event) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>get the text content from the clipboard and fall back to using the sanitizer if unavailable</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pasting</span><span class="p">.</span><span class="nx">sanitize</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clipboardData</span>
      <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;insertHTML&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">value: </span><span class="nx">event</span><span class="p">.</span><span class="nx">clipboardData</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)})</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>get current selection &amp; range</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">selection = </span><span class="nx">@selection</span><span class="p">()</span>
      <span class="nx">selection</span><span class="p">.</span><span class="nx">placeMarker</span><span class="p">()</span>

      <span class="nv">sanitizer = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;#mercury_sanitizer&#39;</span><span class="p">,</span> <span class="nx">@document</span><span class="p">).</span><span class="nx">focus</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>set 1ms timeout to allow paste event to complete</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">setTimeout</span> <span class="mi">1</span><span class="p">,</span> <span class="o">=&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>sanitize the content</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nv">content = </span><span class="nx">@sanitize</span><span class="p">(</span><span class="nx">sanitizer</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>move cursor back to original element &amp; position</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">selection</span><span class="p">.</span><span class="nx">selectMarker</span><span class="p">(</span><span class="nx">@element</span><span class="p">)</span>
        <span class="nx">selection</span><span class="p">.</span><span class="nx">removeMarker</span><span class="p">()</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>paste sanitized content</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">@element</span><span class="p">.</span><span class="nx">focus</span><span class="p">()</span>
        <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;insertHTML&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">value: </span><span class="nx">content</span><span class="p">})</span>


  <span class="nv">sanitize: </span><span class="nf">(sanitizer) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>always remove nested regions</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">sanitizer</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.#{Mercury.config.regionClass}&quot;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pasting</span><span class="p">.</span><span class="nx">sanitize</span>
      <span class="k">switch</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pasting</span><span class="p">.</span><span class="nx">sanitize</span>
        <span class="k">when</span> <span class="s1">&#39;blacklist&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>todo: finish writing black list functionality</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">sanitizer</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[style]&#39;</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span>
          <span class="nx">sanitizer</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[class=&quot;Apple-style-span&quot;]&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;Apple-style-span&#39;</span><span class="p">)</span>
          <span class="nv">content = </span><span class="nx">sanitizer</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
        <span class="k">when</span> <span class="s1">&#39;whitelist&#39;</span>
          <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">sanitizer</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
            <span class="nv">allowed = </span><span class="kc">false</span>
            <span class="k">for</span> <span class="nx">allowedTag</span><span class="p">,</span> <span class="nx">allowedAttributes</span> <span class="k">of</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">pasting</span><span class="p">.</span><span class="nx">whitelist</span>
              <span class="k">if</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="nx">allowedTag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
                <span class="nv">allowed = </span><span class="kc">true</span>
                <span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span>
                  <span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">allowedAttributes</span>
                <span class="k">break</span>
            <span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">replaceWith</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">contents</span><span class="p">())</span> <span class="nx">unless</span> <span class="nx">allowed</span>
          <span class="nv">content = </span><span class="nx">sanitizer</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
        <span class="k">else</span> <span class="nv">content = </span><span class="nx">sanitizer</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
    <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>force text if it looks like it&rsquo;s from word/pages, even if there&rsquo;s no sanitizing requested</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">content = </span><span class="nx">sanitizer</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">content</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&lt;!--StartFragment--&gt;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">content</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;=&quot;mso-&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">content</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;&lt;o:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">content</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;=&quot;Mso&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">content = </span><span class="nx">sanitizer</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>

    <span class="nx">sanitizer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">content</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>Custom actions (eg. things that execCommand doesn&rsquo;t do, or doesn&rsquo;t do well)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="vi">@actions: </span><span class="p">{</span>

    <span class="nv">insertRowBefore: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">addRow</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">)</span>

    <span class="nv">insertRowAfter: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">addRow</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">)</span>

    <span class="nv">insertColumnBefore: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">addColumn</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">)</span>

    <span class="nv">insertColumnAfter: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">addColumn</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">)</span>

    <span class="nv">deleteColumn: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">removeColumn</span><span class="p">()</span>

    <span class="nv">deleteRow: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">removeRow</span><span class="p">()</span>

    <span class="nv">increaseColspan: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">increaseColspan</span><span class="p">()</span>

    <span class="nv">decreaseColspan: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">decreaseColspan</span><span class="p">()</span>

    <span class="nv">increaseRowspan: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">increaseRowspan</span><span class="p">()</span>

    <span class="nv">decreaseRowspan: </span><span class="o">-&gt;</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">tableEditor</span><span class="p">.</span><span class="nx">decreaseRowspan</span><span class="p">()</span>

    <span class="nv">undo: </span><span class="o">-&gt;</span> <span class="nx">@content</span><span class="p">(</span><span class="nx">@history</span><span class="p">.</span><span class="nx">undo</span><span class="p">())</span>

    <span class="nv">redo: </span><span class="o">-&gt;</span> <span class="nx">@content</span><span class="p">(</span><span class="nx">@history</span><span class="p">.</span><span class="nx">redo</span><span class="p">())</span>

    <span class="nv">horizontalRule: </span><span class="o">-&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;insertHorizontalRule&#39;</span><span class="p">)</span>

    <span class="nv">removeFormatting: </span><span class="nf">(selection) -&gt;</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">insertTextNode</span><span class="p">(</span><span class="nx">selection</span><span class="p">.</span><span class="nx">textContent</span><span class="p">())</span>

    <span class="nv">backColor: </span><span class="nf">(selection, options) -&gt;</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="s2">&quot;&lt;span style=\&quot;background-color:#{options.value.toHex()}\&quot;&gt;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

    <span class="nv">overline: </span><span class="nf">(selection) -&gt;</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="s1">&#39;&lt;span style=&quot;text-decoration:overline&quot;&gt;&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

    <span class="nv">style: </span><span class="nf">(selection, options) -&gt;</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="s2">&quot;&lt;span class=\&quot;#{options.value}\&quot;&gt;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

    <span class="nv">replaceHTML: </span><span class="nf">(selection, options) -&gt;</span> <span class="nx">@content</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>

    <span class="nv">insertImage: </span><span class="nf">(selection, options) -&gt;</span> <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;insertHTML&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">value: </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;img/&gt;&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">)})</span>

    <span class="nv">insertTable: </span><span class="nf">(selection, options) -&gt;</span> <span class="nx">@execCommand</span><span class="p">(</span><span class="s1">&#39;insertHTML&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">value: </span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">})</span>

    <span class="nv">insertLink: </span><span class="nf">(selection, options) -&gt;</span>
      <span class="nv">anchor = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{options.value.tagName}&gt;&quot;</span><span class="p">,</span> <span class="nx">@document</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">attrs</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
      <span class="nx">selection</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">anchor</span><span class="p">)</span>

    <span class="nv">replaceLink: </span><span class="nf">(selection, options) -&gt;</span>
      <span class="nv">anchor = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;#{options.value.tagName}&gt;&quot;</span><span class="p">,</span> <span class="nx">@document</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">attrs</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
      <span class="nx">selection</span><span class="p">.</span><span class="nx">selectNode</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span>
      <span class="nv">html = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">selection</span><span class="p">.</span><span class="nx">content</span><span class="p">()).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>
      <span class="nx">selection</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">anchor</span><span class="p">,</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">context</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">))</span>

    <span class="nv">insertSnippet: </span><span class="nf">(selection, options) -&gt;</span>
      <span class="nv">snippet = </span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">existing = </span><span class="nx">@element</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;[data-snippet=#{snippet.identity}]&quot;</span><span class="p">)).</span><span class="nx">length</span>
        <span class="nx">selection</span><span class="p">.</span><span class="nx">selectNode</span><span class="p">(</span><span class="nx">existing</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
      <span class="nx">selection</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">getHTML</span><span class="p">(</span><span class="nx">@document</span><span class="p">))</span>

    <span class="nv">editSnippet: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@snippet</span>
      <span class="nv">snippet = </span><span class="nx">Mercury</span><span class="p">.</span><span class="nx">Snippet</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">@snippet</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;snippet&#39;</span><span class="p">))</span>
      <span class="nx">snippet</span><span class="p">.</span><span class="nx">displayOptions</span><span class="p">()</span>

    <span class="nv">removeSnippet: </span><span class="o">-&gt;</span>
      <span class="nx">@snippet</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@snippet</span>
      <span class="nx">Mercury</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;hide:toolbar&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">type: </span><span class="s1">&#39;snippet&#39;</span><span class="p">,</span> <span class="nv">immediately: </span><span class="kc">true</span><span class="p">})</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>Helper class for managing selection and getting information from it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nx">Mercury</span><span class="p">.</span><span class="nx">Regions</span><span class="p">.</span><span class="nx">Editable</span><span class="p">.</span><span class="nx">Selection</span>

  <span class="nv">constructor: </span><span class="nf">(@selection, @context) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@selection</span><span class="p">.</span><span class="nx">rangeCount</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="vi">@range = </span><span class="nx">@selection</span><span class="p">.</span><span class="nx">getRangeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="vi">@fragment = </span><span class="nx">@range</span><span class="p">.</span><span class="nx">cloneContents</span><span class="p">()</span>
    <span class="vi">@clone = </span><span class="nx">@range</span><span class="p">.</span><span class="nx">cloneRange</span><span class="p">()</span>
    <span class="vi">@collapsed = </span><span class="nx">@selection</span><span class="p">.</span><span class="nx">isCollapsed</span>


  <span class="nv">commonAncestor: </span><span class="nf">(onlyTag = false) -&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">@range</span>
    <span class="nv">ancestor = </span><span class="nx">@range</span><span class="p">.</span><span class="nx">commonAncestorContainer</span>
    <span class="nv">ancestor = </span><span class="nx">ancestor</span><span class="p">.</span><span class="nx">parentNode</span> <span class="k">if</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">onlyTag</span>
    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">ancestor</span><span class="p">)</span>


  <span class="nv">wrap: </span><span class="nf">(element, replace = false) -&gt;</span>
    <span class="nv">element = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">@context</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@fragment</span><span class="p">)</span>
    <span class="nx">@replace</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="k">if</span> <span class="nx">replace</span>
    <span class="k">return</span> <span class="nx">element</span>


  <span class="nv">textContent: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">@range</span><span class="p">.</span><span class="nx">cloneContents</span><span class="p">().</span><span class="nx">textContent</span>


  <span class="nv">content: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">@range</span><span class="p">.</span><span class="nx">cloneContents</span><span class="p">()</span>


  <span class="o">is:</span> <span class="nf">(elementType) -&gt;</span>
    <span class="nv">content = </span><span class="nx">@content</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="k">if</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="nx">elementType</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>


  <span class="nv">forceSelection: </span><span class="nf">(element) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">webkit</span>
    <span class="nv">range = </span><span class="nx">@context</span><span class="p">.</span><span class="nx">createRange</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@range</span>
      <span class="k">if</span> <span class="nx">@commonAncestor</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;.mercury-snippet&#39;</span><span class="p">).</span><span class="nx">length</span>
        <span class="nv">lastChild = </span><span class="nx">@context</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;\00&#39;</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">lastChild</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">element</span><span class="p">.</span><span class="nx">lastChild</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[\s+|\n+]|[\s+|\n+]$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
        <span class="nv">lastChild = </span><span class="nx">element</span><span class="p">.</span><span class="nx">lastChild</span>
        <span class="nv">element.lastChild.textContent = </span><span class="s1">&#39;\00&#39;</span>
      <span class="k">else</span>
        <span class="nv">lastChild = </span><span class="nx">@context</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;\00&#39;</span><span class="p">)</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">lastChild</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">lastChild</span>
      <span class="nx">range</span><span class="p">.</span><span class="nx">setStartBefore</span><span class="p">(</span><span class="nx">lastChild</span><span class="p">)</span>
      <span class="nx">range</span><span class="p">.</span><span class="nx">setEndBefore</span><span class="p">(</span><span class="nx">lastChild</span><span class="p">)</span>
      <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">range</span><span class="p">)</span>


  <span class="nv">selectMarker: </span><span class="nf">(context) -&gt;</span>
    <span class="nv">markers = </span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;em.mercury-marker&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">markers</span><span class="p">.</span><span class="nx">length</span>

    <span class="nv">range = </span><span class="nx">@context</span><span class="p">.</span><span class="nx">createRange</span><span class="p">()</span>
    <span class="nx">range</span><span class="p">.</span><span class="nx">setStartBefore</span><span class="p">(</span><span class="nx">markers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="nx">range</span><span class="p">.</span><span class="nx">setEndBefore</span><span class="p">(</span><span class="nx">markers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="nx">markers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span>

    <span class="nx">markers</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>

    <span class="nx">@selection</span><span class="p">.</span><span class="nx">removeAllRanges</span><span class="p">()</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">range</span><span class="p">)</span>


  <span class="nv">placeMarker: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@range</span>

    <span class="vi">@startMarker = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;em class=&quot;mercury-marker&quot;/&gt;&#39;</span><span class="p">,</span> <span class="nx">@context</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="vi">@endMarker = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;em class=&quot;mercury-marker&quot;/&gt;&#39;</span><span class="p">,</span> <span class="nx">@context</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>put a single marker (the end)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">rangeEnd = </span><span class="nx">@range</span><span class="p">.</span><span class="nx">cloneRange</span><span class="p">()</span>
    <span class="nx">rangeEnd</span><span class="p">.</span><span class="nx">collapse</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="nx">rangeEnd</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">@endMarker</span><span class="p">)</span>

    <span class="nx">unless</span> <span class="nx">@range</span><span class="p">.</span><span class="nx">collapsed</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>put a start marker</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nv">rangeStart = </span><span class="nx">@range</span><span class="p">.</span><span class="nx">cloneRange</span><span class="p">()</span>
      <span class="nx">rangeStart</span><span class="p">.</span><span class="nx">collapse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="nx">rangeStart</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">@startMarker</span><span class="p">)</span>

    <span class="nx">@selection</span><span class="p">.</span><span class="nx">removeAllRanges</span><span class="p">()</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">@range</span><span class="p">)</span>


  <span class="nv">removeMarker: </span><span class="o">-&gt;</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@startMarker</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@endMarker</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>


  <span class="nv">insertTextNode: </span><span class="nf">(string) -&gt;</span>
    <span class="nv">node = </span><span class="nx">@context</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">extractContents</span><span class="p">()</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">selectNodeContents</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">@range</span><span class="p">)</span>


  <span class="nv">insertNode: </span><span class="nf">(element) -&gt;</span>
    <span class="nv">element = </span><span class="nx">element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nx">element</span><span class="p">.</span><span class="nx">get</span>
    <span class="nv">element = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">@context</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span>

    <span class="nx">@range</span><span class="p">.</span><span class="nx">deleteContents</span><span class="p">()</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">selectNodeContents</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">@range</span><span class="p">)</span>


  <span class="nv">selectNode: </span><span class="nf">(node, removeExisting = false) -&gt;</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">selectNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">removeAllRanges</span><span class="p">()</span> <span class="k">if</span> <span class="nx">removeExisting</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">@range</span><span class="p">)</span>


  <span class="nv">replace: </span><span class="nf">(element, collapse) -&gt;</span>
    <span class="nv">element = </span><span class="nx">element</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nx">element</span><span class="p">.</span><span class="nx">get</span>
    <span class="nv">element = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">@context</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span>

    <span class="nx">@range</span><span class="p">.</span><span class="nx">deleteContents</span><span class="p">()</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">selectNodeContents</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
    <span class="nx">@selection</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">@range</span><span class="p">)</span>
    <span class="nx">@range</span><span class="p">.</span><span class="nx">collapse</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="k">if</span> <span class="nx">collapse</span></pre></div>
      </td>
    </tr>
  </table>

  <div id="footer">
    <hr>
    Copyright 2011 Jeremy Jackson. All rights reserved.
  </div>

</body>
</html>


