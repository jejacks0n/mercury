(function(){var e={}.hasOwnProperty,t=function(t,n){function o(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return o.prototype=n.prototype,t.prototype=new o,t.__super__=n.prototype,t};Mercury.Region.Html=function(e){function n(){var e;try{window.rangy.init()}catch(t){return e=t,this.notify(this.t("requires Rangy")),!1}n.__super__.constructor.apply(this,arguments)}return t(n,e),n.define("Mercury.Region.Html","html"),n.include(Mercury.Region.Modules.DropIndicator),n.include(Mercury.Region.Modules.HtmlSelection),n.include(Mercury.Region.Modules.SelectionValue),n.include(Mercury.Region.Modules.ContentEditable),n.include(Mercury.Region.Modules.Snippetable),n.supported=Mercury.support.wysiwyg,n.events={keydown:"onKeyEvent",paste:"onPaste"},n.prototype.blur=function(){return this.saveSelection(),n.__super__.blur.apply(this,arguments)},n.prototype.onDropFile=function(e){var t,n=this;return t=new(Mercury[this.config("interface:uploader")])(e,{mimeTypes:this.options.mimeTypes}),t.on("uploaded",function(e){return n.focus(),n.handleAction("file",e)})},n.prototype.onDropItem=function(){return this.pushHistory()},n.prototype.onPaste=function(e){return console.debug("pasted",e)},n.prototype.onKeyEvent=function(e){if(!(e.keyCode>=37&&e.keyCode<=40||e.metaKey&&90===e.keyCode)){if(e.metaKey)switch(e.keyCode){case 66:return this.prevent(e),this.handleAction("bold");case 73:return this.prevent(e),this.handleAction("italic");case 85:return this.prevent(e),this.handleAction("underline")}return this.pushHistory(e.keyCode)}},n}(Mercury.Region),Mercury.Region.Html.addToolbar({defined:{style:["Style",{plugin:"styles"}],sep:" ",block:["Block Format",{plugin:"blocks"}]},color:{bgcolor:["Background Color",{plugin:"color"}],sep:" ",color:["Text Color",{plugin:"color"}]},decoration:{bold:["Bold"],italic:["Italicize"],strike:["Strikethrough"],underline:["Underline"]},script:{subscript:["Subscript"],superscript:["Superscript"]},justify:{justifyLeft:["Align Left"],justifyCenter:["Center"],justifyRight:["Align Right"],justifyFull:["Justify Full"]},list:{unorderedList:["Unordered List"],orderedList:["Numbered List"]},indent:{indent:["Increase Indentation"],outdent:["Decrease Indentation"]},rules:{rule:["Horizontal Rule",{title:"Insert a horizontal rule"}]},extra:{clean:["Remove Formatting",{title:"Remove formatting for the selection"}],sep:" ",edit:["Edit HTML",{title:"Edit the HTML content"}]},table:{rowBefore:["Insert Table Row",{title:"Insert a table row before the cursor"}],rowAfter:["Insert Table Row",{title:"Insert a table row after the cursor"}],rowDelete:["Delete Table Row",{title:"Delete this table row"}],colBefore:["Insert Table Column",{title:"Insert a table column before the cursor"}],colAfter:["Insert Table Column",{title:"Insert a table column after the cursor"}],colDelete:["Delete Table Column",{title:"Delete this table column"}],sep:" ",colIncrease:["Increase Cell Columns",{title:"Increase the cells colspan"}],colDecrease:["Decrease Cell Columns",{title:"Decrease the cells colspan and add a new cell"}],rowIncrease:["Increase Cell Rows",{title:"Increase the cells rowspan"}],rowDecrease:["Decrease Cell Rows",{title:"Decrease the cells rowspan and add a new cell"}]}}),Mercury.Region.Html.addAction({bold:function(){return this.toggleWrapSelectedWordsInClass("red")},italic:function(){return this.toggleWrapSelectedWordsInClass("highlight")},underline:function(){return this.toggleWrapSelectedWordsInClass("blue")},rule:function(){return this.replaceSelection("<hr/>")},style:function(){},link:function(e){return this.replaceSelection(e.asHtml())},table:function(e){return this.replaceSelection(e.asHtml())},media:function(e){return this.replaceSelection(e.asHtml())}})}).call(this);/**
 * Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.755
 * Build date: 29 January 2013
 */
var rangy;rangy=rangy||function(){function e(e,t){var n=typeof e[t];return n==g||!(n!=h||!e[t])||"unknown"==n}function t(e,t){return!(typeof e[t]!=h||!e[t])}function n(e,t){return typeof e[t]!=p}function o(e){return function(t,n){for(var o=n.length;o--;)if(!e(t,n[o]))return!1;return!0}}function r(e){return e&&N(e,R)&&E(e,C)}function i(e,t){t?window.alert(e):typeof window.console!=p&&typeof window.console.log!=p&&window.console.log(e)}function a(e){w.initialized=!0,w.supported=!1,i("Rangy is not supported on this page in your browser. Reason: "+e,w.config.alertOnFail)}function s(e){i("Rangy warning: "+e,w.config.alertOnWarn)}function c(n){t(window,"console")&&e(window.console,"log")&&window.console.log(n)}function d(e){return e.message||e.description||String(e)}function l(){if(!w.initialized){var n,o=!1,i=!1;e(document,"createRange")&&(n=document.createRange(),N(n,v)&&E(n,m)&&(o=!0),n.detach());var s=t(document,"body")?document.body:document.getElementsByTagName("body")[0];if(!s||"body"!=s.nodeName.toLowerCase())return a("No body element found"),void 0;if(s&&e(s,"createTextRange")&&(n=s.createTextRange(),r(n)&&(i=!0)),!o&&!i)return a("Neither Range nor TextRange are available"),void 0;w.initialized=!0,w.features={implementsDomRange:o,implementsTextRange:i};var l,u;for(var h in S)(l=S[h])instanceof f&&l.init();for(var g=0,p=O.length;p>g;++g)try{O[g](w)}catch(C){u="Rangy init listener threw an exception. Continuing. Detail: "+d(C),c(u)}}}function u(e){e=e||window,l();for(var t=0,n=D.length;n>t;++t)D[t](e)}function f(e,t){this.name=e,this.initialized=!1,this.supported=!1,this.init=t}var h="object",g="function",p="undefined",m=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],v=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],C=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],R=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],N=o(e),y=o(t),E=o(n),S={},w={version:"1.3alpha.755",initialized:!1,supported:!0,util:{isHostMethod:e,isHostObject:t,isHostProperty:n,areHostMethods:N,areHostObjects:y,areHostProperties:E,isTextRange:r},features:{},modules:S,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};w.fail=a,w.warn=s,{}.hasOwnProperty?w.util.extend=function(e,t,n){var o,r;for(var i in t)t.hasOwnProperty(i)&&(o=e[i],r=t[i],n&&null!==o&&"object"==typeof o&&null!==r&&"object"==typeof r&&w.util.extend(o,r,!0),e[i]=r);return e}:a("hasOwnProperty not supported"),function(){var e=document.createElement("div");e.appendChild(document.createElement("span"));var t,n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(e){return n.call(e,0)})}catch(o){}t||(t=function(e){for(var t=[],n=0,o=e.length;o>n;++n)t[n]=e[n];return t}),w.util.toArray=t}();var T;e(document,"addEventListener")?T=function(e,t,n){e.addEventListener(t,n,!1)}:e(document,"attachEvent")?T=function(e,t,n){e.attachEvent("on"+t,n)}:a("Document does not have required addEventListener or attachEvent method"),w.util.addListener=T;var O=[];w.init=l,w.addInitListener=function(e){w.initialized?e(w):O.push(e)};var D=[];w.addCreateMissingNativeApiListener=function(e){D.push(e)},w.createMissingNativeApi=u,f.prototype={fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){w.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){w.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},w.createModule=function(e,t){var n=new f(e,function(){if(!n.initialized){n.initialized=!0;try{t(w,n),n.supported=!0}catch(o){var r="Module '"+e+"' failed to load: "+d(o);c(r)}}});S[e]=n},w.requireModules=function(e){for(var t,n,o=0,r=e.length;r>o;++o){if(n=e[o],t=S[n],!(t&&t instanceof f))throw new Error("required module '"+n+"' not found");if(t.init(),!t.supported)throw new Error("required module '"+n+"' not supported")}};var A=!1,_=function(){A||(A=!0,w.initialized||l())};return typeof window==p?(a("No window found"),void 0):typeof document==p?(a("No document found"),void 0):(e(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",_,!1),T(window,"load",_),w)}(),rangy.createModule("DomUtil",function(e,t){function n(e){var t;return typeof e.namespaceURI==_||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function o(e){var t=e.parentNode;return 1==t.nodeType?t:null}function r(e){for(var t=0;e=e.previousSibling;)++t;return t}function i(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function a(e,t){var n,o=[];for(n=e;n;n=n.parentNode)o.push(n);for(n=t;n;n=n.parentNode)if(M(o,n))return n;return null}function s(e,t,n){for(var o=n?t:t.parentNode;o;){if(o===e)return!0;o=o.parentNode}return!1}function c(e,t){return s(e,t,!0)}function d(e,t,n){for(var o,r=n?e:e.parentNode;r;){if(o=r.parentNode,o===t)return r;r=o}return null}function l(e){var t=e.nodeType;return 3==t||4==t||8==t}function u(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function f(e,t){var n=t.nextSibling,o=t.parentNode;return n?o.insertBefore(e,n):o.appendChild(e),e}function h(e,t,n){var o=e.cloneNode(!1);if(o.deleteData(0,t),e.deleteData(t,e.length-t),f(o,e),n)for(var i,a=0;i=n[a++];)i.node==e&&i.offset>t?(i.node=o,i.offset-=t):i.node==e.parentNode&&i.offset>r(e)&&++i.offset;return o}function g(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=_)return e.ownerDocument;if(typeof e.document!=_)return e.document;if(e.parentNode)return g(e.parentNode);throw t.createError("getDocument: no document found for node")}function p(e){var n=g(e);if(typeof n.defaultView!=_)return n.defaultView;if(typeof n.parentWindow!=_)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function m(e){if(typeof e.contentDocument!=_)return e.contentDocument;if(typeof e.contentWindow!=_)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function v(e){if(typeof e.contentWindow!=_)return e.contentWindow;if(typeof e.contentDocument!=_)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function C(e){return b.isHostObject(e,"body")?e.body:e.getElementsByTagName("body")[0]}function R(e){return e&&b.isHostMethod(e,"setTimeout")&&b.isHostObject(e,"document")}function N(e,t,n){var o;if(e?b.isHostProperty(e,"nodeType")?o=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?m(e):g(e):R(e)&&(o=e.document):o=document,!o)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return o}function y(e){for(var t;t=e.parentNode;)e=t;return e}function E(e,n,o,i){var s,c,l,u,f;if(e==o)return n===i?0:i>n?-1:1;if(s=d(o,e,!0))return n<=r(s)?-1:1;if(s=d(e,o,!0))return r(s)<i?-1:1;if(c=a(e,o),l=e===c?c:d(e,c,!0),u=o===c?c:d(o,c,!0),l===u)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(f=c.firstChild;f;){if(f===l)return-1;if(f===u)return 1;f=f.nextSibling}}function S(e){if(!e)return"[No node]";if(l(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">["+e.childNodes.length+"]["+e.innerHTML.slice(0,20)+"]"}return e.nodeName}function w(e){for(var t,n=g(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function T(e){this.root=e,this._next=e}function O(e){return new T(e)}function D(e,t){this.node=e,this.offset=t}function A(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var _="undefined",b=e.util;b.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),b.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var x=document.createElement("div");b.areHostMethods(x,["insertBefore","appendChild","cloneNode"]||!b.areHostObjects(x,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),b.isHostProperty(x,"innerHTML")||t.fail("Element is missing innerHTML property");var I=document.createTextNode("test");b.areHostMethods(I,["splitText","deleteData","insertData","appendData","cloneNode"]||!b.areHostObjects(x,["previousSibling","nextSibling","childNodes","parentNode"])||!b.areHostProperties(I,["data"]))||t.fail("Incomplete Text Node implementation");var P,M=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1};typeof window.getComputedStyle!=_?P=function(e,t){return p(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=_?P=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),T.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},D.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+S(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},A.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},A.prototype.toString=function(){return this.message},e.dom={arrayContains:M,isHtmlNamespace:n,parentElement:o,getNodeIndex:r,getNodeLength:i,getCommonAncestor:a,isAncestorOf:s,isOrIsAncestorOf:c,getClosestAncestorIn:d,isCharacterDataNode:l,isTextOrCommentNode:u,insertAfter:f,splitDataNode:h,getDocument:g,getWindow:p,getIframeWindow:v,getIframeDocument:m,getBody:C,isWindow:R,getContentDocument:N,getRootContainer:y,comparePoints:E,inspectNode:S,getComputedStyleProperty:P,fragmentFromNodeChildren:w,createIterator:O,DomPosition:D},e.DOMException=A}),rangy.createModule("DomRange",function(e){function t(e,t){return 3!=e.nodeType&&(W.isOrIsAncestorOf(e,t.startContainer)||W.isOrIsAncestorOf(e,t.endContainer))}function n(e){return W.getDocument(e.startContainer)}function o(e){return new k(e.parentNode,W.getNodeIndex(e))}function r(e){return new k(e.parentNode,W.getNodeIndex(e)+1)}function i(e,t,n){var o=11==e.nodeType?e.firstChild:e;return W.isCharacterDataNode(t)?n==t.length?W.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:W.splitDataNode(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),o}function a(e,t,o){if(O(e),O(t),n(t)!=n(e))throw new j("WRONG_DOCUMENT_ERR");var r=W.comparePoints(e.startContainer,e.startOffset,t.endContainer,t.endOffset),i=W.comparePoints(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return o?0>=r&&i>=0:0>r&&i>0}function s(e){for(var t,o,r,i=n(e.range).createDocumentFragment();o=e.next();){if(t=e.isPartiallySelectedSubtree(),o=o.cloneNode(!t),t&&(r=e.getSubtreeIterator(),o.appendChild(s(r)),r.detach(!0)),10==o.nodeType)throw new j("HIERARCHY_REQUEST_ERR");i.appendChild(o)}return i}function c(e,t,n){var o,r;n=n||{stop:!1};for(var i,a;i=e.next();)if(e.isPartiallySelectedSubtree()){if(t(i)===!1)return n.stop=!0,void 0;if(a=e.getSubtreeIterator(),c(a,t,n),a.detach(!0),n.stop)return}else for(o=W.createIterator(i);r=o.next();)if(t(r)===!1)return n.stop=!0,void 0}function d(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),d(t),t.detach(!0)):e.remove()}function l(e){for(var t,o,r=n(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),o=e.getSubtreeIterator(),t.appendChild(l(o)),o.detach(!0)):e.remove(),10==t.nodeType)throw new j("HIERARCHY_REQUEST_ERR");r.appendChild(t)}return r}function u(e,t,n){var o,r=!(!t||!t.length),i=!!n;r&&(o=new RegExp("^("+t.join("|")+")$"));var a=[];return c(new h(e,!1),function(e){r&&!o.test(e.nodeType)||i&&!n(e)||a.push(e)}),a}function f(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+W.inspectNode(e.startContainer)+":"+e.startOffset+", "+W.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function h(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&W.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||W.isCharacterDataNode(this.sc)?W.getClosestAncestorIn(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||W.isCharacterDataNode(this.ec)?W.getClosestAncestorIn(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function g(e){this.code=this[e],this.codeName=e,this.message="RangeException: "+this.codeName}function p(e){return function(t,n){for(var o,r=n?t:t.parentNode;r;){if(o=r.nodeType,W.arrayContains(e,o))return r;r=r.parentNode}return null}}function m(e,t){if(Q(e,t))throw new g("INVALID_NODE_TYPE_ERR")}function v(e){if(!e.startContainer)throw new j("INVALID_STATE_ERR")}function C(e,t){if(!W.arrayContains(t,e.nodeType))throw new g("INVALID_NODE_TYPE_ERR")}function R(e,t){if(0>t||t>(W.isCharacterDataNode(e)?e.length:e.childNodes.length))throw new j("INDEX_SIZE_ERR")}function N(e,t){if($(e,!0)!==$(t,!0))throw new j("WRONG_DOCUMENT_ERR")}function y(e){if(G(e,!0))throw new j("NO_MODIFICATION_ALLOWED_ERR")}function E(e,t){if(!e)throw new j(t)}function S(e){return!W.arrayContains(z,e.nodeType)&&!$(e,!0)}function w(e,t){return t<=(W.isCharacterDataNode(e)?e.length:e.childNodes.length)}function T(e){return!!e.startContainer&&!!e.endContainer&&!S(e.startContainer)&&!S(e.endContainer)&&w(e.startContainer,e.startOffset)&&w(e.endContainer,e.endOffset)}function O(e){if(v(e),!T(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function D(e,t){O(e);var n=e.startContainer,o=e.startOffset,r=e.endContainer,i=e.endOffset,a=n===r;W.isCharacterDataNode(r)&&i>0&&i<r.length&&W.splitDataNode(r,i,t),W.isCharacterDataNode(n)&&o>0&&o<n.length&&(n=W.splitDataNode(n,o,t),a?(i-=o,r=n):r==n.parentNode&&i>=W.getNodeIndex(n)&&i++,o=0),e.setStartAndEnd(n,o,r,i)}function A(){}function _(e){e.START_TO_START=tt,e.START_TO_END=nt,e.END_TO_END=ot,e.END_TO_START=rt,e.NODE_BEFORE=it,e.NODE_AFTER=at,e.NODE_BEFORE_AND_AFTER=st,e.NODE_INSIDE=ct}function b(e){_(e),_(e.prototype)}function x(e,t){return function(){O(this);var n,o,i=this.startContainer,a=this.startOffset,s=this.commonAncestorContainer,d=new h(this,!0);i!==s&&(n=W.getClosestAncestorIn(i,s,!0),o=r(n),i=o.node,a=o.offset),c(d,y),d.reset();var l=e(d);return d.detach(),t(this,i,a,i,a),l}}function I(e,n,i){function a(e,t){return function(n){v(this),C(n,F),C(Y(n),z);var i=(e?o:r)(n);(t?s:c)(this,i.node,i.offset)}}function s(e,t,o){var r=e.endContainer,i=e.endOffset;(t!==e.startContainer||o!==e.startOffset)&&((Y(t)!=Y(r)||1==W.comparePoints(t,o,r,i))&&(r=t,i=o),n(e,t,o,r,i))}function c(e,t,o){var r=e.startContainer,i=e.startOffset;(t!==e.endContainer||o!==e.endOffset)&&((Y(t)!=Y(r)||-1==W.comparePoints(t,o,r,i))&&(r=t,i=o),n(e,r,i,t,o))}e.prototype=new A,L.extend(e.prototype,{setStart:function(e,t){v(this),m(e,!0),R(e,t),s(this,e,t)},setEnd:function(e,t){v(this),m(e,!0),R(e,t),c(this,e,t)},setStartAndEnd:function(){v(this);var e=arguments,t=e[0],o=e[1],r=t,i=o;switch(e.length){case 3:i=e[2];break;case 4:r=e[2],i=e[3]}n(this,t,o,r,i)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:a(!0,!0),setStartAfter:a(!1,!0),setEndBefore:a(!0,!1),setEndAfter:a(!1,!1),collapse:function(e){O(this),e?n(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):n(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){v(this),m(e,!0),n(this,e,0,e,W.getNodeLength(e))},selectNode:function(e){v(this),m(e,!1),C(e,F);var t=o(e),i=r(e);n(this,t.node,t.offset,i.node,i.offset)},extractContents:x(l,n),deleteContents:x(d,n),canSurroundContents:function(){O(this),y(this.startContainer),y(this.endContainer);var e=new h(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},detach:function(){i(this)},splitBoundaries:function(){D(this)},splitBoundariesPreservingPositions:function(e){D(this,e)},normalizeBoundaries:function(){O(this);var e=this.startContainer,t=this.startOffset,o=this.endContainer,r=this.endOffset,i=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(o=e,r=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},a=function(n){var i=n.previousSibling;if(i&&i.nodeType==n.nodeType){e=n;var a=n.length;if(t=i.length,n.insertData(0,i.data),i.parentNode.removeChild(i),e==o)r+=t,o=e;else if(o==n.parentNode){var s=W.getNodeIndex(n);r==s?(o=n,r=a):r>s&&r--}}},s=!0;if(W.isCharacterDataNode(o))o.length==r&&i(o);else{if(r>0){var c=o.childNodes[r-1];c&&W.isCharacterDataNode(c)&&i(c)}s=!this.collapsed}if(s){if(W.isCharacterDataNode(e))0==t&&a(e);else if(t<e.childNodes.length){var d=e.childNodes[t];d&&W.isCharacterDataNode(d)&&a(d)}}else e=o,t=r;n(this,e,t,o,r)},collapseToPoint:function(e,t){v(this),m(e,!0),R(e,t),this.setStartAndEnd(e,t)}}),b(e)}function P(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:W.getCommonAncestor(e.startContainer,e.endContainer)}function M(e,t,n,o,r){e.startContainer=t,e.startOffset=n,e.endContainer=o,e.endOffset=r,P(e)}function H(e){v(e),e.startContainer=e.startOffset=e.endContainer=e.endOffset=null,e.collapsed=e.commonAncestorContainer=null}function B(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,P(this)}e.requireModules(["DomUtil"]);var W=e.dom,L=e.util,k=W.DomPosition,j=e.DOMException;h.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,W.isCharacterDataNode(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!W.isCharacterDataNode(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return t(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new B(n(this.range));var t=this._current,o=t,r=0,i=t,a=W.getNodeLength(t);W.isOrIsAncestorOf(t,this.sc)&&(o=this.sc,r=this.so),W.isOrIsAncestorOf(t,this.ec)&&(i=this.ec,a=this.eo),M(e,o,r,i,a)}return new h(e,this.clonePartiallySelectedTextNodes)},detach:function(e){e&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},g.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},g.prototype.toString=function(){return this.message};var F=[1,3,4,5,7,8,10],z=[2,9,11],U=[5,6,10,12],V=[1,3,4,5,7,8,10,11],q=[1,3,4,5,7,8],Y=W.getRootContainer,$=p([9,11]),G=p(U),Q=p([6,10,12]),K=document.createElement("style"),X=!1;try{K.innerHTML="<b>x</b>",X=3==K.firstChild.nodeType}catch(Z){}e.features.htmlParsingConforms=X;var J=X?function(e){var t=this.startContainer,n=W.getDocument(t);if(!t)throw new j("INVALID_STATE_ERR");var o=null;return 1==t.nodeType?o=t:W.isCharacterDataNode(t)&&(o=W.parentElement(t)),o=null===o||"HTML"==o.nodeName&&W.isHtmlNamespace(W.getDocument(o).documentElement)&&W.isHtmlNamespace(o)?n.createElement("body"):o.cloneNode(!1),o.innerHTML=e,W.fragmentFromNodeChildren(o)}:function(e){v(this);var t=n(this),o=t.createElement("body");return o.innerHTML=e,W.fragmentFromNodeChildren(o)},et=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],tt=0,nt=1,ot=2,rt=3,it=0,at=1,st=2,ct=3;A.prototype={compareBoundaryPoints:function(e,t){O(this),N(this.startContainer,t.startContainer);var n,o,r,i,a=e==rt||e==tt?"start":"end",s=e==nt||e==tt?"start":"end";return n=this[a+"Container"],o=this[a+"Offset"],r=t[s+"Container"],i=t[s+"Offset"],W.comparePoints(n,o,r,i)},insertNode:function(e){if(O(this),C(e,V),y(this.startContainer),W.isOrIsAncestorOf(e,this.startContainer))throw new j("HIERARCHY_REQUEST_ERR");var t=i(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){O(this);var e,t;if(this.collapsed)return n(this).createDocumentFragment();if(this.startContainer===this.endContainer&&W.isCharacterDataNode(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=n(this).createDocumentFragment(),t.appendChild(e),t;var o=new h(this,!0);return e=s(o),o.detach(),e},canSurroundContents:function(){O(this),y(this.startContainer),y(this.endContainer);var e=new h(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},surroundContents:function(e){if(C(e,q),!this.canSurroundContents())throw new g("BAD_BOUNDARYPOINTS_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);i(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){O(this);for(var e,t=new B(n(this)),o=et.length;o--;)e=et[o],t[e]=this[e];return t},toString:function(){O(this);var e=this.startContainer;if(e===this.endContainer&&W.isCharacterDataNode(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new h(this,!0);return c(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){O(this);var t=e.parentNode,n=W.getNodeIndex(e);if(!t)throw new j("NOT_FOUND_ERR");var o=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return 0>o?r>0?st:it:r>0?at:ct},comparePoint:function(e,t){return O(this),E(e,"HIERARCHY_REQUEST_ERR"),N(e,this.startContainer),W.comparePoints(e,t,this.startContainer,this.startOffset)<0?-1:W.comparePoints(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:J,toHtml:function(){O(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(O(this),E(e,"NOT_FOUND_ERR"),W.getDocument(e)!==n(this))return!1;var o=e.parentNode,r=W.getNodeIndex(e);E(o,"NOT_FOUND_ERR");var i=W.comparePoints(o,r,this.endContainer,this.endOffset),a=W.comparePoints(o,r+1,this.startContainer,this.startOffset);return t?0>=i&&a>=0:0>i&&a>0},isPointInRange:function(e,t){return O(this),E(e,"HIERARCHY_REQUEST_ERR"),N(e,this.startContainer),W.comparePoints(e,t,this.startContainer,this.startOffset)>=0&&W.comparePoints(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return a(this,e,!1)},intersectsOrTouchesRange:function(e){return a(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=W.comparePoints(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=W.comparePoints(this.endContainer,this.endOffset,e.endContainer,e.endOffset),o=this.cloneRange();return-1==t&&o.setStart(e.startContainer,e.startOffset),1==n&&o.setEnd(e.endContainer,e.endOffset),o}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==W.comparePoints(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==W.comparePoints(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new g("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==ct},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,W.getNodeLength(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var o=n.pop();t.setEnd(o,o.length);var r=this.containsRange(t);return t.detach(),r}return this.containsNodeContents(e)},getNodes:function(e,t){return O(this),u(this,e,t)},getDocument:function(){return n(this)},collapseBefore:function(e){v(this),this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){v(this),this.setStartAfter(e),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(e){return B.rangesEqual(this,e)},isValid:function(){return T(this)},inspect:function(){return f(this)}},I(B,M,H),e.rangePrototype=A.prototype,L.extend(B,{rangeProperties:et,RangeIterator:h,copyComparisonConstants:b,createPrototypeRange:I,inspect:f,getRangeDocument:n,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=B,e.RangeException=g}),rangy.createModule("WrappedRange",function(e,t){e.requireModules(["DomUtil","DomRange"]);var n,o,r=e.dom,i=e.util,a=r.DomPosition,s=e.DomRange;if(e.features.implementsDomRange&&!function(){function o(e){for(var t,n=u.length;n--;)t=u[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,o,r){var i=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==o||e.endOffset!=r,s=!e.equals(e.nativeRange);(i||a||s)&&(e.setEnd(o,r),e.setStart(t,n))}function c(e){e.nativeRange.detach(),e.detached=!0;for(var t=u.length;t--;)e[u[t]]=null}var d,l,u=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,o(this)},s.createPrototypeRange(n,a,c),d=n.prototype,d.selectNode=function(e){this.nativeRange.selectNode(e),o(this)},d.cloneContents=function(){return this.nativeRange.cloneContents()},d.surroundContents=function(e){this.nativeRange.surroundContents(e),o(this)},d.collapse=function(e){this.nativeRange.collapse(e),o(this)},d.cloneRange=function(){return new n(this.nativeRange.cloneRange())},d.refresh=function(){o(this)},d.toString=function(){return this.nativeRange.toString()};var f=document.createTextNode("test");r.getBody(document).appendChild(f);var h=document.createRange();h.setStart(f,0),h.setEnd(f,0);try{h.setStart(f,1),d.setStart=function(e,t){this.nativeRange.setStart(e,t),o(this)},d.setEnd=function(e,t){this.nativeRange.setEnd(e,t),o(this)},l=function(e){return function(t){this.nativeRange[e](t),o(this)}}}catch(g){d.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}o(this)},d.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}o(this)},l=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(r){this.nativeRange[t](n),this.nativeRange[e](n)}o(this)}}}d.setStartBefore=l("setStartBefore","setEndBefore"),d.setStartAfter=l("setStartAfter","setEndAfter"),d.setEndBefore=l("setEndBefore","setStartBefore"),d.setEndAfter=l("setEndAfter","setStartAfter"),h.selectNodeContents(f),d.selectNodeContents=h.startContainer==f&&h.endContainer==f&&0==h.startOffset&&h.endOffset==f.length?function(e){this.nativeRange.selectNodeContents(e),o(this)}:function(e){this.setStartAndEnd(e,0,r.getNodeLength(e))},h.selectNodeContents(f),h.setEnd(f,3);var p=document.createRange();p.selectNodeContents(f),p.setEnd(f,4),p.setStart(f,2),d.compareBoundaryPoints=-1==h.compareBoundaryPoints(h.START_TO_END,p)&&1==h.compareBoundaryPoints(h.END_TO_START,p)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var m=document.createElement("div");m.innerHTML="123";var v=m.firstChild;document.body.appendChild(m),h.setStart(v,1),h.setEnd(v,2),h.deleteContents(),"13"==v.data&&(d.deleteContents=function(){this.nativeRange.deleteContents(),o(this)},d.extractContents=function(){var e=this.nativeRange.extractContents();return o(this),e}),document.body.removeChild(m),i.isHostMethod(h,"createContextualFragment")&&(d.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),r.getBody(document).removeChild(f),h.detach(),p.detach(),d.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=r.getContentDocument(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var c=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var o=n.parentElement();n=e.duplicate(),n.collapse(!1);var i=n.parentElement(),a=o==i?o:r.getCommonAncestor(o,i);return a==t?a:r.getCommonAncestor(t,a)},d=function(e){return 0==e.compareEndPoints("StartToEnd",e)},l=function(e,t,n,o,i){var s=e.duplicate();s.collapse(n);var c=s.parentElement();if(r.isOrIsAncestorOf(t,c)||(c=t),!c.canHaveHTML){var d=new a(c.parentNode,r.getNodeIndex(c));return{boundaryPosition:d,nodeInfo:{nodeIndex:d.offset,containerElement:d.node}}}var l=r.getDocument(c).createElement("span");l.parentNode&&l.parentNode.removeChild(l);for(var u,f,h,g,p,m=n?"StartToStart":"StartToEnd",v=i&&i.containerElement==c?i.nodeIndex:0,C=c.childNodes.length,R=C,N=R;;){if(N==C?c.appendChild(l):c.insertBefore(l,c.childNodes[N]),s.moveToElementText(l),u=s.compareEndPoints(m,e),0==u||v==R)break;if(-1==u){if(R==v+1)break;v=N}else R=R==v+1?v:N;N=Math.floor((v+R)/2),c.removeChild(l)}if(p=l.nextSibling,-1==u&&p&&r.isCharacterDataNode(p)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var y;if(/[\r\n]/.test(p.data)){var E=s.duplicate(),S=E.text.replace(/\r\n/g,"\r").length;for(y=E.moveStart("character",S);-1==(u=E.compareEndPoints("StartToEnd",E));)y++,E.moveStart("character",1)}else y=s.text.length;g=new a(p,y)}else f=(o||!n)&&l.previousSibling,h=(o||n)&&l.nextSibling,g=h&&r.isCharacterDataNode(h)?new a(h,0):f&&r.isCharacterDataNode(f)?new a(f,f.data.length):new a(c,r.getNodeIndex(l));return l.parentNode.removeChild(l),{boundaryPosition:g,nodeInfo:{nodeIndex:N,containerElement:c}}},u=function(e,t){var n,o,i,a,s=e.offset,c=r.getDocument(e.node),d=c.body.createTextRange(),l=r.isCharacterDataNode(e.node);return l?(n=e.node,o=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,o=e.node),i=c.createElement("span"),i.innerHTML="&#feff;",n?o.insertBefore(i,n):o.appendChild(i),d.moveToElementText(i),d.collapse(!t),o.removeChild(i),l&&d[t?"moveStart":"moveEnd"]("character",s),d};if(o=function(e){this.textRange=e,this.refresh()},o.prototype=new s(document),o.prototype.refresh=function(){var e,t,n,o=c(this.textRange);d(this.textRange)?t=e=l(this.textRange,o,!0,!0).boundaryPosition:(n=l(this.textRange,o,!0,!1),e=n.boundaryPosition,t=l(this.textRange,o,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},o.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(o),o.rangeToTextRange=function(e){if(e.collapsed)return u(new a(e.startContainer,e.startOffset),!0);var t=u(new a(e.startContainer,e.startOffset),!0),n=u(new a(e.endContainer,e.endOffset),!1),o=r.getDocument(e.startContainer).body.createTextRange();return o.setEndPoint("StartToStart",t),o.setEndPoint("EndToEnd",n),o},e.WrappedTextRange=o,!e.features.implementsDomRange||e.config.preferTextRange){var f=function(){return this}();"undefined"==typeof f.Range&&(f.Range=o),e.createNativeRange=function(e){return e=r.getContentDocument(e,t,"createNativeRange"),e.body.createTextRange()},e.WrappedRange=o}}e.createRange=function(n){return n=r.getContentDocument(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=r.getContentDocument(e,t,"createRangyRange"),new s(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addCreateMissingNativeApiListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)
}),n=t=null})}),rangy.createModule("WrappedSelection",function(e,t){function n(e){return"string"==typeof e?"backward"==e:!!e}function o(e,n){if(e){if(O.isWindow(e))return e;if(e instanceof m)return e.win;var o=O.getContentDocument(e,t,n);return O.getWindow(o)}return window}function r(e){return o(e,"getWinSelection").getSelection()}function i(e){return o(e,"getDocSelection").document.selection}function a(e,t,n){var o=n?"end":"start",r=n?"start":"end";e.anchorNode=t[o+"Container"],e.anchorOffset=t[o+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function s(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function c(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function d(t){var n;return t instanceof _?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof b?n=t.nativeRange:P.implementsDomRange&&t instanceof O.getWindow(t.startContainer).Range&&(n=t),n}function l(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!O.isAncestorOf(e[0],e[t]))return!1;return!0}function u(e){var n=e.getNodes();if(!l(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function f(e){return!!e&&"undefined"!=typeof e.text}function h(e,t){var n=new b(t);e._ranges=[n],a(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function g(t){if(t._ranges.length=0,"None"==t.docSelection.type)c(t);else{var n=t.docSelection.createRange();if(f(n))h(t,n);else{t.rangeCount=n.length;for(var o,r=H(n.item(0)),i=0;i<t.rangeCount;++i)o=e.createRange(r),o.selectNode(n.item(i)),t._ranges.push(o);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,a(t,t._ranges[t.rangeCount-1],!1)}}}function p(e,n){for(var o=e.docSelection.createRange(),r=u(n),i=H(o.item(0)),a=O.getBody(i).createControlRange(),s=0,c=o.length;c>s;++s)a.add(o.item(s));try{a.add(r)}catch(d){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),g(e)}function m(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function v(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function C(e,t){for(var n,o,r=K.length;r--;)if(n=K[r],o=n.selection,"deleteAll"==t)v(o);else if(n.win==e)return"delete"==t?(K.splice(r,1),!0):o;return"deleteAll"==t&&(K.length=0),null}function R(e,n){for(var o,r=H(n[0].startContainer),i=O.getBody(r).createControlRange(),a=0;rangeCount>a;++a){o=u(n[a]);try{i.add(o)}catch(s){throw t.createError("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}i.select(),g(e)}function N(e,t){if(e.anchorNode&&H(e.anchorNode)!==H(t))throw new x("WRONG_DOCUMENT_ERR")}function y(t){return function(n,o){var r;this.rangeCount?(r=this.getRangeAt(0),r["set"+(t?"Start":"End")](n,o)):(r=e.createRange(this.win.document),r.setStartAndEnd(n,o)),this.setSingleRange(r,this.isBackward())}}function E(e){var t=[],n=new I(e.anchorNode,e.anchorOffset),o=new I(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var i=0,a=e.rangeCount;a>i;++i)t[i]=_.inspect(e.getRangeAt(i));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+o.inspect()+"]"}e.requireModules(["DomUtil","DomRange","WrappedRange"]),e.config.checkSelectionRanges=!0;var S,w,T="boolean",O=e.dom,D=e.util,A=D.isHostMethod,_=e.DomRange,b=e.WrappedRange,x=e.DOMException,I=O.DomPosition,P=e.features,M="Control",H=O.getDocument,B=A(window,"getSelection"),W=D.isHostObject(document,"selection");P.implementsWinGetSelection=B,P.implementsDocSelection=W;var L=W&&(!B||e.config.preferTextRange);L?(S=i,e.isSelectionValid=function(e){var t=o(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||H(n.createRange().parentElement())==t}):B?(S=r,e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=S;var k=S(),j=e.createNativeRange(document),F=O.getBody(document),z=D.areHostProperties(k,["anchorNode","focusNode","anchorOffset","focusOffset"]);P.selectionHasAnchorAndFocus=z;var U=A(k,"extend");P.selectionHasExtend=U;var V="number"==typeof k.rangeCount;P.selectionHasRangeCount=V;var q=!1,Y=!0;D.areHostMethods(k,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof k.rangeCount&&P.implementsDomRange&&!function(){var e=window.getSelection();if(e){var t=O.getBody(document),n=t.appendChild(document.createElement("div"));n.contentEditable="false";var o=n.appendChild(document.createTextNode("   ")),r=document.createRange();r.setStart(o,1),r.collapse(!0),e.addRange(r),Y=1==e.rangeCount,e.removeAllRanges();var i=r.cloneRange();r.setStart(o,0),i.setEnd(o,3),i.setStart(o,2),e.addRange(r),e.addRange(i),q=2==e.rangeCount,t.removeChild(n),e.removeAllRanges(),r.detach(),i.detach()}}(),P.selectionSupportsMultipleRanges=q,P.collapsedNonEditableSelectionsSupported=Y;var $,G=!1;F&&A(F,"createControlRange")&&($=F.createControlRange(),D.areHostProperties($,["item","add"])&&(G=!0)),P.implementsControlRange=G,w=z?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var Q;A(k,"getRangeAt")?Q=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:z&&(Q=function(t){var n=H(t.anchorNode),o=e.createRange(n);return o.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),o.collapsed!==this.isCollapsed&&o.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),o});var K=[],X=function(e){if(e&&e instanceof m)return e.refresh(),e;e=o(e,"getNativeSelection");var t=C(e),n=S(e),r=W?i(e):null;return t?(t.nativeSelection=n,t.docSelection=r,t.refresh()):(t=new m(n,r,e),K.push({win:e,selection:t})),t};e.getSelection=X,e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(O.getIframeWindow(n))};var Z=m.prototype;if(!L&&z&&D.areHostMethods(k,["removeAllRanges","addRange"])){Z.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),c(this)};var J=function(t,n){var o=_.getRangeDocument(n),r=e.createRange(o);r.collapseToPoint(n.endContainer,n.endOffset),t.nativeSelection.addRange(d(r)),t.nativeSelection.extend(n.startContainer,n.startOffset),t.refresh()};Z.addRange=V?function(t,o){if(G&&W&&this.docSelection.type==M)p(this,t);else if(n(o)&&U)J(this,t);else{var r;if(q?r=this.rangeCount:(this.removeAllRanges(),r=0),this.nativeSelection.addRange(d(t).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==r+1){if(e.config.checkSelectionRanges){var i=Q(this.nativeSelection,this.rangeCount-1);i&&!_.rangesEqual(i,t)&&(t=new b(i))}this._ranges[this.rangeCount-1]=t,a(this,t,nt(this.nativeSelection)),this.isCollapsed=w(this)}else this.refresh()}}:function(e,t){n(t)&&U?J(this,e):(this.nativeSelection.addRange(d(e)),this.refresh())},Z.setRanges=function(e){if(G&&e.length>1)R(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(A(k,"empty")&&A(j,"select")&&G&&L))return t.fail("No means of selecting a Range or TextRange was found"),!1;Z.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=H(this.anchorNode);else if(this.docSelection.type==M){var t=this.docSelection.createRange();t.length&&(e=H(t.item(0)).body.createTextRange())}if(e){var n=e.body.createTextRange();n.select(),this.docSelection.empty()}}}catch(o){}c(this)},Z.addRange=function(e){this.docSelection.type==M?p(this,e):(b.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,a(this,e,!1))},Z.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?R(this,e):t&&this.addRange(e[0])}}Z.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new x("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var et;if(L)et=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=O.getBody(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==M?g(t):f(n)?h(t,n):c(t)};else if(A(k,"getRangeAt")&&"number"==typeof k.rangeCount)et=function(t){if(G&&W&&t.docSelection.type==M)g(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,o=t.rangeCount;o>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));a(t,t._ranges[t.rangeCount-1],nt(t.nativeSelection)),t.isCollapsed=w(t)}else c(t)};else{if(!z||typeof k.isCollapsed!=T||typeof j.collapsed!=T||!P.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;et=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=Q(n,0),e._ranges=[t],e.rangeCount=1,s(e),e.isCollapsed=w(e)):c(e)}}Z.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,o=this.anchorOffset;if(et(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=o)return!0;for(;r--;)if(!_.rangesEqual(t[r],this._ranges[r]))return!0;return!1}};var tt=function(t,n){var o=t.getAllRanges();t.removeAllRanges();for(var r=0,i=o.length;i>r;++r)e.DomRange.rangesEqual(n,o[r])||t.addRange(o[r]);t.rangeCount||c(t)};Z.removeRange=G?function(e){if(this.docSelection.type==M){for(var t,n=this.docSelection.createRange(),o=u(e),r=H(n.item(0)),i=O.getBody(r).createControlRange(),a=!1,s=0,c=n.length;c>s;++s)t=n.item(s),t!==o||a?i.add(n.item(s)):a=!0;i.select(),g(this)}else tt(this,e)}:function(e){tt(this,e)};var nt;!L&&z&&P.implementsDomRange?(nt=function(e){var t=!1;return e.anchorNode&&(t=1==O.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t},Z.isBackward=function(){return nt(this)}):nt=Z.isBackward=function(){return!1},Z.isBackwards=Z.isBackward,Z.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},Z.collapse=function(t,n){N(this,t);var o=e.createRange(t);o.collapseToPoint(t,n),this.setSingleRange(o),this.isCollapsed=!0},Z.collapseToStart=function(){if(!this.rangeCount)throw new x("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},Z.collapseToEnd=function(){if(!this.rangeCount)throw new x("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},Z.selectAllChildren=function(t){N(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.removeAllRanges(),this.addRange(n)},Z.deleteFromDocument=function(){if(G&&W&&this.docSelection.type==M){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var o=0,r=n.length;r>o;++o)n[o].deleteContents();this.addRange(n[r-1])}}},Z.eachRange=function(e,t){for(var n=0,o=this._ranges.length;o>n;++n)if(e(this.getRangeAt(n)))return t},Z.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},Z.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},Z.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(o){n.push(o[e](t))}),n},Z.setStart=y(!0),Z.setEnd=y(!1),e.rangePrototype.select=function(e){X(this.getDocument()).setSingleRange(this,e)},Z.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},Z.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)},Z.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},Z.getName=function(){return"WrappedSelection"},Z.inspect=function(){return E(this)},Z.detach=function(){C(this.win,"delete"),v(this)},m.detachAll=function(){C(null,"deleteAll")},m.inspect=E,m.isDirectionBackward=n,e.Selection=m,e.selectionPrototype=Z,e.addCreateMissingNativeApiListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return X(e)}),e=null})}),/**
 * Serializer module for Rangy.
 * Serializes Ranges and Selections. An example use would be to store a user's selection on a particular page in a
 * cookie or local storage and restore it on the user's next visit to the same page.
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.755
 * Build date: 29 January 2013
 */
rangy.createModule("Serializer",function(e,t){function n(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function o(e,t){t=t||[];var r=e.nodeType,i=e.childNodes,a=i.length,s=[r,e.nodeName,a].join(":"),c="",d="";switch(r){case 3:c=n(e.nodeValue);break;case 8:c="<!--"+n(e.nodeValue)+"-->";break;default:c="<"+s+">",d="</>"}c&&t.push(c);for(var l=0;a>l;++l)o(i[l],t);return d&&t.push(d),t}function r(e){var t=o(e).join("");return v(t).toString(16)}function i(e,t,n){var o=[],r=e;for(n=n||C.getDocument(e).documentElement;r&&r!=n;)o.push(C.getNodeIndex(r,!0)),r=r.parentNode;return o.join("/")+":"+t}function a(e,n,o){n?o=o||C.getDocument(n):(o=o||document,n=o.documentElement);for(var r,i=e.split(":"),a=n,s=i[0]?i[0].split("/"):[],c=s.length;c--;){if(r=parseInt(s[c],10),!(r<a.childNodes.length))throw t.createError("deserializePosition() failed: node "+C.inspectNode(a)+" has no child with index "+r+", "+c);a=a.childNodes[r]}return new C.DomPosition(a,parseInt(i[1],10))}function s(n,o,a){if(a=a||e.DomRange.getRangeDocument(n).documentElement,!C.isOrIsAncestorOf(a,n.commonAncestorContainer))throw t.createError("serializeRange(): range "+n.inspect()+" is not wholly contained within specified root node "+C.inspectNode(a));var s=i(n.startContainer,n.startOffset,a)+","+i(n.endContainer,n.endOffset,a);return o||(s+="{"+r(a)+"}"),s}function c(n,o,i){o?i=i||C.getDocument(o):(i=i||document,o=i.documentElement);var s=/^([^,]+),([^,\{]+)(\{([^}]+)\})?$/.exec(n),c=s[4],d=r(o);if(c&&c!==r(o))throw t.createError("deserializeRange(): checksums of serialized range root node ("+c+") and target root node ("+d+") do not match");var l=a(s[1],o,i),u=a(s[2],o,i),f=e.createRange(i);return f.setStartAndEnd(l.node,l.offset,u.node,u.offset),f}function d(e,t,n){t?n=n||C.getDocument(t):(n=n||document,t=n.documentElement);var o=/^([^,]+),([^,]+)(\{([^}]+)\})?$/.exec(e),i=o[3];return!i||i===r(t)}function l(t,n,o){t=e.getSelection(t);for(var r=t.getAllRanges(),i=[],a=0,c=r.length;c>a;++a)i[a]=s(r[a],n,o);return i.join("|")}function u(t,n,o){n?o=o||C.getWindow(n):(o=o||window,n=o.document.documentElement);for(var r=t.split("|"),i=e.getSelection(o),a=[],s=0,d=r.length;d>s;++s)a[s]=c(r[s],n,o.document);return i.setRanges(a),i}function f(e,t,n){var o;t?o=n?n.document:C.getDocument(t):(n=n||window,t=n.document.documentElement);for(var r=e.split("|"),i=0,a=r.length;a>i;++i)if(!d(r[i],t,o))return!1;return!0}function h(e){for(var t,n,o=e.split(/[;,]/),r=0,i=o.length;i>r;++r)if(t=o[r].split("="),t[0].replace(/^\s+/,"")==R&&(n=t[1]))return decodeURIComponent(n.replace(/\s+$/,""));return null}function g(e){e=e||window;var t=h(e.document.cookie);t&&u(t,e.doc)}function p(t,n){t=t||window,n="object"==typeof n?n:{};var o=n.expires?";expires="+n.expires.toUTCString():"",r=n.path?";path="+n.path:"",i=n.domain?";domain="+n.domain:"",a=n.secure?";secure":"",s=l(e.getSelection(t));t.document.cookie=encodeURIComponent(R)+"="+encodeURIComponent(s)+o+r+i+a}e.requireModules(["WrappedSelection","WrappedRange"]);var m="undefined";(typeof encodeURIComponent==m||typeof decodeURIComponent==m)&&t.fail("Global object is missing encodeURIComponent and/or decodeURIComponent method");var v=function(){function e(e){for(var t,n=[],o=0,r=e.length;r>o;++o)t=e.charCodeAt(o),128>t?n.push(t):2048>t?n.push(192|t>>6,128|63&t):n.push(224|t>>12,128|63&t>>6,128|63&t);return n}function t(){for(var e,t,n=[],o=0;256>o;++o){for(t=o,e=8;e--;)1==(1&t)?t=3988292384^t>>>1:t>>>=1;n[o]=t>>>0}return n}function n(){return o||(o=t()),o}var o=null;return function(t){for(var o,r=e(t),i=-1,a=n(),s=0,c=r.length;c>s;++s)o=255&(i^r[s]),i=i>>>8^a[o];return(-1^i)>>>0}}(),C=e.dom,R="rangySerializedSelection";e.serializePosition=i,e.deserializePosition=a,e.serializeRange=s,e.deserializeRange=c,e.canDeserializeRange=d,e.serializeSelection=l,e.deserializeSelection=u,e.canDeserializeSelection=f,e.restoreSelectionFromCookie=g,e.saveSelectionCookie=p,e.getElementChecksum=r,e.nodeToInfoString=o}),/**
 * CSS Class Applier module for Rangy.
 * Adds, removes and toggles CSS classes on Ranges and Selections
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.755
 * Build date: 29 January 2013
 */
rangy.createModule("CssClassApplier",function(e,t){function n(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function o(e,t){return e.className&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function r(e,t){e.className?o(e,t)||(e.className+=" "+t):e.className=t}function i(e){return e.split(/\s+/).sort().join(" ")}function a(e){return i(e.className)}function s(e,t){return a(e)==a(t)}function c(e,t,n,o,r){var i=e.node,a=e.offset,s=i,c=a;i==o&&a>r&&c++,i!=t||a!=n&&a!=n+1||(s=o,c+=r-n),i==t&&a>n+1&&c--,e.node=s,e.offset=c}function d(e,t,n,o){-1==n&&(n=t.childNodes.length);for(var r,i=e.parentNode,a=x.getNodeIndex(e),s=0;r=o[s++];)c(r,i,a,t,n);t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function l(e,t,n,o,r){for(var i,a=[];i=e.firstChild;)d(i,t,n++,r),a.push(i);return o&&e.parentNode.removeChild(e),a}function u(e,t){return l(e,e.parentNode,x.getNodeIndex(e),!0,t)}function f(e,t){var n=e.cloneRange();n.selectNodeContents(t);var o=n.intersection(e),r=o?o.toString():"";return n.detach(),""!=r}function h(e){for(var t,n=e.getNodes([3]),o=0;(t=n[o])&&!f(e,t);)++o;for(var r=n.length-1;(t=n[r])&&!f(e,t);)--r;return n.slice(o,r+1)}function g(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,o,r,i=0,a=e.attributes.length;a>i;++i)if(n=e.attributes[i],r=n.name,"class"!=r){if(o=t.attributes.getNamedItem(r),n.specified!=o.specified)return!1;if(n.specified&&n.nodeValue!==o.nodeValue)return!1}return!0}function p(e,t){for(var n,o=0,r=e.attributes.length;r>o;++o)if(n=e.attributes[o].name,(!t||!x.arrayContains(t,n))&&e.attributes[o].specified&&"class"!=n)return!0;return!1}function m(e,t){var n;for(var o in t)if(t.hasOwnProperty(o))if(n=t[o],"object"==typeof n){if(!m(e[o],n))return!1}else if(e[o]!==n)return!1;return!0}function v(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||b(e)&&!b(e.parentNode))}function C(e){return(b(e)||1!=e.nodeType&&b(e.parentNode))&&!v(e)}function R(e){return e&&1==e.nodeType&&!B.test(H(e,"display"))}function N(e){if(0==e.data.length)return!0;if(W.test(e.data))return!1;var t=H(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return R(e.previousSibling)||R(e.nextSibling)}function y(e){var t,n,o=[];for(t=0;n=e[t++];)o.push(new I(n.startContainer,n.startOffset),new I(n.endContainer,n.endOffset));return o}function E(e,t){for(var n,o,r,i=0,a=e.length;a>i;++i)n=e[i],o=t[2*i],r=t[2*i+1],n.setStartAndEnd(o.node,o.offset,r.node,r.offset)}function S(e,t){return x.isCharacterDataNode(e)?0==t?!!e.previousSibling:t==e.length?!!e.nextSibling:!0:t>0&&t<e.childNodes.length}function w(e,n,o,r){var i,a,s=0==o;if(x.isAncestorOf(n,e))return e;if(x.isCharacterDataNode(n)){var c=x.getNodeIndex(n);if(0==o)o=c;else{if(o!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+o+" in "+n.data);o=c+1}n=n.parentNode}if(S(n,o)){i=n.cloneNode(!1),a=n.parentNode,i.id&&i.removeAttribute("id");for(var l,u=0;l=n.childNodes[o];)d(l,i,u++,r);return d(i,a,x.getNodeIndex(n)+1,r),n==e?i:w(e,a,x.getNodeIndex(i),r)}if(e!=n){i=n.parentNode;var f=x.getNodeIndex(n);return s||f++,w(e,i,f,r)}return e}function T(e,t){return e.tagName==t.tagName&&s(e,t)&&g(e,t)&&"inline"==H(e,"display")&&"inline"==H(t,"display")}function O(e){var t=e?"nextSibling":"previousSibling";return function(n,o){var r=n.parentNode,i=n[t];if(i){if(i&&3==i.nodeType)return i}else if(o&&(i=r[t],i&&1==i.nodeType&&T(r,i)))return i[e?"firstChild":"lastChild"];return null}}function D(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function A(e,t,o){this.cssClass=e;var r,i,a,s,c=null;if("object"==typeof t&&null!==t){for(o=t.tagNames,c=t.elementProperties,i=0;s=j[i++];)t.hasOwnProperty(s)&&(this[s]=t[s]);r=t.normalize}else r=t;this.normalize="undefined"==typeof r?!0:r,this.attrExceptions=[];var d=document.createElement(this.elementTagName);this.elementProperties=this.copyPropertiesToElement(c,d,!0),this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?this.elementProperties.className:e,this.applyToAnyTagName=!1;var l=typeof o;if("string"==l)"*"==o?this.applyToAnyTagName=!0:this.tagNames=n(o.toLowerCase()).split(/\s*,\s*/);else if("object"==l&&"number"==typeof o.length)for(this.tagNames=[],i=0,a=o.length;a>i;++i)"*"==o[i]?this.applyToAnyTagName=!0:this.tagNames.push(o[i].toLowerCase());else this.tagNames=[this.elementTagName]}function _(e,t,n){return new A(e,t,n)}e.requireModules(["WrappedSelection","WrappedRange"]);var b,x=e.dom,I=x.DomPosition,P="span",M=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){t.className&&(t.className=t.className.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e))}}(),H=x.getComputedStyleProperty;!function(){var e=document.createElement("div");b="boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return e&&1==e.nodeType&&"false"!=e.contentEditable?"true"==e.contentEditable||b(e.parentNode):!1}}();var B=/^inline(-block|-table)?$/i,W=/[^\r\n\t\f \u200B]/,L=O(!1),k=O(!0);D.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){for(var o,r,i,a,s=[],c=0,d=0,l=t.length;l>d;++d){if(o=t[d],r=o.parentNode,d>0&&(r.removeChild(o),r.hasChildNodes()||r.parentNode.removeChild(r),e))for(i=0;a=e[i++];)a.node==o&&(a.node=n,a.offset+=c);s[d]=o.data,c+=o.data.length}n.data=s.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;n>t;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var j=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements"],F={};A.prototype={elementTagName:P,elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,copyPropertiesToElement:function(e,t,n){var o,a,s,c,d,l,u={};for(var f in e)if(e.hasOwnProperty(f))if(c=e[f],d=t[f],"className"==f)r(t,c),r(t,this.cssClass),t[f]=i(t[f]),n&&(u[f]=t[f]);else if("style"==f){a=d,n&&(u[f]=s={});for(o in e[f])a[o]=c[o],n&&(s[o]=a[o]);this.attrExceptions.push(f)}else t[f]=c,n&&(u[f]=t[f],l=F.hasOwnProperty(f)?F[f]:f,this.attrExceptions.push(l));return n?u:""},hasClass:function(e){return 1==e.nodeType&&x.arrayContains(this.tagNames,e.tagName.toLowerCase())&&o(e,this.cssClass)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||C(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&N(e)},postApply:function(e,t,n,o){for(var r,i,a,s=e[0],c=e[e.length-1],d=[],l=s,u=c,f=0,h=c.length,g=0,p=e.length;p>g;++g)i=e[g],a=L(i,!o),a?(r||(r=new D(a),d.push(r)),r.textNodes.push(i),i===s&&(l=r.textNodes[0],f=l.length),i===c&&(u=r.textNodes[0],h=r.getLength())):r=null;var m=k(c,!o);if(m&&(r||(r=new D(c),d.push(r)),r.textNodes.push(m)),d.length){for(g=0,p=d.length;p>g;++g)d[g].doMerge(n);t.setStartAndEnd(l,f,u,h)}},createContainer:function(e){var t=e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,t,!1),r(t,this.cssClass),t},applyToTextNode:function(e){var t=e.parentNode;if(1==t.childNodes.length&&this.useExistingElements&&x.arrayContains(this.tagNames,t.tagName.toLowerCase())&&m(t,this.elementProperties))r(t,this.cssClass);else{var n=this.createContainer(x.getDocument(e));e.parentNode.insertBefore(n,e),n.appendChild(e)}},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&a(e)==this.elementSortedClassName&&m(e,this.elementProperties)&&!p(e,this.attrExceptions)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){for(var t,n=this,o=e.getNodes([1],function(e){return n.isEmptyContainer(e)}),r=0;t=o[r++];)t.parentNode.removeChild(t)},undoToTextNode:function(e,t,n,o){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(w(n,t.endContainer,t.endOffset,o),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=w(n,t.startContainer,t.startOffset,o))}this.isRemovable(n)?u(n,o):M(n,this.cssClass)},applyToRange:function(e,t){t=t||[];var n=y(t||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e);var o=h(e);if(o.length){for(var r,i=0;r=o[i++];)this.isIgnorableWhiteSpaceNode(r)||this.getSelfOrAncestorWithClass(r)||!this.isModifiable(r)||this.applyToTextNode(r,n);r=o[o.length-1],e.setStartAndEnd(o[0],0,r,r.length),this.normalize&&this.postApply(o,e,n,!1),E(t,n)}},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){t=t||[];var n=y(t);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e,n);var o,r,i=h(e),a=i[i.length-1];if(i.length){for(var s=0,c=i.length;c>s;++s)o=i[s],r=this.getSelfOrAncestorWithClass(o),r&&this.isModifiable(o)&&this.undoToTextNode(o,e,r,n),e.setStartAndEnd(i[0],0,a,a.length);this.normalize&&this.postApply(i,e,n,!0),E(t,n)}},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),o=e.getSelection(t).getAllRanges();this.undoToRanges(o),n.setRanges(o)},getTextSelectedByRange:function(e,t){var n=t.cloneRange();n.selectNodeContents(e);var o=n.intersection(t),r=o?o.toString():"";return n.detach(),r},isAppliedToRange:function(e){if(e.collapsed)return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);for(var t,n=e.getNodes([3]),o=0;t=n[o++];)if(!this.isIgnorableWhiteSpaceNode(t)&&f(e,t)&&this.isModifiable(t)&&!this.getSelfOrAncestorWithClass(t))return!1;return!0},isAppliedToRanges:function(e){for(var t=e.length;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleRanges:function(e){this.isAppliedToRanges(e)?this.undoToRanges(e):this.applyToRanges(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},detach:function(){}},A.util={hasClass:o,addClass:r,removeClass:M,hasSameClasses:s,replaceWithOwnChildren:u,elementsHaveSameNonClassAttributes:g,elementHasNonClassAttributes:p,splitNodeAt:w,isEditableElement:b,isEditingHost:v,isEditable:C},e.CssClassApplier=A,e.createCssClassApplier=_});